<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Bet</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"> 
    <style>
        :root{--bg:#0b0e11;--card:#151a21;--acc:#00b359;--red:#ff4d4d;--text:#fff;--sub:#8b95a5;--border:#2a303c;--gold:#ffc107;--blue:#2d8cf0}
        body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,sans-serif;padding-bottom:100px;user-select:none;-webkit-tap-highlight-color:transparent}
        
        header{padding:15px;background:rgba(11,14,17,0.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
        .bal{font-weight:700;font-size:16px;background:#21262d;padding:6px 14px;border-radius:20px;border:1px solid var(--border)}
        
        main{padding:15px}
        .page{display:none;animation:fade .3s}@keyframes fade{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}.page.active{display:block}
        
        .nav{position:fixed;bottom:0;width:100%;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:12px 0 25px;z-index:99}
        .nav-item{color:var(--sub);font-size:10px;text-align:center;transition:.2s}.nav-item i{font-size:22px;margin-bottom:4px;display:block}
        .nav-item.active{color:var(--text)}.nav-item.active i{color:var(--acc);transform:translateY(-3px)}
        
        /* CARDS */
        .g-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.g-card{height:120px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:15px;position:relative;overflow:hidden}.g-card.wide{grid-column:span 2;background:linear-gradient(135deg,#1f2530,#151a21)}
        
        /* SPORT */
        .tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:10px;scrollbar-width:none}.tab{background:var(--card);border:1px solid var(--border);padding:8px 16px;border-radius:20px;font-size:13px;white-space:nowrap;color:var(--sub)}.tab.active{background:var(--text);color:var(--bg);font-weight:700}
        
        .match{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:15px;margin-bottom:10px}
        .live-badge{color:var(--red);font-weight:800;font-size:11px;display:flex;align-items:center;gap:5px}.dot{width:6px;height:6px;border-radius:50%;background:var(--red);animation:blink 1.5s infinite}@keyframes blink{50%{opacity:.4}}
        .teams{display:flex;justify-content:space-between;align-items:center;margin:15px 0;font-weight:700}
        .score{background:rgba(255,255,255,.05);padding:5px 12px;border-radius:8px;font-size:18px}
        .coefs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
        .cf{background:rgba(255,255,255,.03);border:1px solid var(--border);padding:10px;border-radius:10px;text-align:center;font-size:13px}
        .cf b{display:block;color:var(--acc);margin-top:2px} .cf:active{background:rgba(255,255,255,.1)}
        
        /* HISTORY BETS */
        .h-tab-bar{display:flex;border-bottom:1px solid var(--border);margin-bottom:15px}.ht{flex:1;text-align:center;padding:12px;color:var(--sub);font-size:14px;border-bottom:2px solid transparent}.ht.active{color:var(--text);border-color:var(--acc)}
        
        .bet-row{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;position:relative;overflow:hidden}
        .bet-row.win{border-left:4px solid var(--acc)}.bet-row.lose{border-left:4px solid var(--red)}.bet-row.wait{border-left:4px solid var(--gold)}
        .bet-head{display:flex;justify-content:space-between;font-size:13px;font-weight:700;margin-bottom:5px}
        .bet-det{font-size:11px;color:var(--sub);margin-bottom:8px}
        .bet-res{display:flex;justify-content:space-between;font-size:12px}
        .win-val{color:var(--acc);font-weight:800}.lose-val{color:var(--red);font-weight:800}
        
        /* COMMON */
        .btn{width:100%;padding:16px;border:none;border-radius:12px;background:var(--acc);color:#fff;font-weight:800;font-size:16px;margin-top:15px;box-shadow:0 4px 15px rgba(0,179,89,.2)}
        input{width:100%;background:#090b0e;border:1px solid var(--border);padding:14px;border-radius:10px;color:#fff;font-size:16px;outline:none}
        
        .dice-area{height:200px;display:flex;align-items:center;justify-content:center;perspective:1000px}.cube{width:80px;height:80px;position:relative;transform-style:preserve-3d;transition:1.5s}.face{position:absolute;width:80px;height:80px;border:2px solid var(--blue);background:#111;display:flex;align-items:center;justify-content:center;font-size:30px;color:#fff;border-radius:12px}.f1{transform:translateZ(40px)}.f6{transform:rotateY(180deg) translateZ(40px)}.f2{transform:rotateY(90deg) translateZ(40px)}.f5{transform:rotateY(-90deg) translateZ(40px)}.f3{transform:rotateX(90deg) translateZ(40px)}.f4{transform:rotateX(-90deg) translateZ(40px)}
        .mines-g{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}.mc{aspect-ratio:1;background:var(--card);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}.mc.gem{background:rgba(0,179,89,.2);border-color:var(--acc)}.mc.boom{background:rgba(255,77,77,.2);border-color:var(--red)}
    </style>
</head>
<body>

    <header>
        <div style="font-weight:900;font-size:19px;letter-spacing:-1px">ROYAL<span style="color:var(--acc)">BET</span></div>
        <div class="bal"><span style="color:var(--acc)">‚ÇΩ</span> <span id="ui-bal">...</span></div>
    </header>

    <main>
        <!-- SPORT -->
        <section id="p-sport" class="page active">
            <h2 style="margin-top:0">–°–ø–æ—Ä—Ç</h2>
            <div class="tabs">
                <div class="tab active" onclick="filter('football',this)">‚öΩ –§—É—Ç–±–æ–ª</div>
                <div class="tab" onclick="filter('hockey',this)">üèí –•–æ–∫–∫–µ–π</div>
                <div class="tab" onclick="filter('basketball',this)">üèÄ –ë–∞—Å–∫–µ—Ç</div>
            </div>
            <div id="feed" style="margin-top:15px"></div>
        </section>

        <!-- MY BETS -->
        <section id="p-bets" class="page">
            <div class="h-tab-bar">
                <div class="ht active" onclick="renderBets('active',this)">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                <div class="ht" onclick="renderBets('history',this)">–ò—Å—Ç–æ—Ä–∏—è</div>
            </div>
            <div id="bets-list"></div>
        </section>

        <!-- GAMES -->
        <section id="p-mines" class="page">
            <h2>Mines</h2>
            <div style="background:var(--card);padding:15px;border-radius:16px;border:1px solid var(--border)">
                <input type="number" id="m-bet" value="100" placeholder="–°—É–º–º–∞">
                <div style="margin:10px 0;display:flex;justify-content:space-between;font-size:13px;color:var(--sub)"><span>–ú–∏–Ω—ã: 3</span><span id="m-kef" style="color:var(--acc)">x1.00</span></div>
                <button id="m-btn" class="btn" onclick="Mines.start()">–ò–ì–†–ê–¢–¨</button>
                <button id="m-cash" class="btn" style="display:none;background:var(--gold);color:#000" onclick="Mines.cash()">–ó–ê–ë–†–ê–¢–¨</button>
            </div>
            <div class="mines-g" id="m-grid" style="margin-top:20px"></div>
        </section>

        <section id="p-dice" class="page">
            <h2>Dice 3D</h2>
            <div class="dice-area"><div class="cube" id="cube"><div class="face f1">1</div><div class="face f2">6</div><div class="face f3">2</div><div class="face f4">5</div><div class="face f5">3</div><div class="face f6">4</div></div></div>
            <div style="background:var(--card);padding:15px;border-radius:16px;border:1px solid var(--border)">
                <input type="number" id="d-bet" value="100">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
                    <button class="cf" onclick="Dice.type='odd'">–ù–ï–ß–ï–¢ <b>x1.9</b></button>
                    <button class="cf" onclick="Dice.type='even'">–ß–ï–¢ <b>x1.9</b></button>
                </div>
                <button class="btn" style="background:var(--blue)" onclick="Dice.roll()">–ë–†–û–°–û–ö</button>
            </div>
        </section>

        <!-- PROFILE -->
        <section id="p-profile" class="page">
            <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div style="text-align:center;padding:20px;background:var(--card);border-radius:16px;border:1px solid var(--border)">
                <div style="font-size:40px">üòé</div>
                <h3>ID: <span id="uid">...</span></h3>
                <div style="font-size:12px;color:var(--sub)">–ê–¥–º–∏–Ω–∫–∞: –î–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç –∫–æ–º–∞–Ω–¥—ã</div>
            </div>
        </section>
    </main>

    <nav>
        <div class="nav-item active" onclick="nav('sport',this)"><i class="fas fa-trophy"></i>–°–ø–æ—Ä—Ç</div>
        <div class="nav-item" onclick="nav('bets',this)"><i class="fas fa-ticket-alt"></i>–°—Ç–∞–≤–∫–∏</div>
        <div class="nav-item" onclick="nav('mines',this)"><i class="fas fa-bomb"></i>Mines</div>
        <div class="nav-item" onclick="nav('dice',this)"><i class="fas fa-dice"></i>Dice</div>
        <div class="nav-item" onclick="nav('profile',this)"><i class="fas fa-user"></i>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        // –¢–í–û–ô URL
        const API_URL = "https://backend-4jag.onrender.com"; 

        let state = { matches: [], history: [], active: [], bal: 0 };
        let curCat = 'football';

        const App = {
            uid: tg.initDataUnsafe?.user?.id || 12345,
            username: tg.initDataUnsafe?.user?.username || "Guest",
            
            init: async function() {
                tg.expand();
                document.getElementById('uid').innerText = this.uid;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                await this.refreshUser();
                await this.pollMatches();
                await this.loadBets();

                // –ü–æ–ª–ª–∏–Ω–≥
                setInterval(() => this.pollMatches(), 10000);
                setInterval(() => this.refreshUser(), 10000);
            },

            refreshUser: async function() {
                try {
                    let res = await fetch(`${API_URL}/api/init?tg_id=${this.uid}&username=${this.username}`);
                    let data = await res.json();
                    state.bal = data.balance;
                    document.getElementById('ui-bal').innerText = Math.floor(state.bal).toLocaleString();
                } catch(e) { console.error(e); }
            },

            pollMatches: async function() {
                try {
                    let res = await fetch(`${API_URL}/api/matches`);
                    let data = await res.json();
                    // –û–±—ä–µ–¥–∏–Ω—è–µ–º Live –∏ Upcoming –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞
                    state.matches = [...data.live, ...data.upcoming];
                    if(document.getElementById('p-sport').classList.contains('active')) renderMatches();
                } catch(e) {}
            },

            loadBets: async function() {
                try {
                    let res = await fetch(`${API_URL}/api/history`, {headers: {'X-Telegram-ID': this.uid.toString()}});
                    let data = await res.json();
                    state.active = data.active;
                    state.history = data.history;
                    if(document.getElementById('p-bets').classList.contains('active')) renderBets();
                } catch(e) {}
            },

            placeBet: async function(matchId, selection, amount, k) {
                // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
                state.bal -= amount;
                document.getElementById('ui-bal').innerText = Math.floor(state.bal);

                let res = await fetch(`${API_URL}/api/bet`, {
                    method:'POST', 
                    headers:{'Content-Type':'application/json', 'X-Telegram-ID': this.uid.toString()},
                    body:JSON.stringify({match_id: matchId, selection: selection, amount: parseFloat(amount), coefficient: k})
                });
                let d = await res.json();
                if(d.status==='ok') {
                    state.bal = d.new_balance;
                    this.loadBets();
                    tg.showAlert("–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!");
                } else {
                    tg.showAlert("–û—à–∏–±–∫–∞: " + d.detail);
                }
            },

            playGame: async function(gameName, amount) {
                let res = await fetch(`${API_URL}/api/game`, {
                    method:'POST', 
                    headers:{'Content-Type':'application/json', 'X-Telegram-ID': this.uid.toString()},
                    body:JSON.stringify({game: gameName, amount: amount})
                });
                let d = await res.json();
                state.bal = d.new_balance;
                document.getElementById('ui-bal').innerText = Math.floor(state.bal).toLocaleString();
            }
        };

        // --- RENDER FUNCTIONS ---
        function nav(p, el) {
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            if(p==='bets') App.loadBets();
        }

        function filter(cat, el) {
            curCat = cat;
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            renderMatches();
        }

        function renderMatches() {
            let list = state.matches.filter(m => m.sport === curCat);
            
            document.getElementById('feed').innerHTML = list.map(m => {
                let isLive = m.status === 'live';
                let time = isLive ? 
                    `<span class="live-badge"><div class="dot"></div> ${m.current_minute}'</span>` : 
                    `<span style="color:var(--sub);font-size:12px">${new Date(m.start_time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`;
                
                let score = isLive ? `${m.score_home}:${m.score_away}` : "VS";

                return `
                <div class="match">
                    <div style="display:flex;justify-content:space-between;margin-bottom:10px">${time} <span style="font-size:10px;color:var(--sub)">${m.sport.toUpperCase()}</span></div>
                    <div class="teams">
                        <div style="width:40%">${m.team_home}</div>
                        <div class="score">${score}</div>
                        <div style="width:40%;text-align:right">${m.team_away}</div>
                    </div>
                    <div class="coefs">
                        <div class="cf" onclick="doBet(${m.id},'home',${m.odds_home})">–ü1 <b>${m.odds_home}</b></div>
                        <div class="cf" onclick="doBet(${m.id},'draw',${m.odds_draw})">X <b>${m.odds_draw}</b></div>
                        <div class="cf" onclick="doBet(${m.id},'away',${m.odds_away})">–ü2 <b>${m.odds_away}</b></div>
                    </div>
                </div>`;
            }).join('');
        }

        let curBetTab = 'active';
        function renderBets(tab, el) {
            if(tab) { curBetTab = tab; document.querySelectorAll('.ht').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }
            
            const cont = document.getElementById('bets-list');
            cont.innerHTML = '';
            
            let source = curBetTab === 'active' ? state.active : state.history;

            if(source.length === 0) {
                cont.innerHTML = '<div style="text-align:center;color:#555;margin-top:20px">–ü—É—Å—Ç–æ</div>';
                return;
            }

            source.forEach(b => {
                let isWin = b.status === 'won';
                let isLose = b.status === 'lost';
                let statusClass = isWin ? 'win' : (isLose ? 'lose' : 'wait');
                let statusText = isWin ? '–ü–û–ë–ï–î–ê' : (isLose ? '–ü–†–û–ò–ì–†–´–®' : '–í –ò–ì–†–ï');
                let color = isWin ? 'var(--acc)' : (isLose ? 'var(--red)' : 'var(--gold)');
                
                let diff = isWin ? `+${b.potential_win}` : (isLose ? `-${b.amount}` : `~${b.potential_win}`);

                cont.innerHTML += `
                <div class="bet-row ${statusClass}">
                    <div class="bet-head"><span>${b.team_home} vs ${b.team_away}</span> <span style="color:${color}">${statusText}</span></div>
                    <div class="bet-det">–í—ã–±–æ—Ä: ${b.bet_selection.toUpperCase()} ‚Ä¢ –ö—ç—Ñ: x${b.coefficient}</div>
                    <div class="bet-res">
                        <span>–°—Ç–∞–≤–∫–∞: ${b.amount}‚ÇΩ</span>
                        <span style="font-weight:800;color:${color}">${diff} ‚ÇΩ</span>
                    </div>
                </div>`;
            });
        }

        function doBet(mid, ch, k) {
            let sum = prompt("–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏:", 100);
            if(sum && !isNaN(sum)) App.placeBet(mid, ch, sum, k);
        }

        // --- GAMES LOGIC ---
        const Mines = {
            act: false, grid: [], bet: 0, mult: 1,
            init: function(){ 
                let g=document.getElementById('m-grid'); g.innerHTML='';
                for(let i=0;i<25;i++){ let d=document.createElement('div');d.className='mc';d.onclick=()=>this.hit(i,d);g.appendChild(d); }
            },
            start: function() {
                let b = +document.getElementById('m-bet').value;
                if(b > state.bal) return alert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥");
                this.bet = b; this.act = true; this.mult=1;
                this.grid = Array(25).fill(0);
                // 3 bombs simple logic client-side (demo)
                let c=0; while(c<3){let r=Math.floor(Math.random()*25); if(!this.grid[r]){this.grid[r]=1;c++}}
                
                // Server logic: deduct bet
                App.playGame('Mines Start', -b);
                
                document.getElementById('m-btn').style.display='none'; document.getElementById('m-cash').style.display='block';
                document.querySelectorAll('.mc').forEach(e=>{e.className='mc';e.innerText=''});
            },
            hit: function(i, el) {
                if(!this.act || el.classList.contains('gem')) return;
                if(this.grid[i]) {
                    el.classList.add('boom'); el.innerText='üí£'; this.act=false;
                    tg.showAlert("–í–∑—Ä—ã–≤!");
                    this.end(0);
                } else {
                    el.classList.add('gem'); el.innerText='üíé';
                    this.mult *= 1.2;
                    document.getElementById('m-kef').innerText = "x"+this.mult.toFixed(2);
                }
            },
            cash: function() { 
                this.act=false; 
                let win = Math.floor(this.bet * this.mult);
                // Server logic: add win (bet was already deducted)
                // We need to add (bet + profit) = win
                App.playGame('Mines Win', win); 
                this.end(win); 
            },
            end: function(win) {
                document.getElementById('m-btn').style.display='block'; document.getElementById('m-cash').style.display='none';
            }
        };

        const Dice = {
            type: null,
            roll: function() {
                let b = +document.getElementById('d-bet').value;
                if(!this.type || b > state.bal) return alert("–û—à–∏–±–∫–∞ –∏–ª–∏ –±–∞–ª–∞–Ω—Å");
                let r = Math.floor(Math.random()*6)+1;
                
                let c = document.getElementById('cube');
                c.style.transform = `rotateX(${r*90}deg) rotateY(${r*90}deg)`;
                
                setTimeout(()=>{
                    let w = (this.type==='odd' && r%2!==0) || (this.type==='even' && r%2===0);
                    let change = w ? Math.floor(b*0.9) : -b; // Win = bet * 1.9 - bet = bet * 0.9
                    
                    App.playGame('Dice', change);
                    if(w) tg.showAlert("–ü–æ–±–µ–¥–∞!");
                }, 1000);
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
