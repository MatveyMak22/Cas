<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casino & Sports</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0f111a;
            --card-bg: #1c1f2e;
            --primary: #00ff88;
            --primary-dim: rgba(0, 255, 136, 0.2);
            --danger: #ff4757;
            --text: #ffffff;
            --text-sec: #8b9bb4;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding-bottom: 80px;
            user-select: none;
        }

        /* --- UI COMPONENTS --- */
        .container { padding: 16px; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .balance-box {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary-dim);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        /* --- TABS --- */
        .tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid rgba(255,255,255,0.05);
            z-index: 100;
        }
        .tab-item {
            color: var(--text-sec);
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .tab-item.active { color: var(--primary); }
        .page { display: none; }
        .page.active { display: block; }

        /* --- SPORT --- */
        .live-badge {
            background: var(--danger);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.6;} 100% {opacity: 1;} }

        .match-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-sec);
        }
        .match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .odds-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .odd-btn {
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
        }
        .odd-btn span { display: block; color: var(--primary); font-weight: 700; }

        /* --- MINES --- */
        .mines-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        .mine-cell {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: 0.2s;
        }
        .mine-cell.revealed.gem { background: var(--primary); }
        .mine-cell.revealed.bomb { background: var(--danger); }

        /* --- DICE --- */
        .dice-container {
            perspective: 1000px;
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 40px 0;
        }
        .cube {
            width: 80px;
            height: 80px;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(-20deg) rotateY(-20deg);
            transition: transform 1s ease-out;
        }
        .face {
            position: absolute;
            width: 80px;
            height: 80px;
            background: var(--primary);
            border: 2px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #000;
            font-weight: bold;
        }
        .front  { transform: translateZ(40px); }
        .back   { transform: rotateY(180deg) translateZ(40px); }
        .right  { transform: rotateY(90deg) translateZ(40px); }
        .left   { transform: rotateY(-90deg) translateZ(40px); }
        .top    { transform: rotateX(90deg) translateZ(40px); }
        .bottom { transform: rotateX(-90deg) translateZ(40px); }

        /* --- INPUTS --- */
        .bet-input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .bet-history-item {
            font-size: 12px;
            border-left: 3px solid #555;
        }
        .bet-history-item.won { border-color: var(--primary); }
        .bet-history-item.lost { border-color: var(--danger); }
        .status-win { color: var(--primary); }
        .status-loss { color: var(--danger); }
    </style>
</head>
<body>

    <div class="header">
        <div>Casino & Sports</div>
        <div class="balance-box" id="userBalance">0.00 ‚ÇΩ</div>
    </div>

    <!-- SPORT TAB -->
    <div id="sport" class="page active container">
        <h3>üî• LIVE</h3>
        <div id="liveMatches"></div>
        
        <h3>üìÖ –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</h3>
        <div id="upcomingMatches"></div>
    </div>

    <!-- GAMES TAB -->
    <div id="games" class="page container">
        <h3>üé∞ –ú–∏–Ω–∏-–∏–≥—Ä—ã</h3>
        
        <!-- DICE -->
        <div class="card">
            <h4>Dice 3D</h4>
            <div class="dice-container">
                <div class="cube" id="diceCube">
                    <div class="face front">1</div>
                    <div class="face back">6</div>
                    <div class="face right">3</div>
                    <div class="face left">4</div>
                    <div class="face top">2</div>
                    <div class="face bottom">5</div>
                </div>
            </div>
            <input type="number" id="diceBet" class="bet-input" placeholder="–°—Ç–∞–≤–∫–∞" value="10">
            <button class="btn" onclick="playDice()">–ë—Ä–æ—Å–∏—Ç—å (x2)</button>
        </div>

        <!-- MINES -->
        <div class="card">
            <h4>Mines</h4>
            <input type="number" id="minesBet" class="bet-input" placeholder="–°—Ç–∞–≤–∫–∞" value="10">
            <div id="minesGrid" class="mines-grid"></div>
            <button class="btn" id="startMinesBtn" onclick="startMines()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            <button class="btn" id="cashoutMinesBtn" onclick="cashoutMines()" style="display:none; background: #e6b333;">–ó–∞–±—Ä–∞—Ç—å</button>
        </div>
    </div>

    <!-- BETS TAB -->
    <div id="bets" class="page container">
        <h3>–ú–æ–∏ —Å—Ç–∞–≤–∫–∏</h3>
        <div id="activeBets"></div>
        <h4>–ò—Å—Ç–æ—Ä–∏—è</h4>
        <div id="historyBets"></div>
    </div>

    <!-- NAVIGATION -->
    <div class="tabs">
        <div class="tab-item active" onclick="switchTab('sport', this)">
            <span>‚öΩ</span><span>–°–ø–æ—Ä—Ç</span>
        </div>
        <div class="tab-item" onclick="switchTab('games', this)">
            <span>üéÆ</span><span>–ò–≥—Ä—ã</span>
        </div>
        <div class="tab-item" onclick="switchTab('bets', this)">
            <span>üìã</span><span>–°—Ç–∞–≤–∫–∏</span>
        </div>
    </div>

    <script>
        // CONFIG
        const API_URL = "https://backend-4jag.onrender.com"; // –ó–ê–ú–ï–ù–ò–¢–¨ –ü–ï–†–ï–î –î–ï–ü–õ–û–ï–ú!
        const tg = window.Telegram.WebApp;
        
        let currentUser = { id: 0, balance: 0 };
        
        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ –ø—Ä–æ–¥–µ –Ω—É–∂–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å initData)
        // –î–ª—è —Ç–µ—Å—Ç–∞ –±–µ—Ä–µ–º ID –∏–∑ user.id –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π
        const userId = tg.initDataUnsafe?.user?.id || 12345;
        const userName = tg.initDataUnsafe?.user?.username || "User";

        // Headers helper
        const getHeaders = () => ({
            "Content-Type": "application/json",
            "X-Telegram-ID": userId.toString()
        });

        async function init() {
            tg.expand();
            // Auth & Get Balance
            const res = await fetch(`${API_URL}/api/init?tg_id=${userId}&username=${userName}`);
            const data = await res.json();
            updateBalanceUI(data.balance);
            
            // Start Polling
            loadMatches();
            loadHistory();
            setInterval(loadMatches, 10000); // –†–∞–∑ –≤ 10 —Å–µ–∫ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç—á–∏
            setInterval(refreshBalance, 10000);
        }

        function updateBalanceUI(amount) {
            currentUser.balance = amount;
            document.getElementById('userBalance').innerText = parseFloat(amount).toFixed(2) + ' ‚ÇΩ';
        }

        async function refreshBalance() {
            const res = await fetch(`${API_URL}/api/init?tg_id=${userId}`);
            const data = await res.json();
            updateBalanceUI(data.balance);
        }

        // --- TABS LOGIC ---
        function switchTab(tabId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            el.classList.add('active');

            if(tabId === 'bets') loadHistory();
        }

        // --- SPORTS LOGIC ---
        async function loadMatches() {
            try {
                const res = await fetch(`${API_URL}/api/matches`);
                const data = await res.json();
                
                renderMatchesList(data.live, 'liveMatches', true);
                renderMatchesList(data.upcoming, 'upcomingMatches', false);
            } catch (e) { console.error(e); }
        }

        function renderMatchesList(matches, elementId, isLive) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            if (matches.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">–ù–µ—Ç –º–∞—Ç—á–µ–π</div>';
                return;
            }

            matches.forEach(m => {
                const div = document.createElement('div');
                div.className = 'card';
                const timeStr = isLive ? `<span style="color:var(--primary)">${m.current_minute}'</span>` : new Date(m.start_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const scoreStr = isLive ? `${m.score_home} : ${m.score_away}` : "vs";

                div.innerHTML = `
                    <div class="match-header">
                        <span>${isLive ? '<span class="live-badge">LIVE</span>' : ''} ${m.sport.toUpperCase()}</span>
                        <span>${timeStr}</span>
                    </div>
                    <div class="match-teams">
                        <span>${m.team_home}</span>
                        <span style="font-size:18px; color:var(--primary)">${scoreStr}</span>
                        <span>${m.team_away}</span>
                    </div>
                    <div class="odds-row">
                        <div class="odd-btn" onclick="placeBet(${m.id}, 'home', ${m.odds_home})">–ü1<br><span>${m.odds_home}</span></div>
                        <div class="odd-btn" onclick="placeBet(${m.id}, 'draw', ${m.odds_draw})">X<br><span>${m.odds_draw}</span></div>
                        <div class="odd-btn" onclick="placeBet(${m.id}, 'away', ${m.odds_away})">–ü2<br><span>${m.odds_away}</span></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function placeBet(matchId, selection, coef) {
            const amount = parseFloat(prompt(`–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É –Ω–∞ ${selection} (k=${coef})?\n–í–∞—à –±–∞–ª–∞–Ω—Å: ${currentUser.balance}\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É:`));
            if (!amount || isNaN(amount) || amount <= 0) return;

            try {
                const res = await fetch(`${API_URL}/api/bet`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ match_id: matchId, selection, amount, coefficient: coef })
                });
                const data = await res.json();
                
                if (res.ok) {
                    tg.showAlert("–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!");
                    updateBalanceUI(data.new_balance);
                } else {
                    tg.showAlert("–û—à–∏–±–∫–∞: " + data.detail);
                }
            } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
        }

        // --- HISTORY ---
        async function loadHistory() {
            const res = await fetch(`${API_URL}/api/history`, { headers: getHeaders() });
            const data = await res.json();
            
            const render = (list, id) => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                list.forEach(b => {
                    const statusClass = b.status === 'won' ? 'status-win' : (b.status === 'lost' ? 'status-loss' : '');
                    el.innerHTML += `
                        <div class="card bet-history-item ${b.status}">
                            <div style="display:flex; justify-content:space-between">
                                <span>${b.team_home} vs ${b.team_away}</span>
                                <span class="${statusClass}">${b.status.toUpperCase()}</span>
                            </div>
                            <div style="font-size:11px; color:#aaa; margin-top:4px">
                                –°—Ç–∞–≤–∫–∞: ${b.amount}‚ÇΩ –Ω–∞ ${b.bet_selection} (x${b.coefficient}) 
                                <br> –í—ã–∏–≥—Ä—ã—à: ${b.status === 'won' ? b.potential_win : 0}‚ÇΩ
                            </div>
                        </div>
                    `;
                });
            };
            
            render(data.active, 'activeBets');
            render(data.history, 'historyBets');
        }

        // --- DICE GAME ---
        async function playDice() {
            const amount = parseFloat(document.getElementById('diceBet').value);
            if(amount > currentUser.balance) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

            const cube = document.getElementById('diceCube');
            // Random rotate
            const xRand = Math.floor(Math.random() * 4 + 5) * 90;
            const yRand = Math.floor(Math.random() * 4 + 5) * 90;
            
            cube.style.transform = `rotateX(${xRand}deg) rotateY(${yRand}deg)`;

            // Logic Simulation (Client side visual, server side validation in real app would be complex, here simplified)
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω—å (—É–ø—Ä–æ—â–µ–Ω–Ω–æ: —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ 50/50 –≤—ã–∏–≥—Ä—ã—à –¥–ª—è –¥–µ–º–æ)
            const win = Math.random() > 0.6; // 40% win rate
            const change = win ? amount : -amount;

            setTimeout(async () => {
                const res = await fetch(`${API_URL}/api/game`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ game: 'dice', amount: change })
                });
                const data = await res.json();
                updateBalanceUI(data.new_balance);
                tg.showAlert(win ? `–ü–æ–±–µ–¥–∞! +${amount}` : "–ü—Ä–æ–∏–≥—Ä—ã—à");
            }, 1000);
        }

        // --- MINES GAME ---
        let minesActive = false;
        let minesBetAmount = 0;
        let minesMultiplier = 1.0;
        
        function startMines() {
            minesBetAmount = parseFloat(document.getElementById('minesBet').value);
            if(minesBetAmount > currentUser.balance) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");
            if(minesBetAmount <= 0) return;

            // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É —Å—Ä–∞–∑—É (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ) –∏–ª–∏ –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º
            // –í —ç—Ç–æ–º –¥–µ–º–æ —Å–ø–∏—à–µ–º –ø—Ä–∏ –ø—Ä–æ–∏–≥—Ä—ã—à–µ –∏–ª–∏ –≤–µ—Ä–Ω–µ–º –ø—Ä–∏ –≤—ã–∏–≥—Ä—ã—à–µ, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã:
            // –°–ø–∏—à–µ–º —Å—Ç–∞–≤–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            
            changeBalanceServer(-minesBetAmount);

            minesActive = true;
            minesMultiplier = 1.0;
            document.getElementById('startMinesBtn').style.display = 'none';
            document.getElementById('cashoutMinesBtn').style.display = 'block';
            document.getElementById('cashoutMinesBtn').innerText = `–ó–∞–±—Ä–∞—Ç—å ${minesBetAmount}`;
            
            const grid = document.getElementById('minesGrid');
            grid.innerHTML = '';
            for(let i=0; i<25; i++) {
                const cell = document.createElement('div');
                cell.className = 'mine-cell';
                cell.onclick = () => openMine(cell);
                grid.appendChild(cell);
            }
        }

        async function changeBalanceServer(amount) {
            const res = await fetch(`${API_URL}/api/game`, {
                method: 'POST', headers: getHeaders(),
                body: JSON.stringify({ game: 'mines_entry', amount: amount })
            });
            const data = await res.json();
            updateBalanceUI(data.new_balance);
        }

        function openMine(cell) {
            if(!minesActive || cell.classList.contains('revealed')) return;
            
            const isBomb = Math.random() < 0.2; // 20% –±–æ–º–±
            cell.classList.add('revealed');

            if(isBomb) {
                cell.classList.add('bomb');
                cell.innerText = 'üí£';
                minesActive = false;
                tg.showAlert("–í–∑—Ä—ã–≤! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏.");
                resetMinesUI();
            } else {
                cell.classList.add('gem');
                cell.innerText = 'üíé';
                minesMultiplier *= 1.2;
                const currentWin = (minesBetAmount * minesMultiplier).toFixed(2);
                document.getElementById('cashoutMinesBtn').innerText = `–ó–∞–±—Ä–∞—Ç—å ${currentWin}`;
            }
        }

        function cashoutMines() {
            if(!minesActive) return;
            const winAmount = minesBetAmount * minesMultiplier;
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–≤–∫—É + –≤—ã–∏–≥—Ä—ã—à (—Ç.–∫. –º—ã —Å–ø–∏—Å–∞–ª–∏ —Å—Ç–∞–≤–∫—É –≤ –Ω–∞—á–∞–ª–µ)
            // –ù–æ –≤ changeBalanceServer –º—ã —Å–ø–∏—Å–∞–ª–∏, –∑–Ω–∞—á–∏—Ç –Ω—É–∂–Ω–æ –Ω–∞—á–∏—Å–ª–∏—Ç—å winAmount
            changeBalanceServer(winAmount); // –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç –±–∞–ª–∞–Ω—Å
            
            minesActive = false;
            tg.showAlert(`–í—ã –∑–∞–±—Ä–∞–ª–∏ ${winAmount.toFixed(2)}!`);
            resetMinesUI();
        }

        function resetMinesUI() {
            document.getElementById('startMinesBtn').style.display = 'block';
            document.getElementById('cashoutMinesBtn').style.display = 'none';
        }

        // Init App
        init();

    </script>
</body>
</html>
