<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Bet Ultimate V2</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò --- */
        :root {
            --bg: #0d1117;
            --card-bg: #161b22;
            --nav-bg: rgba(22, 27, 34, 0.98);
            --accent: #2ea043; /* –ó–µ–ª–µ–Ω—ã–π "Win" */
            --accent-hover: #3fb950;
            --danger: #da3633;
            --blue: #2f81f7;
            --gold: #e3b341;
            --text-main: #f0f6fc;
            --text-sub: #8b949e;
            --border: #30363d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            padding-bottom: 120px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –∫—É–ø–æ–Ω –∏ –º–µ–Ω—é */
            user-select: none;
            overflow-x: hidden;
        }

        /* --- –®–ê–ü–ö–ê --- */
        .header {
            position: sticky; top: 0; z-index: 50;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(12px);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .logo { font-weight: 900; font-size: 20px; font-style: italic; letter-spacing: -1px; }
        .logo span { color: var(--accent); }
        .balance-chip {
            background: #21262d; padding: 6px 14px; border-radius: 100px;
            border: 1px solid var(--border); font-weight: 700; font-size: 14px;
            display: flex; align-items: center; gap: 6px;
        }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        .nav {
            position: fixed; bottom: 0; width: 100%;
            background: var(--nav-bg);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding: 10px 0 25px 0; z-index: 90;
            backdrop-filter: blur(10px);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-sub); font-size: 10px; gap: 5px;
            transition: 0.2s; width: 20%; cursor: pointer;
        }
        .nav-item.active { color: var(--text-main); transform: translateY(-2px); }
        .nav-icon { font-size: 22px; }

        /* --- –°–¢–†–ê–ù–ò–¶–´ --- */
        .page { display: none; padding: 16px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:translateY(0)} }

        /* --- –ö–ê–†–¢–û–ß–ö–ò –ò –ö–ù–û–ü–ö–ò --- */
        .card {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 16px; padding: 16px; margin-bottom: 16px;
            position: relative; overflow: hidden;
        }
        
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            background: var(--accent); color: white; font-weight: 800; font-size: 16px;
            cursor: pointer; transition: 0.15s; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 4px 0 #238636;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn.secondary { background: #21262d; box-shadow: 0 4px 0 #161b22; border: 1px solid var(--border); }
        .btn.danger { background: var(--danger); box-shadow: 0 4px 0 #b31d1a; }
        .btn.blue { background: var(--blue); box-shadow: 0 4px 0 #1c68d9; }

        input.inp-field {
            width: 100%; background: #090c10; border: 1px solid var(--border);
            padding: 14px; border-radius: 10px; color: white; font-size: 16px;
            outline: none; transition: 0.2s; margin-bottom: 10px;
        }
        input.inp-field:focus { border-color: var(--accent); }
        .label-text { font-size: 12px; color: var(--text-sub); margin-bottom: 6px; display: block; font-weight: 600; }

        /* --- –°–ü–û–†–¢ –õ–ï–ù–¢–ê --- */
        .sport-filter { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none;}
        .filter-chip {
            padding: 8px 16px; background: var(--card-bg); border-radius: 20px;
            font-size: 13px; color: var(--text-sub); white-space: nowrap; border: 1px solid var(--border);
            transition: 0.2s; cursor: pointer;
        }
        .filter-chip.active { background: var(--text-main); color: var(--bg); font-weight: 800; border-color: white; }

        .match-card .league { font-size: 10px; text-transform: uppercase; color: var(--text-sub); font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .live-indic { color: var(--danger); display: flex; align-items: center; gap: 4px; }
        .blink-dot { width: 6px; height: 6px; background: var(--danger); border-radius: 50%; animation: pulse 1s infinite; }
        @keyframes pulse { 50% {opacity: 0.4} }

        .teams-cont { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .team-name { width: 40%; font-size: 13px; font-weight: 700; line-height: 1.2; }
        .score-box { background: #090c10; padding: 4px 12px; border-radius: 8px; font-weight: 900; font-size: 18px; letter-spacing: 2px; border: 1px solid var(--border); }

        .coeffs-grid { display: flex; gap: 8px; }
        .coef-btn {
            flex: 1; background: #21262d; border-radius: 8px; padding: 10px 0;
            text-align: center; cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .coef-btn:active { background: #30363d; }
        .coef-btn.selected { border-color: var(--accent); background: rgba(46, 160, 67, 0.15); color: var(--accent); }
        .c-name { font-size: 10px; color: var(--text-sub); display: block; }
        .c-val { font-size: 14px; font-weight: 800; display: block; }

        /* --- –ö–£–ü–û–ù (Bet Slip) --- */
        .slip-overlay {
            position: fixed; bottom: 85px; left: 10px; right: 10px;
            background: #161b22; border: 1px solid var(--border);
            border-radius: 16px; padding: 16px; z-index: 100;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
            display: none; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .slip-overlay.show { display: block; }
        @keyframes slideUp { from {transform: translateY(100px); opacity:0} to {transform: translateY(0); opacity:1} }

        .slip-head { display: flex; justify-content: space-between; margin-bottom: 12px; font-weight: 700; font-size: 14px; }
        .slip-tag { background: var(--accent); padding: 2px 8px; border-radius: 6px; font-size: 11px; margin-left: 8px; }
        .slip-info { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; color: var(--text-sub); }
        .kef-big { color: var(--gold); font-weight: 800; font-size: 18px; }

        /* --- –ò–°–¢–û–†–ò–Ø –°–¢–ê–í–û–ö --- */
        .hist-filter { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .h-tab { flex: 1; text-align: center; padding: 12px; font-size: 14px; color: var(--text-sub); border-bottom: 2px solid transparent; transition: 0.2s; }
        .h-tab.active { color: var(--text-main); border-color: var(--accent); font-weight: 700; }
        
        .bet-card { border-left: 3px solid var(--border); padding-left: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #21262d; }
        .bet-card.win { border-left-color: var(--accent); }
        .bet-card.lose { border-left-color: var(--danger); }
        .bet-card.active { border-left-color: var(--gold); }
        .bet-status { float: right; font-size: 10px; font-weight: 800; text-transform: uppercase; }

        /* --- MINES GRID --- */
        .mines-wrapper { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 20px; }
        .mine-cell {
            aspect-ratio: 1; background: #21262d; border-radius: 8px;
            border-bottom: 4px solid #0d1117; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; transition: 0.1s;
        }
        .mine-cell:active { border-bottom: 0; transform: translateY(4px); }
        .mine-cell.revealed { background: #30363d; border-bottom: 0; cursor: default; }
        .mine-cell.gem { background: rgba(46, 160, 67, 0.2); border: 1px solid var(--accent); }
        .mine-cell.boom { background: rgba(218, 54, 51, 0.2); border: 1px solid var(--danger); }

        /* --- DICE 3D --- */
        .dice-stage { height: 180px; display: flex; justify-content: center; align-items: center; perspective: 800px; margin-bottom: 20px; }
        .cube { width: 80px; height: 80px; position: relative; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.19, 1, 0.22, 1); }
        .face { position: absolute; width: 80px; height: 80px; background: linear-gradient(135deg, #2f81f7, #1f6feb); border: 2px solid #fff; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 32px; font-weight: bold; color: white; box-shadow: inset 0 0 20px rgba(0,0,0,0.3); }
        .f1 { transform: translateZ(40px); } .f6 { transform: rotateY(180deg) translateZ(40px); }
        .f2 { transform: rotateX(90deg) translateZ(40px); } .f5 { transform: rotateX(-90deg) translateZ(40px); }
        .f3 { transform: rotateY(90deg) translateZ(40px); } .f4 { transform: rotateY(-90deg) translateZ(40px); }

        /* --- –ü–û–ë–ï–î–ù–û–ï –û–ö–ù–û (MODAL) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: none; justify-content: center; align-items: center;
            animation: fadeIn 0.3s;
        }
        .modal-box {
            background: var(--card-bg); width: 85%; border-radius: 24px;
            padding: 30px 20px; text-align: center; border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(46, 160, 67, 0.2);
            position: relative; overflow: hidden;
        }
        .win-glow {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(46, 160, 67, 0.2) 0%, transparent 70%);
            animation: rotate 10s linear infinite; pointer-events: none;
        }
        @keyframes rotate { from {transform: rotate(0deg)} to {transform: rotate(360deg)} }
        .win-info-row { display:flex; justify-content: space-around; font-size: 13px; color: var(--text-sub); margin-bottom: 20px; }

        /* --- ADMIN PANEL --- */
        .admin-panel { display: none; margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">ROYAL<span>BET</span></div>
        <div class="balance-chip">
            <span style="color:var(--accent)">‚ÇΩ</span>
            <span id="header-bal">0</span>
        </div>
    </div>

    <!-- 1. –°–ü–û–†–¢ -->
    <div id="p-sport" class="page active">
        <div class="sport-filter">
            <div class="filter-chip active" onclick="setSport('football', this)">‚öΩ –§—É—Ç–±–æ–ª</div>
            <div class="filter-chip" onclick="setSport('hockey', this)">üèí –•–æ–∫–∫–µ–π</div>
            <div class="filter-chip" onclick="setSport('tennis', this)">üéæ –¢–µ–Ω–Ω–∏—Å</div>
            <div class="filter-chip" onclick="setSport('basket', this)">üèÄ –ë–∞—Å–∫–µ—Ç</div>
        </div>
        <div id="sport-feed" style="padding-bottom: 120px;"></div>
    </div>

    <!-- 2. –ò–°–¢–û–†–ò–Ø –°–¢–ê–í–û–ö -->
    <div id="p-bets" class="page">
        <div class="hist-filter">
            <div class="h-tab active" onclick="renderHistory('active', this)">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
            <div class="h-tab" onclick="renderHistory('settled', this)">–†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ</div>
        </div>
        <div id="bets-list"></div>
    </div>

    <!-- 3. MINES -->
    <div id="p-mines" class="page">
        <div class="card">
            <span class="label-text">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ (–º–∏–Ω 15‚ÇΩ)</span>
            <input type="number" id="m-bet" class="inp-field" value="100" placeholder="100">
            
            <span class="label-text">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω (–æ—Ç 3 –¥–æ 24)</span>
            <input type="number" id="m-count" class="inp-field" value="3" placeholder="3">
            
            <div style="height:10px"></div>
            <button class="btn" id="m-start" onclick="minesStart()">–ò–ì–†–ê–¢–¨</button>
            <button class="btn blue" id="m-cash" onclick="minesCashout()" style="display:none;">–ó–ê–ë–†–ê–¢–¨ –í–´–ò–ì–†–´–®</button>
        </div>
        <div class="mines-wrapper" id="m-grid"></div>
    </div>

    <!-- 4. DICE -->
    <div id="p-dice" class="page">
        <div class="dice-stage">
            <div class="cube" id="cube">
                <div class="face f1">1</div><div class="face f6">6</div>
                <div class="face f2">2</div><div class="face f5">5</div>
                <div class="face f3">3</div><div class="face f4">4</div>
            </div>
        </div>
        <div class="card">
            <span class="label-text">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ (–º–∏–Ω 15‚ÇΩ)</span>
            <input type="number" id="d-bet" class="inp-field" value="100">
            
            <div style="display:flex; gap:10px; margin: 15px 0;">
                <button class="btn secondary" id="d-odd" onclick="diceSelect('odd', this)">–ù–µ—á–µ—Ç (x1.9)</button>
                <button class="btn secondary" id="d-even" onclick="diceSelect('even', this)">–ß–µ—Ç (x1.9)</button>
            </div>
            
            <button class="btn" onclick="diceRoll()">–ë–†–û–°–ò–¢–¨ –ö–£–ë–ò–ö</button>
        </div>
    </div>

    <!-- 5. –ö–û–®–ï–õ–ï–ö & –ê–î–ú–ò–ù–ö–ê -->
    <div id="p-wallet" class="page">
        <div class="card" style="text-align:center; padding: 40px 20px;">
            <div style="color:var(--text-sub); font-size:12px; margin-bottom:10px;">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞</div>
            <div style="font-size:42px; font-weight:900; color:white; margin-bottom:20px;">
                <span style="color:var(--accent)">‚ÇΩ</span> <span id="w-bal">0</span>
            </div>
            <button class="btn secondary" onclick="notify('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –°–ë–ü –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.\n–í–µ–¥—É—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã.')">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
            
            <!-- –°–µ–∫—Ä–µ—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∫–∏ -->
            <div style="margin-top:50px; opacity:0.3; font-size:12px;" onclick="toggleAdmin()">–í–µ—Ä—Å–∏—è v5.0.1 (Tap 5x for Admin)</div>
            
            <div id="admin" class="admin-panel">
                <h4 style="color:var(--danger)">Admin Console</h4>
                <input type="number" id="adm-sum" class="inp-field" placeholder="–°—É–º–º–∞ –±–∞–ª–∞–Ω—Å–∞">
                <button class="btn" style="background:#21262d; margin-bottom:10px;" onclick="setAdminBal()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
                <button class="btn danger" onclick="fullReset()">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö (Wipe)</button>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="nav">
        <div class="nav-item active" onclick="nav('sport', this)"><div class="nav-icon">üèÜ</div>–°–ø–æ—Ä—Ç</div>
        <div class="nav-item" onclick="nav('bets', this)"><div class="nav-icon">üßæ</div>–°—Ç–∞–≤–∫–∏</div>
        <div class="nav-item" onclick="nav('mines', this)"><div class="nav-icon">üí£</div>Mines</div>
        <div class="nav-item" onclick="nav('dice', this)"><div class="nav-icon">üé≤</div>Dice</div>
        <div class="nav-item" onclick="nav('wallet', this)"><div class="nav-icon">üë§</div>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <!-- BET SLIP -->
    <div id="slip" class="slip-overlay">
        <div class="slip-head">
            <span id="slip-title">–ö—É–ø–æ–Ω <span class="slip-tag">0</span></span>
            <span style="color:var(--danger)" onclick="clearSlip()">–û—á–∏—Å—Ç–∏—Ç—å</span>
        </div>
        <div class="slip-info">
            <span>–ò—Ç–æ–≥–æ–≤—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç:</span>
            <span class="kef-big" id="slip-kef">1.00</span>
        </div>
        <input type="number" id="slip-stake" class="inp-field" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏ (‚ÇΩ)" oninput="calcWin()">
        <div style="text-align:right; font-size:12px; color:var(--text-sub); margin-bottom:10px;">
            –í—ã–∏–≥—Ä—ã—à: <span style="color:white; font-weight:bold" id="slip-win">0</span> ‚ÇΩ
        </div>
        <button class="btn" onclick="placeBet()">–°–î–ï–õ–ê–¢–¨ –°–¢–ê–í–ö–£</button>
    </div>

    <!-- WIN MODAL -->
    <div id="modal" class="modal" onclick="closeModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="win-glow"></div>
            <h2 style="color:var(--gold); margin:0;">–ü–û–ë–ï–î–ê! üèÜ</h2>
            <p style="color:var(--text-sub); margin-top:5px;" id="win-src">Sport Betting</p>
            <h1 style="font-size:40px; margin:20px 0;" id="win-sum">0 ‚ÇΩ</h1>
            
            <div class="win-info-row">
                 <div>–°—Ç–∞–≤–∫–∞: <b id="win-bet-val" style="color:white">0</b></div>
                 <div>–ö—ç—Ñ: <b id="win-kef-val" style="color:white">x0</b></div>
            </div>

            <button class="btn" onclick="closeModal()">–û–¢–õ–ò–ß–ù–û</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è)
        const tg = window.Telegram.WebApp;
        try { tg.expand(); } catch(e) { console.log("Not in TG"); }

        // Wrapper –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        function notify(msg) {
            if(tg && tg.showAlert) tg.showAlert(msg);
            else alert(msg);
        }

        // --- GLOBAL STATE ---
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã —Å—Ç–µ—Ä–µ—Ç—å —Å—Ç–∞—Ä—ã–µ –±–∞–≥–∏
        let state = JSON.parse(localStorage.getItem('royal_ultimate_v2')) || {
            balance: 10000,
            matches: [],
            bets: [],
            lastLogin: Date.now()
        };

        let slip = [];
        let activeSport = 'football';

        // --- INIT ---
        updateUI();
        // –ï—Å–ª–∏ –º–∞—Ç—á–µ–π –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º —Å—Ä–∞–∑—É
        if(!state.matches || state.matches.length === 0) initMatches();
        
        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        setInterval(gameLoop, 3000); 

        // --- CORE FUNCTIONS ---
        function save() {
            localStorage.setItem('royal_ultimate_v2', JSON.stringify(state));
            updateUI();
        }

        function updateUI() {
            document.getElementById('header-bal').innerText = Math.floor(state.balance).toLocaleString();
            document.getElementById('w-bal').innerText = Math.floor(state.balance).toLocaleString();
        }

        function nav(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('p-'+page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            
            if(page === 'sport') renderMatches();
            if(page === 'bets') renderHistory('active');
        }

        // --- SPORT ENGINE ---
        const DB = {
            football: ["Real Madrid","Barcelona","Man City","Liverpool","Arsenal","Bayern","PSG","Juventus","Inter","Milan","Zenit","Spartak"],
            hockey: ["SKA","CSKA","Rangers","Bruins","Avangard","Ak Bars","Dynamo","Tampa Bay","Vegas","Colorado"],
            tennis: ["Djokovic","Alcaraz","Medvedev","Sinner","Rublev","Zverev","Tsitsipas","Rune"],
            basket: ["Lakers","Celtics","Warriors","Bulls","Heat","Nuggets","Suns","Bucks"]
        };

        function initMatches() {
            state.matches = [];
            ['football','hockey','tennis','basket'].forEach(s => {
                let t = [...DB[s]].sort(()=>Math.random()-0.5);
                for(let i=0; i<4; i++) {
                    if(!t[i*2]) break;
                    state.matches.push({
                        id: Date.now()+i+Math.random(),
                        t1: t[i*2], t2: t[i*2+1],
                        s1: 0, s2: 0, time: 0, sport: s,
                        k1: (1.6+Math.random()).toFixed(2),
                        kx: (3.1+Math.random()).toFixed(2),
                        k2: (1.6+Math.random()).toFixed(2),
                        finished: false
                    });
                }
            });
            save();
        }

        function gameLoop() {
            let changed = false;
            state.matches.forEach(m => {
                if(m.finished) return;
                
                // –í—Ä–µ–º—è –∏–¥–µ—Ç (–º–µ–¥–ª–µ–Ω–Ω–æ, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ)
                m.time += Math.floor(Math.random()*2) + 1; 

                // –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≥–æ–ª–∞
                let chance = 0.04; // 4% –∑–∞ —Ç–∏–∫
                if(Math.random() < chance) {
                    Math.random()>0.5 ? m.s1++ : m.s2++;
                    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∫—ç—Ñ—ã
                    let shift = (m.s1 - m.s2) * 0.15;
                    m.k1 = Math.max(1.05, (parseFloat(m.k1) - shift).toFixed(2));
                    m.k2 = Math.max(1.05, (parseFloat(m.k2) + shift).toFixed(2));
                    changed = true;
                }

                if(m.time >= 90) { m.finished = true; checkBets(); changed = true; }
            });

            if(state.matches.every(m=>m.finished)) setTimeout(initMatches, 3000); 
            if(changed) { save(); if(document.getElementById('p-sport').classList.contains('active')) renderMatches(); }
        }

        function setSport(s, el) {
            activeSport = s;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderMatches();
        }

        function renderMatches() {
            const feed = document.getElementById('sport-feed'); feed.innerHTML = '';
            state.matches.filter(m => m.sport === activeSport && !m.finished).forEach(m => {
                let s1 = isInSlip(m.id,'1')?'selected':'';
                let sX = isInSlip(m.id,'x')?'selected':'';
                let s2 = isInSlip(m.id,'2')?'selected':'';
                
                let html = `
                <div class="card match-card">
                    <div class="league"><span>${m.sport.toUpperCase()} PRO LEAGUE</span> <div class="live-indic"><div class="blink-dot"></div> ${m.time}'</div></div>
                    <div class="teams-cont">
                        <div class="team-name">${m.t1}</div>
                        <div class="score-box">${m.s1} : ${m.s2}</div>
                        <div class="team-name" style="text-align:right">${m.t2}</div>
                    </div>
                    <div class="coeffs-grid">
                        <div class="coef-btn ${s1}" onclick="togSlip(${m.id},'1',${m.k1},'${m.t1}')"><span class="c-name">–ü1</span><span class="c-val">${m.k1}</span></div>
                        ${m.sport!=='tennis' ? `<div class="coef-btn ${sX}" onclick="togSlip(${m.id},'x',${m.kx},'–ù–∏—á—å—è')"><span class="c-name">X</span><span class="c-val">${m.kx}</span></div>` : ''}
                        <div class="coef-btn ${s2}" onclick="togSlip(${m.id},'2',${m.k2},'${m.t2}')"><span class="c-name">–ü2</span><span class="c-val">${m.k2}</span></div>
                    </div>
                </div>`;
                feed.innerHTML += html;
            });
        }

        // --- BETTING SLIP ---
        function isInSlip(id, type) { return slip.find(x => x.id===id && x.type===type); }

        function togSlip(id, type, k, name) {
            let idx = slip.findIndex(x => x.id === id);
            if(idx >= 0) {
                if(slip[idx].type === type) slip.splice(idx, 1); // remove if same
                else slip[idx] = {id, type, k, name}; // replace if diff
            } else {
                slip.push({id, type, k, name});
            }
            updateSlipUI(); renderMatches();
        }

        function updateSlipUI() {
            let el = document.getElementById('slip');
            if(slip.length === 0) { el.classList.remove('show'); return; }
            el.classList.add('show');
            
            // –ü–µ—Ä–µ–º–Ω–æ–∂–µ–Ω–∏–µ (—ç–∫—Å–ø—Ä–µ—Å—Å)
            let totalK = slip.reduce((a,b) => a * b.k, 1).toFixed(2);
            document.querySelector('.slip-tag').innerText = slip.length > 1 ? `–≠–∫—Å–ø—Ä–µ—Å—Å (${slip.length})` : '–û—Ä–¥–∏–Ω–∞—Ä';
            document.getElementById('slip-kef').innerText = totalK;
            calcWin();
        }

        function calcWin() {
            let s = +document.getElementById('slip-stake').value;
            let k = +document.getElementById('slip-kef').innerText;
            document.getElementById('slip-win').innerText = Math.floor(s * k);
        }

        function clearSlip() { slip=[]; updateSlipUI(); renderMatches(); }

        function placeBet() {
            let stake = +document.getElementById('slip-stake').value;
            if(stake < 15) return notify("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 15‚ÇΩ");
            if(stake > state.balance) return notify("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

            state.balance -= stake;
            let tk = +document.getElementById('slip-kef').innerText;
            
            state.bets.unshift({
                date: new Date().toLocaleTimeString(),
                type: slip.length > 1 ? 'express' : 'single',
                items: [...slip],
                stake: stake,
                k: tk,
                status: 'active'
            });
            save(); clearSlip();
            notify("‚úÖ –°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!");
        }

        function checkBets() {
            state.bets.forEach(b => {
                if(b.status !== 'active') return;
                
                let win = true; 
                let active = false;

                b.items.forEach(i => {
                    let m = state.matches.find(x => x.id === i.id);
                    if(!m) return; 
                    if(!m.finished) { active = true; return; }

                    let res = 'x';
                    if(m.s1 > m.s2) res = '1';
                    if(m.s2 > m.s1) res = '2';
                    if(i.type !== res) win = false;
                });

                if(!active) {
                    if(win) {
                        b.status = 'win';
                        let winSum = Math.floor(b.stake * b.k);
                        state.balance += winSum;
                        showWin(winSum, "Sport Betting", b.stake, b.k);
                    } else {
                        b.status = 'lose';
                    }
                }
            });
            save();
            if(document.getElementById('p-bets').classList.contains('active')) renderHistory('active');
        }

        // --- HISTORY RENDER ---
        function renderHistory(filter, tabEl) {
            if(tabEl) {
                document.querySelectorAll('.h-tab').forEach(x => x.classList.remove('active'));
                tabEl.classList.add('active');
            }
            const el = document.getElementById('bets-list'); el.innerHTML = '';
            
            let list = state.bets.filter(b => filter==='active' ? b.status==='active' : b.status!=='active');
            if(list.length === 0) el.innerHTML = '<div style="text-align:center; color:#555; margin-top:20px">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>';

            list.forEach(b => {
                let det = b.items.map(i => `${i.name} (${i.type==='x'?'X':('–ü'+i.type)})`).join(', ');
                let html = `
                <div class="bet-card ${b.status}">
                    <div class="bet-status" style="color:${b.status==='win'?'var(--accent)':(b.status==='lose'?'var(--danger)':'var(--gold)')}">
                        ${b.status==='win'?'–í–´–ò–ì–†–´–®':(b.status==='lose'?'–ü–†–û–ò–ì–†–´–®':'–í –ò–ì–†–ï')}
                    </div>
                    <div style="font-weight:bold; font-size:14px;">${b.type==='express'?'–≠–∫—Å–ø—Ä–µ—Å—Å':'–û—Ä–¥–∏–Ω–∞—Ä'} <span style="color:var(--gold)">x${b.k}</span></div>
                    <div style="font-size:11px; color:#888; margin:5px 0">${det}</div>
                    <div style="font-size:13px; font-weight:700">${b.stake}‚ÇΩ &rarr; ${Math.floor(b.stake*b.k)}‚ÇΩ</div>
                </div>`;
                el.innerHTML += html;
            });
        }

        // --- MINES ENGINE ---
        let mGame = {act:false, grid:[], bet:0, mult:1, count:3};
        function minesStart() {
            let b = +document.getElementById('m-bet').value;
            let c = +document.getElementById('m-count').value;
            if(b<15) return notify("–ú–∏–Ω 15‚ÇΩ");
            if(c<3||c>24) return notify("–ú–∏–Ω—ã: 3-24");
            if(b>state.balance) return notify("–ù–µ—Ç –¥–µ–Ω–µ–≥");

            state.balance -= b; save();
            mGame = {act:true, bet:b, count:c, mult:1, grid:Array(25).fill(0)};
            
            let placed=0; 
            while(placed<c){ let r=Math.floor(Math.random()*25); if(!mGame.grid[r]){mGame.grid[r]=1; placed++} }

            document.getElementById('m-start').style.display='none';
            document.getElementById('m-cash').style.display='block';
            document.getElementById('m-cash').innerText = `–ó–ê–ë–†–ê–¢–¨ ${b} ‚ÇΩ`;
            
            let g = document.getElementById('m-grid'); g.innerHTML='';
            for(let i=0; i<25; i++) {
                let d=document.createElement('div'); d.className='mine-cell';
                d.onclick=()=>mineHit(i,d); g.appendChild(d);
            }
        }
        function mineHit(i, el) {
            if(!mGame.act || el.classList.contains('revealed')) return;
            el.classList.add('revealed');
            
            if(mGame.grid[i]) {
                el.classList.add('boom'); el.innerText='üí£'; mGame.act=false;
                try{ tg.HapticFeedback.notificationOccurred('error'); } catch(e){}
                revealMines();
                setTimeout(()=>resetMines(), 2000);
            } else {
                el.classList.add('gem'); el.innerText='üíé';
                try{ tg.HapticFeedback.impactOccurred('light'); } catch(e){}
                let risk = 1 + (mGame.count / 20); 
                mGame.mult *= risk;
                let win = Math.floor(mGame.bet * mGame.mult);
                document.getElementById('m-cash').innerText = `–ó–ê–ë–†–ê–¢–¨ ${win} ‚ÇΩ`;
            }
        }
        function minesCashout() {
            if(!mGame.act) return;
            let w = Math.floor(mGame.bet * mGame.mult);
            state.balance += w; save();
            showWin(w, "Mines", mGame.bet, mGame.mult.toFixed(2));
            mGame.act=false; revealMines(); setTimeout(()=>resetMines(), 2000);
        }
        function revealMines() {
            document.querySelectorAll('.mine-cell').forEach((e,i)=>{
                if(mGame.grid[i]) { e.classList.add('revealed','boom'); e.innerText='üí£'; }
            });
        }
        function resetMines() {
            document.getElementById('m-start').style.display='block';
            document.getElementById('m-cash').style.display='none';
            document.getElementById('m-grid').innerHTML = '';
        }

        // --- DICE ENGINE ---
        let dPick = null;
        function diceSelect(t, el) {
            dPick=t; document.querySelectorAll('#d-odd, #d-even').forEach(x=>x.classList.remove('selected'));
            el.classList.add('selected');
        }
        function diceRoll() {
            let b = +document.getElementById('d-bet').value;
            if(b<15) return notify("–ú–∏–Ω 15‚ÇΩ");
            if(!dPick) return notify("–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ö–æ–¥");
            if(b>state.balance) return notify("–ù–µ—Ç –¥–µ–Ω–µ–≥");

            state.balance -= b; save();
            let res = Math.floor(Math.random()*6)+1;
            
            // 3D –≤—Ä–∞—â–µ–Ω–∏–µ
            let x = (Math.random()*4+4)*360; 
            let y = (Math.random()*4+4)*360;
            // –ü–æ–¥–≥–æ–Ω —É–≥–ª–æ–≤
            if(res===1) {x+=0;y+=0;} if(res===6) {x+=0;y+=180;}
            if(res===2) {x+=90;y+=0;} if(res===5) {x+=-90;y+=0;}
            if(res===3) {x+=0;y+=-90;} if(res===4) {x+=0;y+=90;}

            document.getElementById('cube').style.transform = `rotateX(${x}deg) rotateY(${y}deg)`;
            
            setTimeout(() => {
                let win = (dPick==='odd' && res%2!==0) || (dPick==='even' && res%2===0);
                if(win) {
                    let w = Math.floor(b*1.9);
                    state.balance += w; save();
                    showWin(w, "Dice 3D", b, "1.90");
                }
            }, 1600);
        }

        // --- UTILS ---
        function showWin(sum, src, bet, k) {
            document.getElementById('win-sum').innerText = sum + " ‚ÇΩ";
            document.getElementById('win-src').innerText = src;
            document.getElementById('win-bet-val').innerText = bet;
            document.getElementById('win-kef-val').innerText = "x"+k;
            document.getElementById('modal').style.display = 'flex';
            try{ tg.HapticFeedback.notificationOccurred('success'); } catch(e){}
        }
        function closeModal() { document.getElementById('modal').style.display='none'; }

        // --- ADMIN ---
        let taps=0;
        function toggleAdmin() {
            taps++;
            if(taps===5) { document.getElementById('admin').style.display='block'; notify("Admin Mode ON"); }
        }
        function setAdminBal() { state.balance = +document.getElementById('adm-sum').value; save(); notify("–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω"); }
        function fullReset() { localStorage.removeItem('royal_ultimate_v2'); location.reload(); }

    </script>
</body>
</html>
