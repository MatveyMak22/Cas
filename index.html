<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Bet PostgreSQL</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –î–ò–ó–ê–ô–ù: PREMIUM DARK */
        :root {
            --bg: #0d1117; --card: #161b22; --nav: rgba(22,27,34,0.98);
            --accent: #2ea043; --red: #da3633; --gold: #e3b341;
            --text: #f0f6fc; --sub: #8b949e; --border: #30363d;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 120px; user-select: none; }
        
        /* –ó–ê–ì–†–£–ó–ß–ò–ö */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--card); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* HEADER */
        .header { position: sticky; top: 0; background: rgba(13,17,23,0.95); padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 50; }
        .logo { font-weight: 900; font-style: italic; font-size: 20px; } .logo span { color: var(--accent); }
        .bal { background: #21262d; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); font-weight: bold; }

        /* UI COMPONENTS */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .btn { width: 100%; padding: 15px; background: var(--accent); border: none; border-radius: 10px; color: #fff; font-weight: bold; font-size: 16px; margin-top: 10px; }
        input { width: 100%; background: #090c10; border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: #fff; margin-bottom: 10px; }
        
        /* SPORT */
        .tabs { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 15px; }
        .tab { padding: 8px 16px; background: var(--card); border-radius: 20px; font-size: 12px; border: 1px solid var(--border); white-space: nowrap; color: var(--sub); }
        .tab.active { background: var(--text); color: var(--bg); font-weight: bold; }
        .match { position: relative; }
        .live { position: absolute; top: 12px; right: 12px; font-size: 10px; color: var(--red); font-weight: bold; display: flex; gap: 4px; }
        .dot { width: 6px; height: 6px; background: var(--red); border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% {opacity:0.4} }
        .teams { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; font-weight: bold; }
        .score { background: #090c10; padding: 4px 10px; border-radius: 6px; font-size: 16px; }
        .coefs { display: flex; gap: 8px; }
        .c-btn { flex: 1; background: #21262d; padding: 10px; border-radius: 8px; text-align: center; font-size: 12px; border: 1px solid transparent; }
        .c-btn.sel { border-color: var(--accent); background: rgba(46,160,67,0.15); color: var(--accent); }

        /* MINES & DICE */
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 15px; }
        .cell { aspect-ratio: 1; background: #21262d; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-size: 22px; cursor: pointer; border-bottom: 3px solid #000; }
        .cell.open { background: #30363d; border-bottom: 0; }
        .cell.bomb { background: rgba(218,54,51,0.3); } .cell.gem { background: rgba(46,160,67,0.3); }
        
        .scene { height: 150px; display: flex; justify-content: center; align-items: center; perspective: 800px; }
        .cube { width: 70px; height: 70px; position: relative; transform-style: preserve-3d; transition: transform 1.5s; }
        .face { position: absolute; width: 70px; height: 70px; background: rgba(46,160,67,0.9); border: 2px solid white; display: flex; justify-content: center; align-items: center; font-size: 30px; font-weight: bold; color: white; border-radius: 10px; }
        .f1 { transform: translateZ(35px); } .f6 { transform: rotateY(180deg) translateZ(35px); }
        .f2 { transform: rotateX(90deg) translateZ(35px); } .f5 { transform: rotateX(-90deg) translateZ(35px); }
        .f3 { transform: rotateY(90deg) translateZ(35px); } .f4 { transform: rotateY(-90deg) translateZ(35px); }

        /* SLIP */
        .slip { position: fixed; bottom: 85px; left: 10px; right: 10px; background: #161b22; border: 1px solid var(--accent); padding: 15px; border-radius: 12px; display: none; z-index: 100; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
        .slip.show { display: block; }

        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; background: var(--nav); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0 20px 0; z-index: 90; }
        .nav-item { color: var(--sub); font-size: 10px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--text); }
        .icon { font-size: 20px; margin-bottom: 4px; }
        
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--card); padding: 25px; border-radius: 20px; text-align: center; border: 1px solid var(--gold); width: 80%; }
    </style>
</head>
<body>

    <!-- –ó–ê–ì–†–£–ó–ö–ê -->
    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:15px; color:#888; font-size:14px">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
    <div id="app" style="display:none">
        
        <div class="header">
            <div class="logo">ROYAL <span>BET</span></div>
            <div class="bal"><span style="color:var(--accent)">‚ÇΩ</span> <span id="ui-bal">...</span></div>
        </div>

        <!-- 1. SPORT -->
        <div id="p-sport" class="page active">
            <div class="tabs">
                <div class="tab active" onclick="setFilter('football', this)">‚öΩ –§—É—Ç–±–æ–ª</div>
                <div class="tab" onclick="setFilter('hockey', this)">üèí –•–æ–∫–∫–µ–π</div>
                <div class="tab" onclick="setFilter('tennis', this)">üéæ –¢–µ–Ω–Ω–∏—Å</div>
            </div>
            <div id="feed"></div>
        </div>

        <!-- 2. MINES -->
        <div id="p-mines" class="page">
            <div class="card">
                <h3>Mines</h3>
                <input type="number" id="m-bet" placeholder="–°—Ç–∞–≤–∫–∞" value="100">
                <input type="number" id="m-cnt" placeholder="–ú–∏–Ω—ã (3-24)" value="3">
                <button class="btn" id="m-start" onclick="minesRun()">–ò–ì–†–ê–¢–¨</button>
                <button class="btn" id="m-cash" onclick="minesEnd()" style="display:none; background:#2f81f7">–ó–ê–ë–†–ê–¢–¨</button>
            </div>
            <div class="grid" id="m-grid"></div>
        </div>

        <!-- 3. DICE -->
        <div id="p-dice" class="page">
            <div class="card">
                <h3>Dice 3D</h3>
                <div class="scene"><div class="cube" id="cube"><div class="face f1">1</div><div class="face f6">6</div><div class="face f2">2</div><div class="face f5">5</div><div class="face f3">3</div><div class="face f4">4</div></div></div>
                <input type="number" id="d-bet" value="100" placeholder="–°—Ç–∞–≤–∫–∞">
                <div style="display:flex; gap:10px; margin-top:10px">
                    <button class="btn" style="background:#21262d" id="d-odd" onclick="diceSet('odd', this)">–ù–ï–ß–ï–¢</button>
                    <button class="btn" style="background:#21262d" id="d-even" onclick="diceSet('even', this)">–ß–ï–¢</button>
                </div>
                <button class="btn" onclick="diceRoll()">–ë–†–û–°–û–ö</button>
            </div>
        </div>

        <!-- 4. –ü–†–û–§–ò–õ–¨ -->
        <div id="p-wallet" class="page">
            <div class="card" style="text-align:center; padding:40px 20px">
                <div style="color:#888">–ë–∞–ª–∞–Ω—Å (–°–µ—Ä–≤–µ—Ä)</div>
                <h1 style="font-size:40px; margin:10px 0"><span style="color:var(--accent)">‚ÇΩ</span> <span id="w-bal">0</span></h1>
                <p style="font-size:12px; color:#555">–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –ë–î</p>
                <button class="btn" style="background:#21262d" onclick="tg.showAlert('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞')">–ü–û–ü–û–õ–ù–ò–¢–¨</button>
                <button class="btn" style="background:var(--red); margin-top:20px" onclick="location.reload()">–û–ë–ù–û–í–ò–¢–¨</button>
            </div>
        </div>

        <!-- –ö–£–ü–û–ù -->
        <div id="slip" class="slip">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                <b style="color:var(--accent)">–ö—É–ø–æ–Ω</b> <span style="color:var(--red)" onclick="clearSlip()">–û—á–∏—Å—Ç–∏—Ç—å</span>
            </div>
            <div>–ö—ç—Ñ: <b id="s-kef" style="color:var(--gold)">1.00</b></div>
            <input type="number" id="s-stake" placeholder="–°—É–º–º–∞" style="margin:5px 0" oninput="calcWin()">
            <div style="font-size:12px">–í—ã–∏–≥—Ä—ã—à: <b id="s-win">0</b> ‚ÇΩ</div>
            <button class="btn" onclick="placeBet()">–ü–û–°–¢–ê–í–ò–¢–¨</button>
        </div>

        <!-- MODAL -->
        <div id="modal" class="modal" onclick="this.style.display='none'">
            <div class="modal-box" onclick="event.stopPropagation()">
                <h2 style="color:var(--gold)">–ü–û–ë–ï–î–ê! üèÜ</h2>
                <h1 id="win-sum">0 ‚ÇΩ</h1>
                <button class="btn" onclick="document.getElementById('modal').style.display='none'">–ö–†–£–¢–û</button>
            </div>
        </div>

        <!-- NAV -->
        <div class="nav">
            <div class="nav-item active" onclick="nav('sport', this)"><div class="icon">üèÜ</div>–°–ø–æ—Ä—Ç</div>
            <div class="nav-item" onclick="nav('mines', this)"><div class="icon">üí£</div>Mines</div>
            <div class="nav-item" onclick="nav('dice', this)"><div class="icon">üé≤</div>Dice</div>
            <div class="nav-item" onclick="nav('wallet', this)"><div class="icon">üë§</div>–ü—Ä–æ—Ñ–∏–ª—å</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ==========================================
        // ‚ö†Ô∏è –ù–ê–°–¢–†–û–ô–ö–ò –°–ï–†–í–ï–†–ê
        // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å—Å—ã–ª–∫—É –Ω–∞ —Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä Render (–±–µ–∑ —Å–ª–µ—à–∞ –≤ –∫–æ–Ω—Ü–µ)
        const SERVER_URL = 'https://backend-4jag.onrender.com';
        // ==========================================

        // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (12345 –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
        let userId = tg.initDataUnsafe?.user?.id || 12345;
        let balance = 0;
        let matches = [];
        let slip = [];

        // 1. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –ë–ê–ó–ï –î–ê–ù–ù–´–•
        async function init() {
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å —É Python-—Å–µ—Ä–≤–µ—Ä–∞
                let res = await fetch(`${SERVER_URL}/api/user?id=${userId}`);
                let data = await res.json();
                
                if(data.balance !== undefined) {
                    balance = data.balance;
                    updateUI();
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    startSportSim(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
                } else {
                    alert("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
                }
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è! –ü—Ä–æ–≤–µ—Ä—å SERVER_URL.");
                console.error(e);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sync() {
            try {
                await fetch(`${SERVER_URL}/api/save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id: userId, balance: balance })
                });
            } catch(e) { console.error("Sync error"); }
        }

        function updateUI() {
            document.getElementById('ui-bal').innerText = balance;
            document.getElementById('w-bal').innerText = balance;
        }

        // --- –õ–û–ì–ò–ö–ê –°–¢–ê–í–û–ö –ò –ò–ì–† (–û–°–¢–ê–õ–ê–°–¨ –ü–†–ï–ñ–ù–ï–ô) ---
        
        // 2. –°–ü–û–†–¢
        const TEAMS = {
            football: ["Real Madrid","Barca","Man City","Arsenal","Bayern","PSG"],
            hockey: ["SKA","CSKA","Rangers","Bruins","Avangard"],
            tennis: ["Djokovic","Alcaraz","Sinner","Medvedev"]
        };
        let curSport = 'football';

        function startSportSim() {
            ['football','hockey','tennis'].forEach(s => {
                let t = [...TEAMS[s]].sort(()=>Math.random()-0.5);
                for(let i=0; i<4; i+=2) {
                    if(t[i]) matches.push({
                        id: Date.now()+i, sport:s, t1:t[i], t2:t[i+1], s1:0, s2:0, time:0,
                        k1:(1.5+Math.random()).toFixed(2), kx:3.5, k2:(1.5+Math.random()).toFixed(2), fin:false
                    });
                }
            });
            renderSport();
            setInterval(() => {
                let ch = false;
                matches.forEach(m => {
                    if(!m.fin) {
                        m.time++;
                        if(Math.random()<0.05) { Math.random()>0.5?m.s1++:m.s2++; ch=true; }
                        if(m.time>=90) m.fin=true;
                    }
                });
                if(ch) renderSport();
            }, 1000);
        }

        function setFilter(s, el) {
            curSport = s;
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
            renderSport();
        }

        function renderSport() {
            const d = document.getElementById('feed'); d.innerHTML='';
            matches.filter(m=>m.sport===curSport && !m.fin).forEach(m => {
                let s1 = hasSlip(m.id,'1')?'sel':'';
                let sX = hasSlip(m.id,'x')?'sel':'';
                let s2 = hasSlip(m.id,'2')?'sel':'';
                d.innerHTML += `
                <div class="card match">
                    <div class="live-tag"><div class="dot"></div> ${m.time}'</div>
                    <div style="font-size:10px; color:#888; text-transform:uppercase; font-weight:bold; margin-bottom:10px">${m.sport}</div>
                    <div class="teams"><span>${m.t1}</span><span class="score">${m.s1}:${m.s2}</span><span>${m.t2}</span></div>
                    <div class="coefs">
                        <div class="c-btn ${s1}" onclick="addSlip(${m.id},'1',${m.k1})">–ü1<br>${m.k1}</div>
                        ${m.sport!='tennis'?`<div class="c-btn ${sX}" onclick="addSlip(${m.id},'x',${m.kx})">X<br>${m.kx}</div>`:''}
                        <div class="c-btn ${s2}" onclick="addSlip(${m.id},'2',${m.k2})">–ü2<br>${m.k2}</div>
                    </div>
                </div>`;
            });
        }

        // 3. –ö–£–ü–û–ù
        function hasSlip(id,t){return slip.find(x=>x.id==id && x.t==t);}
        function addSlip(id,t,k){
            let i=slip.findIndex(x=>x.id==id);
            if(i>=0) slip.splice(i,1);
            slip.push({id,t,k});
            updSlip(); renderSport();
        }
        function updSlip(){
            let el=document.getElementById('slip');
            if(slip.length==0) { el.classList.remove('show'); return; }
            el.classList.add('show');
            let k = slip.reduce((a,b)=>a*b.k,1).toFixed(2);
            document.getElementById('s-kef').innerText=k;
        }
        function calcWin(){
            let s=+document.getElementById('s-stake').value;
            let k=+document.getElementById('s-kef').innerText;
            document.getElementById('s-win').innerText=Math.floor(s*k);
        }
        function clearSlip(){ slip=[]; updSlip(); renderSport(); }
        function placeBet(){
            let s=+document.getElementById('s-stake').value;
            if(s>balance) return tg.showAlert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥");
            balance-=s; updateUI(); sync(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
            slip=[]; updSlip(); renderSport();
            tg.showAlert("–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!");
        }

        // 4. MINES
        let mG={act:false, g:[], bet:0, mul:1};
        function minesRun(){
            let b=+document.getElementById('m-bet').value; let c=+document.getElementById('m-cnt').value;
            if(b>balance) return tg.showAlert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥");
            balance-=b; updateUI(); sync();
            mG={act:true, bet:b, mul:1, g:Array(25).fill(0)};
            let n=0; while(n<c){let r=Math.floor(Math.random()*25); if(!mG.g[r]){mG.g[r]=1;n++}}
            document.getElementById('m-start').style.display='none'; document.getElementById('m-cash').style.display='block';
            document.getElementById('m-grid').innerHTML='';
            for(let i=0;i<25;i++){
                let d=document.createElement('div'); d.className='cell';
                d.onclick=()=>mHit(i,d); document.getElementById('m-grid').appendChild(d);
            }
        }
        function mHit(i,el){
            if(!mG.act||el.classList.contains('open'))return;
            el.classList.add('open');
            if(mG.g[i]){
                el.classList.add('bomb'); el.innerText='üí£'; mG.act=false;
                setTimeout(()=>{document.getElementById('m-start').style.display='block';document.getElementById('m-cash').style.display='none';},1000);
            } else {
                el.classList.add('gem'); el.innerText='üíé'; mG.mul*=1.15;
                document.getElementById('m-cash').innerText=`–ó–ê–ë–†–ê–¢–¨ ${Math.floor(mG.bet*mG.mul)}`;
            }
        }
        function minesEnd(){
            if(!mG.act)return;
            let w=Math.floor(mG.bet*mG.mul); balance+=w; updateUI(); sync(); mG.act=false;
            showWin(w);
            document.getElementById('m-start').style.display='block';document.getElementById('m-cash').style.display='none';
        }

        // 5. DICE
        let dP=null;
        function diceSet(t,el){ dP=t; document.querySelectorAll('#d-odd,#d-even').forEach(x=>x.style.background='#21262d'); el.style.background=getComputedStyle(document.documentElement).getPropertyValue('--accent'); }
        function diceRoll(){
            let b=+document.getElementById('d-bet').value;
            if(b>balance)return tg.showAlert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥"); if(!dP)return tg.showAlert("–í—ã–±–µ—Ä–∏ –ß–µ—Ç/–ù–µ—á–µ—Ç");
            balance-=b; updateUI(); sync();
            let r=Math.floor(Math.random()*6)+1;
            let x=(Math.random()*5+5)*360; 
            document.getElementById('cube').style.transform=`rotateX(${x}deg) rotateY(${x}deg)`;
            setTimeout(()=>{
                let w=(dP=='odd'&&r%2!=0)||(dP=='even'&&r%2==0);
                if(w) { let win=Math.floor(b*1.9); balance+=win; updateUI(); sync(); showWin(win); }
            },1500);
        }

        // 6. –û–ë–©–ï–ï
        function nav(p,el){
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.getElementById('p-'+p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
        }
        function showWin(s){
            document.getElementById('win-sum').innerText=s+" ‚ÇΩ";
            document.getElementById('modal').style.display='flex';
        }

        // –ó–ê–ü–£–°–ö
        init();
    </script>
</body>
</html>
