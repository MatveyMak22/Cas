<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Bet</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0e1015;
            --bg-card: #1c1f26;
            --primary: #00ff88;
            --primary-glow: rgba(0, 255, 136, 0.4);
            --danger: #ff3b3b;
            --text-main: #ffffff;
            --text-muted: #848d9a;
            --border: rgba(255, 255, 255, 0.08);
            --gradient: linear-gradient(135deg, #00ff88, #00b359);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* –í–∞–∂–Ω–æ: –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä—è—Ç–∞–ª—Å—è –∑–∞ –º–µ–Ω—é */
            padding-bottom: 90px;
            padding-top: 60px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ —à–∞–ø–∫—É */
            overscroll-behavior: none;
        }

        /* --- HEADER --- */
        header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 60px;
            background: rgba(14, 16, 21, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 1000;
        }
        .logo { font-weight: 800; font-size: 20px; letter-spacing: -0.5px; font-style: italic; }
        .logo span { color: var(--primary); }
        .balance-badge {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- NAVIGATION --- */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 80px; /* –£–≤–µ–ª–∏—á–∏–ª –≤—ã—Å–æ—Ç—É –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
            background: rgba(28, 31, 38, 0.9);
            backdrop-filter: blur(15px);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: 15px; /* –£—á–µ—Ç safe area iPhone */
            z-index: 1000;
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: var(--text-muted);
            font-size: 10px;
            width: 20%;
            height: 100%;
            transition: 0.2s;
        }
        .nav-btn i { font-size: 20px; margin-bottom: 2px; transition: 0.2s; }
        .nav-btn.active { color: var(--text-main); }
        .nav-btn.active i { color: var(--primary); transform: translateY(-3px); text-shadow: 0 4px 12px var(--primary-glow); }

        /* --- PAGES --- */
        .page { display: none; padding: 16px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMPONENTS --- */
        h2 { margin: 0 0 16px 0; font-size: 20px; font-weight: 700; }
        
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .btn {
            background: var(--gradient);
            color: #000;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px var(--primary-glow);
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        
        input {
            width: 100%;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            padding: 14px;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            outline: none;
            font-weight: 600;
        }
        input:focus { border-color: var(--primary); }

        /* --- MINES GAME --- */
        .mines-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        .mine-cell {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: transform 0.1s, background 0.2s;
            cursor: pointer;
        }
        .mine-cell:active { transform: scale(0.95); }
        .mine-cell.revealed { background: #252a33; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }
        .mine-cell.gem i { color: var(--primary); animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .mine-cell.boom { background: rgba(255, 59, 59, 0.2); border-color: var(--danger); }
        .mine-cell.boom i { color: var(--danger); animation: shake 0.4s; }

        @keyframes pop { 0%{transform:scale(0);} 100%{transform:scale(1);} }
        @keyframes shake { 0%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} 100%{transform:translateX(0);} }

        /* --- DICE GAME --- */
        .dice-stage {
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 800px;
            background: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 70%);
            margin-bottom: 20px;
        }
        .cube {
            width: 80px; height: 80px;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(-20deg) rotateY(-20deg);
            transition: transform 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .face {
            position: absolute;
            width: 80px; height: 80px;
            background: linear-gradient(135deg, #eee, #ccc);
            border-radius: 12px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; color: #333;
            border: 1px solid #999;
        }
        .f1 { transform: translateZ(40px); }
        .f6 { transform: rotateY(180deg) translateZ(40px); }
        .f2 { transform: rotateY(90deg) translateZ(40px); }
        .f5 { transform: rotateY(-90deg) translateZ(40px); }
        .f3 { transform: rotateX(90deg) translateZ(40px); }
        .f4 { transform: rotateX(-90deg) translateZ(40px); }

        .dice-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        .dice-opt {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            font-size: 14px;
            transition: 0.2s;
        }
        .dice-opt.selected {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* --- SPORTS TABS --- */
        .sport-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
            margin-bottom: 15px;
            scrollbar-width: none;
        }
        .sport-tabs::-webkit-scrollbar { display: none; }
        .s-tab {
            background: rgba(255,255,255,0.05);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-muted);
            white-space: nowrap;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .s-tab.active {
            background: var(--primary);
            color: #000;
            font-weight: 700;
            box-shadow: 0 2px 10px var(--primary-glow);
        }

        /* --- MATCH ITEM --- */
        .match-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 12px;
        }
        .match-item:last-child { border-bottom: none; }
        .teams-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 15px;
        }
        .live-tag {
            background: var(--danger);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 800;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.6;} 100% {opacity:1;} }
        
        .coeffs-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .coeff-box {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
        }
        .coeff-box b { display: block; color: var(--primary); font-size: 14px; margin-top: 2px; }

        /* --- BETS HISTORY --- */
        .bet-unit {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #555;
            font-size: 13px;
        }
        .bet-unit.won { border-color: var(--primary); background: linear-gradient(90deg, rgba(0,255,136,0.05), transparent); }
        .bet-unit.lost { border-color: var(--danger); }
        .bet-top { display: flex; justify-content: space-between; margin-bottom: 6px; color: #fff; font-weight: 600; }
        .bet-bot { display: flex; justify-content: space-between; color: var(--text-muted); font-size: 12px; }
        
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <div class="logo">ROYAL<span>BET</span></div>
        <div class="balance-badge">
            <span style="color:var(--primary)">‚ÇΩ</span>
            <span id="ui-bal">Loading...</span>
        </div>
    </header>

    <!-- CONTENT -->
    
    <!-- 1. SPORT -->
    <div id="p-sport" class="page active">
        <div class="sport-tabs">
            <div class="s-tab active" onclick="filter('football',this)">‚öΩ –§—É—Ç–±–æ–ª</div>
            <div class="s-tab" onclick="filter('hockey',this)">üèí –•–æ–∫–∫–µ–π</div>
            <div class="s-tab" onclick="filter('basketball',this)">üèÄ –ë–∞—Å–∫–µ—Ç</div>
            <div class="s-tab" onclick="filter('tennis',this)">üéæ –¢–µ–Ω–Ω–∏—Å</div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; font-size:14px; color:var(--text-muted); text-transform:uppercase;">–ú–∞—Ç—á–∏</h3>
            <div id="feed">
                <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç –º–∞—Ç—á–∏ -->
                <div style="text-align:center; padding:20px; color:var(--text-muted)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- 2. GAMES -->
    <div id="p-games" class="page">
        <!-- DICE CARD -->
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>Dice 3D</h2>
                <i class="fas fa-dice" style="color:var(--primary); font-size:20px;"></i>
            </div>
            
            <div class="dice-stage">
                <div class="cube" id="cube">
                    <div class="face f1">1</div>
                    <div class="face f2">6</div>
                    <div class="face f3">2</div>
                    <div class="face f4">5</div>
                    <div class="face f5">3</div>
                    <div class="face f6">4</div>
                </div>
            </div>

            <input type="number" id="d-bet" value="100" placeholder="–°—Ç–∞–≤–∫–∞">
            
            <div class="dice-controls">
                <div class="dice-opt" id="d-odd" onclick="selectDice('odd')">–ù–ï–ß–ï–¢ (1,3,5)<br><b>x1.9</b></div>
                <div class="dice-opt" id="d-even" onclick="selectDice('even')">–ß–ï–¢ (2,4,6)<br><b>x1.9</b></div>
            </div>
            
            <button class="btn" style="margin-top:15px;" onclick="Dice.roll()">–ë–†–û–°–û–ö</button>
        </div>

        <!-- MINES CARD -->
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Mines</h2>
                <i class="fas fa-bomb" style="color:var(--danger); font-size:20px;"></i>
            </div>
            
            <div class="mines-grid" id="m-grid">
                <!-- Grid JS Generated -->
            </div>

            <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:12px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:12px; color:var(--text-muted)">–¢–µ–∫—É—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å</span>
                <span id="m-kef" style="font-size:18px; font-weight:800; color:var(--primary)">x1.00</span>
            </div>

            <div id="mines-controls">
                <input type="number" id="m-bet" value="100" placeholder="–°—Ç–∞–≤–∫–∞" style="margin-bottom:10px;">
                <button id="m-btn-start" class="btn" onclick="Mines.start()">–ò–ì–†–ê–¢–¨</button>
                <button id="m-btn-cash" class="btn" onclick="Mines.cash()" style="display:none; background:#ffc107; color:#000;">–ó–ê–ë–†–ê–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- 3. BETS -->
    <div id="p-bets" class="page">
        <h2>–ú–æ–∏ —Å—Ç–∞–≤–∫–∏</h2>
        <div class="sport-tabs">
            <div class="s-tab active" onclick="renderBets('active',this)">–í –∏–≥—Ä–µ</div>
            <div class="s-tab" onclick="renderBets('history',this)">–ò—Å—Ç–æ—Ä–∏—è</div>
        </div>
        <div id="bets-list" style="padding-bottom:20px;"></div>
    </div>

    <!-- 4. PROFILE -->
    <div id="p-profile" class="page">
        <div class="card" style="text-align:center; padding:30px;">
            <div style="font-size:50px; margin-bottom:10px;">üëë</div>
            <h2 id="u-name">Guest</h2>
            <div style="color:var(--text-muted); font-size:14px; margin-bottom:20px;">ID: <span id="u-id">...</span></div>
            <div style="background:rgba(0,255,136,0.1); color:var(--primary); padding:10px; border-radius:10px; display:inline-block;">
                –ë–∞–ª–∞–Ω—Å: <span id="p-bal">...</span> ‚ÇΩ
            </div>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <div class="nav-btn active" onclick="nav('sport',this)">
            <i class="fas fa-futbol"></i>
            <span>–°–ø–æ—Ä—Ç</span>
        </div>
        <div class="nav-btn" onclick="nav('games',this)">
            <i class="fas fa-gamepad"></i>
            <span>–ò–≥—Ä—ã</span>
        </div>
        <div class="nav-btn" onclick="nav('bets',this)">
            <i class="fas fa-ticket-alt"></i>
            <span>–°—Ç–∞–≤–∫–∏</span>
        </div>
        <div class="nav-btn" onclick="nav('profile',this)">
            <i class="fas fa-user-circle"></i>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        // üëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–Æ –°–°–´–õ–ö–£ –° RENDER (–ë–ï–ó –°–õ–ï–®–ê –í –ö–û–ù–¶–ï) üëá
        const API_URL = "https://backend-4jag.onrender.com"; 

        // State
        let state = { matches: [], history: [], active: [], bal: 0 };
        let curCat = 'football';
        let curBetsTab = 'active';

        // Init Data
        const user = {
            id: tg.initDataUnsafe?.user?.id || 12345,
            username: tg.initDataUnsafe?.user?.username || "Guest",
        };

        const App = {
            init: async function() {
                tg.expand();
                tg.MainButton.color = "#00ff88";
                
                document.getElementById('u-id').innerText = user.id;
                document.getElementById('u-name').innerText = user.username;

                await this.refreshUser();
                await this.pollMatches();
                await this.loadBets();

                // Polling loops
                setInterval(() => this.pollMatches(), 10000);
                setInterval(() => this.refreshUser(), 5000);

                // Init Mines Grid
                Mines.init();
            },

            refreshUser: async function() {
                try {
                    let res = await fetch(`${API_URL}/api/init?tg_id=${user.id}&username=${user.username}`);
                    let data = await res.json();
                    state.bal = data.balance;
                    let balStr = Math.floor(state.bal).toLocaleString();
                    document.getElementById('ui-bal').innerText = balStr;
                    document.getElementById('p-bal').innerText = balStr;
                } catch(e) { console.error(e); }
            },

            pollMatches: async function() {
                try {
                    let res = await fetch(`${API_URL}/api/matches`);
                    let data = await res.json();
                    state.matches = [...data.live, ...data.upcoming];
                    if(document.getElementById('p-sport').classList.contains('active')) renderMatches();
                } catch(e) {}
            },

            loadBets: async function() {
                try {
                    let res = await fetch(`${API_URL}/api/history`, {headers: {'X-Telegram-ID': user.id.toString()}});
                    let data = await res.json();
                    state.active = data.active;
                    state.history = data.history;
                    if(document.getElementById('p-bets').classList.contains('active')) renderBets();
                } catch(e) {}
            },

            // Unified betting function
            placeBet: async function(endpoint, payload) {
                // Optimistic UI update
                if(payload.amount > 0) {
                    state.bal -= payload.amount;
                    document.getElementById('ui-bal').innerText = Math.floor(state.bal);
                }

                try {
                    let res = await fetch(`${API_URL}/api/${endpoint}`, {
                        method:'POST',
                        headers:{'Content-Type':'application/json', 'X-Telegram-ID': user.id.toString()},
                        body:JSON.stringify(payload)
                    });
                    let data = await res.json();
                    if(data.new_balance !== undefined) {
                        state.bal = data.new_balance;
                        document.getElementById('ui-bal').innerText = Math.floor(state.bal);
                    }
                    return data;
                } catch(e) {
                    tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                    return null;
                }
            }
        };

        // --- NAVIGATION ---
        function nav(pageId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('p-' + pageId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');

            if(pageId === 'bets') renderBets(curBetsTab);
        }

        // --- SPORT LOGIC ---
        function filter(cat, el) {
            curCat = cat;
            document.querySelectorAll('.s-tab').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');
            renderMatches();
        }

        function renderMatches() {
            let container = document.getElementById('feed');
            let list = state.matches.filter(m => m.sport === curCat);
            
            if(list.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:20px">–ù–µ—Ç –º–∞—Ç—á–µ–π —Å–µ–π—á–∞—Å</div>';
                return;
            }

            container.innerHTML = list.map(m => {
                let isLive = m.status === 'live';
                let time = isLive ? `<span class="live-tag">LIVE ${m.current_minute}'</span>` : 
                    new Date(m.start_time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                
                return `
                <div class="match-item">
                    <div style="font-size:12px; color:var(--text-muted); display:flex; justify-content:space-between;">
                        <span>${time}</span>
                        <span>${m.sport.toUpperCase()}</span>
                    </div>
                    <div class="teams-row">
                        <span>${m.team_home}</span>
                        <span style="color:var(--primary)">${isLive ? m.score_home + ':' + m.score_away : 'VS'}</span>
                        <span>${m.team_away}</span>
                    </div>
                    <div class="coeffs-row">
                        <div class="coeff-box" onclick="doSportBet(${m.id}, 'home', ${m.odds_home})">–ü1 <b>${m.odds_home}</b></div>
                        <div class="coeff-box" onclick="doSportBet(${m.id}, 'draw', ${m.odds_draw})">X <b>${m.odds_draw}</b></div>
                        <div class="coeff-box" onclick="doSportBet(${m.id}, 'away', ${m.odds_away})">–ü2 <b>${m.odds_away}</b></div>
                    </div>
                </div>`;
            }).join('');
        }

        function doSportBet(mid, sel, k) {
            tg.showPopup({
                title: "–°—Ç–∞–≤–∫–∞",
                message: `–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: ${k}\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É:`,
                buttons: [{id:"ok", type:"ok"}, {id:"cancel", type:"cancel"}]
            }, async (btn) => {
                // Telegram popup doesn't support input, so we use prompt (works in webview)
                // In a real full app, you build a custom UI modal
                let amount = prompt("–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏:", 100);
                if(amount && !isNaN(amount)) {
                    await App.placeBet('bet', {match_id: mid, selection: sel, amount: parseFloat(amount), coefficient: k});
                    App.loadBets();
                    tg.showAlert("–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!");
                }
            });
        }

        // --- BETS HISTORY ---
        function renderBets(type, el) {
            if(type) curBetsTab = type;
            if(el) {
                document.querySelectorAll('#p-bets .s-tab').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
            }

            let container = document.getElementById('bets-list');
            let data = curBetsTab === 'active' ? state.active : state.history;
            
            container.innerHTML = '';
            if(data.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;margin-top:20px">–ü—É—Å—Ç–æ</div>';
                return;
            }

            data.forEach(b => {
                let status = b.status === 'won' ? 'won' : (b.status === 'lost' ? 'lost' : 'wait');
                let statusLabel = b.status === 'won' ? '–í—ã–∏–≥—Ä—ã—à' : (b.status === 'lost' ? '–ü—Ä–æ–∏–≥—Ä—ã—à' : '–í –∏–≥—Ä–µ');
                let winAmount = b.status === 'won' ? `+${b.potential_win}` : (b.status === 'lost' ? `-${b.amount}` : `~${b.potential_win}`);
                
                container.innerHTML += `
                <div class="bet-unit ${status}">
                    <div class="bet-top">
                        <span>${b.team_home} vs ${b.team_away}</span>
                        <span>${statusLabel}</span>
                    </div>
                    <div class="bet-bot">
                        <span>${b.bet_selection.toUpperCase()} (x${b.coefficient}) ‚Ä¢ ${b.amount}‚ÇΩ</span>
                        <span style="color:${status==='won'?'var(--primary)':'inherit'}">${winAmount}‚ÇΩ</span>
                    </div>
                </div>`;
            });
        }

        // --- MINES LOGIC ---
        const Mines = {
            active: false, grid: [], bet: 0, mult: 1,
            init: function() {
                let el = document.getElementById('m-grid');
                el.innerHTML = '';
                for(let i=0; i<25; i++) {
                    let cell = document.createElement('div');
                    cell.className = 'mine-cell';
                    cell.onclick = () => this.click(i, cell);
                    el.appendChild(cell);
                }
            },
            start: async function() {
                let b = parseFloat(document.getElementById('m-bet').value);
                if(b > state.bal) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");
                
                // Logic
                this.bet = b; this.active = true; this.mult = 1;
                this.grid = Array(25).fill(0);
                // 3 bombs
                let placed = 0;
                while(placed < 3) {
                    let r = Math.floor(Math.random()*25);
                    if(this.grid[r] === 0) { this.grid[r] = 1; placed++; }
                }

                // Server deduction
                await App.placeBet('game', {game: 'Mines Start', amount: -b});
                
                // UI
                document.getElementById('m-kef').innerText = "x1.00";
                document.getElementById('m-btn-start').style.display = 'none';
                document.getElementById('m-btn-cash').style.display = 'block';
                document.querySelectorAll('.mine-cell').forEach(c => {
                    c.className = 'mine-cell';
                    c.innerHTML = '';
                });
            },
            click: function(idx, el) {
                if(!this.active || el.classList.contains('revealed')) return;
                
                el.classList.add('revealed');
                
                if(this.grid[idx] === 1) {
                    // BOOM
                    el.classList.add('boom');
                    el.innerHTML = '<i class="fas fa-bomb"></i>';
                    this.active = false;
                    tg.HapticFeedback.notificationOccurred('error');
                    this.end(0);
                } else {
                    // GEM
                    el.classList.add('gem');
                    el.innerHTML = '<i class="fas fa-gem"></i>';
                    this.mult *= 1.25;
                    document.getElementById('m-kef').innerText = "x" + this.mult.toFixed(2);
                    tg.HapticFeedback.impactOccurred('light');
                }
            },
            cash: async function() {
                if(!this.active) return;
                this.active = false;
                let win = Math.floor(this.bet * this.mult);
                // –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –º—ã —É–∂–µ —Å–ø–∏—Å–∞–ª–∏ —Å—Ç–∞–≤–∫—É, —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—É—é —Å—É–º–º—É –≤—ã–∏–≥—Ä—ã—à–∞
                await App.placeBet('game', {game: 'Mines Win', amount: win});
                tg.showAlert(`–í—ã –∑–∞–±—Ä–∞–ª–∏ ${win}‚ÇΩ`);
                this.end(win);
            },
            end: function(win) {
                document.getElementById('m-btn-start').style.display = 'block';
                document.getElementById('m-btn-cash').style.display = 'none';
                // Reveal all
                let cells = document.querySelectorAll('.mine-cell');
                this.grid.forEach((isBomb, i) => {
                    if(isBomb) {
                        cells[i].classList.add('revealed');
                        if(!cells[i].classList.contains('boom')) {
                            cells[i].innerHTML = '<i class="fas fa-bomb" style="opacity:0.5"></i>';
                        }
                    }
                });
            }
        };

        // --- DICE LOGIC ---
        let diceSelection = null;
        function selectDice(type) {
            diceSelection = type;
            document.querySelectorAll('.dice-opt').forEach(d => d.classList.remove('selected'));
            document.getElementById('d-'+type).classList.add('selected');
        }

        const Dice = {
            roll: async function() {
                let b = parseFloat(document.getElementById('d-bet').value);
                if(!diceSelection) return tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –ß–ï–¢ –∏–ª–∏ –ù–ï–ß–ï–¢");
                if(b > state.bal) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

                let r = Math.floor(Math.random() * 6) + 1;
                
                // Anim
                let cube = document.getElementById('cube');
                // Random rotations to make it look real
                let x = 720 + (r === 1 ? 0 : r === 2 ? -90 : r === 5 ? 90 : r === 6 ? 180 : 0); 
                // Simplified rotation logic for demo visually
                // Let's just rotate wildly then settle
                let xr = Math.floor(Math.random()*4 + 4) * 90;
                let yr = Math.floor(Math.random()*4 + 4) * 90;
                cube.style.transform = `rotateX(${xr}deg) rotateY(${yr}deg)`;

                setTimeout(async () => {
                    // Set final face
                    // It's hard to align CSS 3d exactly without complex math maps, 
                    // so for demo we rely on server result and alert. 
                    // In visual, we just let it stop somewhere.
                    
                    let isOdd = r % 2 !== 0;
                    let won = (diceSelection === 'odd' && isOdd) || (diceSelection === 'even' && !isOdd);
                    
                    let change = won ? Math.floor(b * 0.9) : -b; // Profit or Loss
                    
                    await App.placeBet('game', {game: 'Dice', amount: change});
                    
                    tg.showAlert(won ? `–í—ã–ø–∞–ª–æ ${r}. –ü–æ–±–µ–¥–∞!` : `–í—ã–ø–∞–ª–æ ${r}. –ü—Ä–æ–∏–≥—Ä—ã—à.`);
                }, 1200);
            }
        };

        // Start
        window.onload = () => App.init();

    </script>
</body>
</html>
