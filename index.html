<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Betting Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-body: #090c10;
            --bg-card: #161b22;
            --bg-nav: #0d1117;
            --accent: #238636;
            --accent-gradient: linear-gradient(135deg, #2ea043, #238636);
            --danger: #da3633;
            --text-main: #f0f6fc;
            --text-muted: #8b949e;
            --border: #30363d;
            
            --g-mines: linear-gradient(135deg, #f85149, #da3633);
            --g-dice: linear-gradient(135deg, #a371f7, #8957e5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-body);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            padding: 10px 15px;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            z-index: 100;
        }
        .bal-wrap { display: flex; flex-direction: column; }
        .bal-label { font-size: 10px; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; }
        .bal-val { font-size: 18px; font-weight: 800; color: #fff; text-shadow: 0 0 15px rgba(46, 160, 67, 0.3); }
        .btn-add { 
            background: #1f6feb; color: white; border: none; 
            padding: 8px 14px; border-radius: 10px; font-size: 12px; font-weight: bold;
            box-shadow: 0 0 10px rgba(31, 111, 235, 0.3);
        }

        /* --- MAIN SCROLL --- */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .page { display: none; animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GAMES MENU --- */
        .games-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .g-card {
            height: 120px;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.05);
            background: var(--bg-card);
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .g-card:active { transform: scale(0.98); opacity: 0.8; }
        .g-card.wide { grid-column: span 2; height: 100px; background: linear-gradient(135deg, #1f6feb, #0d4a9e); }
        .g-card.mines { background: var(--g-mines); }
        .g-card.dice { background: var(--g-dice); }
        
        .g-icon { position: absolute; top: 10px; right: 10px; font-size: 50px; opacity: 0.2; transform: rotate(-10deg); color: #fff; }
        .g-title { font-size: 16px; font-weight: 800; color: #fff; z-index: 2; margin: 0; }
        .g-sub { font-size: 11px; color: rgba(255,255,255,0.8); z-index: 2; }

        /* --- SPORT SECTION --- */
        .sport-cats {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 5px;
            scrollbar-width: none;
        }
        .cat-btn {
            background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted);
            padding: 8px 14px; border-radius: 20px; font-size: 12px; white-space: nowrap; transition: 0.2s;
        }
        .cat-btn.active { background: #fff; color: #000; border-color: #fff; font-weight: 700; }
        .cat-btn i { margin-right: 5px; }

        .match-card {
            background: var(--bg-card); border-radius: 14px; padding: 12px; margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        .match-header { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-bottom: 8px; }
        
        .live-badge { color: #f85149; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .live-dot { width: 6px; height: 6px; background: #f85149; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
        
        .upcoming-badge { color: var(--text-muted); display: flex; align-items: center; gap: 4px; }

        .teams-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .team-name { font-size: 13px; font-weight: 600; width: 40%; line-height: 1.2; }
        .match-score { font-size: 18px; font-weight: 800; color: #fff; letter-spacing: 1px; width: 20%; text-align: center;}
        
        .cf-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .cf-btn { 
            background: #21262d; border-radius: 8px; padding: 8px 4px; 
            text-align: center; font-size: 11px; color: var(--text-muted); cursor: pointer;
            border: 1px solid transparent;
        }
        .cf-btn.win { border-color: var(--accent); background: rgba(46,160,67,0.1); }
        .cf-btn b { display: block; color: var(--accent); font-size: 13px; margin-top: 2px; }

        /* --- UI CONTROLS --- */
        .control-panel { background: var(--bg-card); padding: 15px; border-radius: 16px; border: 1px solid var(--border); }
        input[type="number"], input[type="text"] {
            width: 100%; background: #090c10; border: 1px solid var(--border);
            padding: 12px; border-radius: 10px; color: white; font-size: 16px; margin-bottom: 10px;
        }
        .btn-main {
            width: 100%; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 700; border: none;
            background: var(--accent-gradient); color: white; box-shadow: 0 5px 15px rgba(35, 134, 54, 0.4);
            cursor: pointer;
        }
        .btn-main:active { transform: scale(0.98); }

        /* --- DICE 3D --- */
        .dice-stage { height: 200px; display: flex; align-items: center; justify-content: center; perspective: 800px; }
        .cube { width: 80px; height: 80px; position: relative; transform-style: preserve-3d; transition: transform 1.5s cubic-bezier(0.19, 1, 0.22, 1); }
        .face { 
            position: absolute; width: 80px; height: 80px; border: 2px solid #a371f7;
            background: radial-gradient(circle, rgba(163,113,247,0.2) 0%, #161b22 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; font-weight: bold; color: #fff; border-radius: 8px;
        }
        .f1 { transform: rotateY(0deg) translateZ(40px); } .f6 { transform: rotateY(180deg) translateZ(40px); }
        .f2 { transform: rotateY(90deg) translateZ(40px); } .f5 { transform: rotateY(-90deg) translateZ(40px); }
        .f4 { transform: rotateX(90deg) translateZ(40px); } .f3 { transform: rotateX(-90deg) translateZ(40px); }

        /* --- MINES --- */
        .mines-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 15px; }
        .cell {
            aspect-ratio: 1; background: #21262d; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 16px;
            border: 1px solid rgba(255,255,255,0.05); transition: 0.1s;
        }
        .cell.active { background: #30363d; }
        .cell.gem { background: rgba(46,160,67,0.2); border-color: #2ea043; color: #2ea043; }
        .cell.bomb { background: rgba(218,54,51,0.2); border-color: var(--danger); color: var(--danger); }

        /* --- REFERRAL CARD --- */
        .ref-card {
            background: linear-gradient(135deg, #1c2128, #161b22);
            border: 1px solid var(--border);
            border-radius: 16px; padding: 20px; text-align: center;
            margin-top: 15px;
        }
        .ref-stat { display: flex; justify-content: space-around; margin: 15px 0; }
        .rs-box { font-size: 12px; color: var(--text-muted); }
        .rs-box b { display: block; font-size: 16px; color: #fff; margin-top: 4px; }

        /* --- NAV --- */
        nav {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: var(--bg-nav); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 10px; z-index: 99;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--text-muted); font-size: 10px; width: 20%;
        }
        .nav-item i { font-size: 20px; transition: 0.2s; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active i { color: #2ea043; transform: translateY(-3px); }
    </style>
</head>
<body>

    <header>
        <div class="bal-wrap">
            <span class="bal-label">–ë–ê–õ–ê–ù–°</span>
            <span class="bal-val" id="ui-balance">50.00 ‚ÇΩ</span>
        </div>
        <button class="btn-add" onclick="App.deposit()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
    </header>

    <main>
        <!-- LOBBY -->
        <section id="p-menu" class="page active">
            <h2 style="margin-top:0">–ò–≥—Ä—ã</h2>
            <div class="games-grid">
                <div class="g-card wide" onclick="App.nav('sport')">
                    <i class="fas fa-trophy g-icon"></i>
                    <h3 class="g-title">Live –°–ø–æ—Ä—Ç</h3>
                    <span class="g-sub">–°—Ç–∞–≤–∫–∏ –Ω–∞ –º–∞—Ç—á–∏</span>
                </div>
                <div class="g-card mines" onclick="App.nav('mines')">
                    <i class="fas fa-bomb g-icon"></i>
                    <h3 class="g-title">Mines</h3>
                    <span class="g-sub">–°–∞–ø–µ—Ä –Ω–∞ –¥–µ–Ω—å–≥–∏</span>
                </div>
                <div class="g-card dice" onclick="App.nav('dice')">
                    <i class="fas fa-dice-d20 g-icon"></i>
                    <h3 class="g-title">Dice</h3>
                    <span class="g-sub">–ö—É–±–∏–∫ x1.90</span>
                </div>
            </div>

            <!-- Promo/Ref Teaser -->
            <div style="margin-top: 20px; padding: 15px; border-radius: 12px; background: rgba(31, 111, 235, 0.1); border: 1px solid rgba(31, 111, 235, 0.3); display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-weight: bold; font-size: 14px;">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞</div>
                    <div style="font-size: 11px; color: var(--text-muted);">–ü–æ–ª—É—á–∏ 50‚ÇΩ –∑–∞ –∫–∞–∂–¥–æ–≥–æ</div>
                </div>
                <button onclick="App.nav('profile')" style="background: #1f6feb; border: none; color: white; padding: 6px 12px; border-radius: 8px; font-size: 12px;">Go</button>
            </div>
        </section>

        <!-- SPORT -->
        <section id="p-sport" class="page">
            <h2 style="margin-top:0">–õ–∏–Ω–∏—è</h2>
            
            <div class="sport-cats">
                <button class="cat-btn active" onclick="Sport.filter('football', this)"><i class="fas fa-futbol"></i> –§—É—Ç–±–æ–ª</button>
                <button class="cat-btn" onclick="Sport.filter('hockey', this)"><i class="fas fa-hockey-puck"></i> –•–æ–∫–∫–µ–π</button>
                <button class="cat-btn" onclick="Sport.filter('basketball', this)"><i class="fas fa-basketball-ball"></i> –ë–∞—Å–∫–µ—Ç</button>
                <button class="cat-btn" onclick="Sport.filter('tennis', this)"><i class="fas fa-table-tennis"></i> –¢–µ–Ω–Ω–∏—Å</button>
            </div>

            <div id="sport-feed">
                <!-- JS Injects matches here -->
            </div>
        </section>

        <!-- MINES -->
        <section id="p-mines" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <i class="fas fa-chevron-left" onclick="App.nav('menu')" style="padding:10px; cursor:pointer;"></i>
                <h2>Mines</h2>
            </div>
            
            <div class="control-panel">
                <input type="number" id="m-bet" value="50" placeholder="–°—Ç–∞–≤–∫–∞">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:13px;">
                    <span>–ú–∏–Ω—ã: <b id="m-cnt-val">3</b></span>
                    <span>–ö—ç—Ñ: <b id="m-coef" style="color:var(--accent)">x1.00</b></span>
                </div>
                <input type="range" id="m-cnt" min="3" max="24" value="3" style="width:100%; margin-bottom:15px;" oninput="Mines.updInput()">
                
                <button id="m-btn" class="btn-main" onclick="Mines.start()">–ò–≥—Ä–∞—Ç—å</button>
                <button id="m-cash" class="btn-main" style="background:#d29922; display:none;" onclick="Mines.cashout()">–ó–∞–±—Ä–∞—Ç—å</button>
            </div>
            <br>
            <div class="mines-grid" id="m-grid"></div>
        </section>

        <!-- DICE -->
        <section id="p-dice" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <i class="fas fa-chevron-left" onclick="App.nav('menu')" style="padding:10px; cursor:pointer;"></i>
                <h2>Dice 3D</h2>
            </div>

            <div class="dice-stage">
                <div class="cube" id="d-cube">
                    <div class="face f1">1</div><div class="face f2">2</div><div class="face f3">3</div>
                    <div class="face f4">4</div><div class="face f5">5</div><div class="face f6">6</div>
                </div>
            </div>

            <div class="control-panel">
                <input type="number" id="d-bet" value="50" placeholder="–°—Ç–∞–≤–∫–∞">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <button class="cf-btn" id="d-even" onclick="Dice.type('even')" style="background:var(--bg-body); border:1px solid var(--border); font-size:14px; padding:12px;">
                        –ß–ï–¢ <br> <b style="color:#a371f7">x1.90</b>
                    </button>
                    <button class="cf-btn" id="d-odd" onclick="Dice.type('odd')" style="background:var(--bg-body); border:1px solid var(--border); font-size:14px; padding:12px;">
                        –ù–ï–ß–ï–¢ <br> <b style="color:#a371f7">x1.90</b>
                    </button>
                </div>
                <button class="btn-main" style="background: var(--g-dice)" onclick="Dice.roll()">–ë—Ä–æ—Å–æ–∫</button>
            </div>
        </section>

        <!-- PROFILE -->
        <section id="p-profile" class="page">
            <h2 style="margin-top:0">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            
            <div class="control-panel" style="text-align:center;">
                <div style="width:70px; height:70px; background:#21262d; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:24px;">üòé</div>
                <h3>–ò–≥—Ä–æ–∫ <span id="prof-id">#Loading</span></h3>
            </div>

            <!-- REFERRAL SYSTEM UI -->
            <div class="ref-card">
                <h3>ü§ù –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3>
                <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π <b>50‚ÇΩ</b> –∑–∞ –∫–∞–∂–¥–æ–≥–æ!</p>
                
                <div class="ref-stat">
                    <div class="rs-box">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ<b><span id="ref-count">0</span></b></div>
                    <div class="rs-box">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ<b><span id="ref-earn">0</span> ‚ÇΩ</b></div>
                </div>

                <button class="btn-main" style="font-size:14px; padding:10px;" onclick="App.shareRef()">
                    <i class="fas fa-share-alt"></i> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞
                </button>
            </div>

            <h4 style="margin-bottom:10px; margin-top:20px;">–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫</h4>
            <div id="history-list" style="font-size:12px;"></div>
        </section>
    </main>

    <nav>
        <div class="nav-item active" onclick="App.nav('menu')"><i class="fas fa-home"></i>–ú–µ–Ω—é</div>
        <div class="nav-item" onclick="App.nav('sport')"><i class="fas fa-futbol"></i>–°–ø–æ—Ä—Ç</div>
        <div class="nav-item" onclick="App.nav('profile')"><i class="fas fa-user"></i>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;

        // --- CORE APP ---
        const App = {
            userId: 0,
            bal: 50.00,
            refCount: 0,
            refEarn: 0,
            history: [],

            init: function() {
                tg.ready();
                tg.expand();
                
                // Get user from TG or Demo
                const user = tg.initDataUnsafe?.user;
                this.userId = user ? user.id : Math.floor(Math.random() * 999999);
                document.getElementById('prof-id').innerText = "#" + this.userId;

                // Load Data (Local Sim for now)
                this.load();
                
                // Init Modules
                Mines.init();
                Sport.init();

                // Check Referrals (Stub logic)
                const urlParams = new URLSearchParams(window.location.search);
                const refId = urlParams.get('start'); // Telegram passes ?start=123
                if(refId && refId != this.userId) {
                    // Logic to send to backend: "User X invited by User Y"
                    console.log("Invited by:", refId);
                }
            },

            load: function() {
                // Mock Load
                const saved = localStorage.getItem('casino_v3');
                if(saved) {
                    const d = JSON.parse(saved);
                    this.bal = d.bal;
                    this.history = d.history || [];
                    this.refCount = d.refCount || 0;
                    this.refEarn = d.refEarn || 0;
                }
                this.updateUI();
            },

            save: function() {
                localStorage.setItem('casino_v3', JSON.stringify({
                    bal: this.bal,
                    history: this.history,
                    refCount: this.refCount,
                    refEarn: this.refEarn
                }));
                this.updateUI();
            },

            updateUI: function() {
                const s = this.bal.toFixed(2) + ' ‚ÇΩ';
                document.getElementById('ui-balance').innerText = s;
                document.getElementById('ref-count').innerText = this.refCount;
                document.getElementById('ref-earn').innerText = this.refEarn;

                // History Render
                const hl = document.getElementById('history-list');
                if(this.history.length === 0) hl.innerHTML = '<div style="text-align:center; color:#555">–ü—É—Å—Ç–æ</div>';
                else {
                    hl.innerHTML = this.history.slice(0, 10).map(h => `
                        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
                            <span>${h.game}</span>
                            <span style="color:${h.win > 0 ? '#2ea043' : '#da3633'}">${h.win > 0 ? '+' + h.win : h.win}</span>
                        </div>
                    `).join('');
                }
            },

            addHist: function(game, win) {
                this.history.unshift({ game, win });
                this.save();
            },

            nav: function(p) {
                document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
                document.getElementById('p-' + p).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                if(p === 'menu' || p.startsWith('mines') || p.startsWith('dice')) document.querySelectorAll('.nav-item')[0].classList.add('active');
                if(p === 'sport') document.querySelectorAll('.nav-item')[1].classList.add('active');
                if(p === 'profile') document.querySelectorAll('.nav-item')[2].classList.add('active');
            },

            shareRef: function() {
                const link = `https://t.me/share/url?url=https://t.me/YOUR_BOT_NAME?start=${this.userId}&text=–ó–∞–±–∏—Ä–∞–π+50‚ÇΩ+–±–æ–Ω—É—Å–∞+–≤+–∫–∞–∑–∏–Ω–æ!`;
                tg.openTelegramLink(link);
            },

            deposit: function() {
                tg.showPopup({ title: '–ö–∞—Å—Å–∞', message: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)' });
            }
        };

        // --- SPORT ENGINE (SMART SCHEDULE) ---
        const Sport = {
            matches: [],
            curCat: 'football',
            
            // Expanded Team List
            teams: {
                football: ['Real Madrid', 'Barcelona', 'Man City', 'Liverpool', 'PSG', 'Bayern', 'Juventus', 'Milan', 'Arsenal', 'Chelsea'],
                hockey: ['–°–ö–ê', '–¶–°–ö–ê', '–ê–∫ –ë–∞—Ä—Å', '–ê–≤–∞–Ω–≥–∞—Ä–¥', '–î–∏–Ω–∞–º–æ –ú', '–°–ø–∞—Ä—Ç–∞–∫', '–ú–µ—Ç–∞–ª–ª—É—Ä–≥', '–°–∞–ª–∞–≤–∞—Ç –Æ–ª–∞–µ–≤', '–¢—Ä–∞–∫—Ç–æ—Ä', '–õ–æ–∫–æ–º–æ—Ç–∏–≤'],
                basketball: ['Lakers', 'Bulls', 'Celtics', 'Heat', 'Warriors', 'Nets', 'CSKA Basket', 'Real Madrid Basket', 'Anadolu Efes', 'Barcelona Basket'],
                tennis: ['Djokovic', 'Alcaraz', 'Medvedev', 'Sinner', 'Rublev', 'Nadal', 'Tsitsipas', 'Zverev', 'Rune', 'Hurkacz']
            },

            init: function() {
                this.generateSchedule();
                this.render();
                // Ticker for LIVE matches only
                setInterval(() => this.tick(), 2000); 
            },

            generateSchedule: function() {
                this.matches = [];
                const categories = ['football', 'hockey', 'basketball', 'tennis'];
                
                categories.forEach(cat => {
                    const catTeams = [...this.teams[cat]];
                    // Shuffle teams
                    catTeams.sort(() => Math.random() - 0.5);

                    // 1. Create 1-2 LIVE matches
                    const liveCount = Math.floor(Math.random() * 2) + 1; 
                    for(let i=0; i<liveCount; i++) {
                        if(catTeams.length < 2) break;
                        this.matches.push({
                            id: Math.random(),
                            cat: cat,
                            t1: catTeams.pop(),
                            t2: catTeams.pop(),
                            isLive: true,
                            time: Math.floor(Math.random() * 60) + 10, // 10-70 mins
                            s1: Math.floor(Math.random() * (cat === 'basketball' ? 80 : 3)),
                            s2: Math.floor(Math.random() * (cat === 'basketball' ? 80 : 3)),
                            k: [this.randK(), this.randK(), this.randK()]
                        });
                    }

                    // 2. Create 3-4 SCHEDULED matches (Today/Tomorrow)
                    const futureCount = 3;
                    for(let i=0; i<futureCount; i++) {
                        if(catTeams.length < 2) break;
                        const hour = Math.floor(Math.random() * 10) + 12; // 12:00 - 22:00
                        const min = Math.random() > 0.5 ? '00' : '30';
                        const isTomorrow = Math.random() > 0.7;
                        
                        this.matches.push({
                            id: Math.random(),
                            cat: cat,
                            t1: catTeams.pop(),
                            t2: catTeams.pop(),
                            isLive: false,
                            dateStr: (isTomorrow ? '–ó–∞–≤—Ç—Ä–∞' : '–°–µ–≥–æ–¥–Ω—è') + ` ${hour}:${min}`,
                            s1: 0, s2: 0,
                            k: [this.randK(), this.randK(), this.randK()]
                        });
                    }
                });
            },

            randK: function() { return (Math.random() * 3 + 1.1).toFixed(2); },

            tick: function() {
                let updated = false;
                this.matches.forEach(m => {
                    if(m.isLive) {
                        updated = true;
                        m.time++; // Increase minute
                        
                        // Scoring Logic per Sport
                        if(Math.random() < 0.15) { // Chance to score
                            const team = Math.random() > 0.5 ? 1 : 2;
                            if(m.cat === 'basketball') {
                                // Basketball: +2 or +3 points
                                const points = Math.random() > 0.65 ? 3 : 2;
                                team === 1 ? m.s1 += points : m.s2 += points;
                            } else if (m.cat === 'tennis') {
                                // Simplified tennis (Game score)
                                // Not implemented fully to avoid complex set logic in one file
                                team === 1 ? m.s1++ : m.s2++;
                            } else {
                                // Football/Hockey: +1
                                team === 1 ? m.s1++ : m.s2++;
                            }
                        }
                    }
                });
                if(updated && document.getElementById('p-sport').classList.contains('active')) {
                    this.render();
                }
            },

            filter: function(cat, btn) {
                this.curCat = cat;
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.render();
            },

            render: function() {
                const container = document.getElementById('sport-feed');
                // Filter by category
                const list = this.matches.filter(m => m.cat === this.curCat);
                // Sort: Live first
                list.sort((a, b) => (a.isLive === b.isLive) ? 0 : a.isLive ? -1 : 1);

                container.innerHTML = list.map(m => `
                    <div class="match-card">
                        <div class="match-header">
                            ${m.isLive 
                                ? `<span class="live-badge"><span class="live-dot"></span>LIVE</span> <span>${m.time}' –º–∏–Ω</span>` 
                                : `<span class="upcoming-badge"><i class="far fa-clock"></i> ${m.dateStr}</span> <span>–ù–µ –Ω–∞—á–∞–ª—Å—è</span>`
                            }
                        </div>
                        <div class="teams-row">
                            <span class="team-name">${m.t1}</span>
                            <span class="match-score">${m.s1} : ${m.s2}</span>
                            <span class="team-name" style="text-align:right">${m.t2}</span>
                        </div>
                        <div class="cf-grid">
                            <div class="cf-btn" onclick="Sport.bet(${m.id}, 'p1', ${m.k[0]})">–ü1 <b>${m.k[0]}</b></div>
                            <div class="cf-btn" onclick="Sport.bet(${m.id}, 'x', ${m.k[1]})">X <b>${m.k[1]}</b></div>
                            <div class="cf-btn" onclick="Sport.bet(${m.id}, 'p2', ${m.k[2]})">–ü2 <b>${m.k[2]}</b></div>
                        </div>
                    </div>
                `).join('');
            },

            bet: function(id, type, coef) {
                if(App.bal < 50) return tg.showAlert('–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞ 50‚ÇΩ');
                App.bal -= 50;
                App.addHist('Sport Bet', -50);
                tg.showAlert(`–°—Ç–∞–≤–∫–∞ 50‚ÇΩ –ø—Ä–∏–Ω—è—Ç–∞! (–ö—ç—Ñ x${coef})`);
            }
        };

        // --- MINES LOGIC ---
        const Mines = {
            active: false, grid: [], bet: 0,
            init: function() {
                const g = document.getElementById('m-grid'); g.innerHTML = '';
                for(let i=0; i<25; i++) {
                    let d = document.createElement('div'); d.className = 'cell'; d.onclick = () => this.click(i, d);
                    g.appendChild(d);
                }
            },
            updInput: function() { document.getElementById('m-cnt-val').innerText = document.getElementById('m-cnt').value; },
            start: function() {
                const bet = parseFloat(document.getElementById('m-bet').value);
                if(bet > App.bal) return tg.showAlert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥');
                if(isNaN(bet) || bet < 1) return;
                
                App.bal -= bet; App.save();
                this.bet = bet;
                this.mines = parseInt(document.getElementById('m-cnt').value);
                this.active = true;
                this.grid = Array(25).fill(0);
                
                let c = 0;
                while(c < this.mines) { let r = Math.floor(Math.random()*25); if(this.grid[r]===0) { this.grid[r]=1; c++; } }
                
                document.getElementById('m-btn').style.display='none';
                document.getElementById('m-cash').style.display='block';
                document.querySelectorAll('.cell').forEach(c => { c.className='cell'; c.innerHTML=''; });
                this.step = 0;
            },
            click: function(idx, el) {
                if(!this.active || el.classList.contains('active')) return;
                el.classList.add('active');
                if(this.grid[idx] === 1) {
                    el.classList.add('bomb'); el.innerHTML = '<i class="fas fa-bomb"></i>';
                    this.end(false);
                } else {
                    el.classList.add('gem'); el.innerHTML = '<i class="fas fa-gem"></i>';
                    this.step++;
                    let safe = 25 - this.mines;
                    let mult = (25 - (this.step-1)) / (safe - (this.step - 1));
                    this.currWin = (this.bet * Math.pow(mult * 0.98, this.step));
                    document.getElementById('m-cash').innerText = `–ó–∞–±—Ä–∞—Ç—å ${this.currWin.toFixed(0)} ‚ÇΩ`;
                }
            },
            cashout: function() {
                if(!this.active) return;
                App.bal += this.currWin;
                App.addHist('Mines', this.currWin.toFixed(2));
                this.end(true);
            },
            end: function(win) {
                this.active = false;
                document.getElementById('m-btn').style.display='block';
                document.getElementById('m-cash').style.display='none';
                if(!win) App.addHist('Mines', -this.bet);
                document.querySelectorAll('.cell').forEach((c, i) => {
                    if(this.grid[i]===1) { c.innerHTML = '<i class="fas fa-bomb"></i>'; if(!c.classList.contains('bomb')) c.style.opacity = 0.5; }
                });
            }
        };

        // --- DICE LOGIC ---
        const Dice = {
            sel: null,
            type: function(t) { 
                this.sel = t; 
                document.getElementById('d-even').style.borderColor = t==='even'?'#a371f7':'var(--border)'; 
                document.getElementById('d-odd').style.borderColor = t==='odd'?'#a371f7':'var(--border)'; 
            },
            roll: function() {
                const bet = parseFloat(document.getElementById('d-bet').value);
                if(!this.sel) return tg.showAlert('–ß–µ—Ç –∏–ª–∏ –ù–µ—á–µ—Ç?');
                if(bet > App.bal) return tg.showAlert('–ú–∞–ª–æ –¥–µ–Ω–µ–≥');
                
                App.bal -= bet; App.save();
                
                const cube = document.getElementById('d-cube');
                const res = Math.floor(Math.random() * 6) + 1;
                const map = { 1:[0,0], 6:[0,180], 2:[0,-90], 5:[0,90], 3:[-90,0], 4:[90,0] };
                const ang = map[res];
                
                // Add lots of rotation
                const x = ang[0] + (360 * 5);
                const y = ang[1] + (360 * 5);
                cube.style.transform = `rotateX(${x}deg) rotateY(${y}deg)`;

                setTimeout(() => {
                    const isEven = res % 2 === 0;
                    const win = ((this.sel === 'even' && isEven) || (this.sel === 'odd' && !isEven));
                    
                    if(win) {
                        const amount = bet * 1.9;
                        App.bal += amount;
                        App.addHist('Dice', amount.toFixed(2));
                        tg.showAlert(`–í—ã–ø–∞–ª–æ ${res}. –ü–æ–±–µ–¥–∞! +${amount.toFixed(0)}`);
                    } else {
                        App.addHist('Dice', -bet);
                        tg.showAlert(`–í—ã–ø–∞–ª–æ ${res}. –õ—É–∑.`);
                    }
                }, 1600);
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
