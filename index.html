<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Bet üéÆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å —Ç–µ –∂–µ, –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –º–∞—Ç—á–∞ */
        :root {
            --bg-primary: #0e1015;
            --bg-secondary: #15181f;
            --bg-tertiary: #1c1f2a;
            --accent-green: #00ff88;
            --accent-blue: #00a8ff;
            --accent-red: #ff4757;
            --text-primary: #ffffff;
            --text-secondary: #8c94a3;
            --border-color: #2a2f3d;
            --radius-md: 12px;
        }
        body { margin: 0; padding: 0; font-family: sans-serif; background: var(--bg-primary); color: var(--text-primary); padding-bottom: 80px; }
        .container { padding: 16px; max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border-color); }
        .balance-display { background: var(--bg-tertiary); padding: 8px 16px; border-radius: 20px; color: var(--accent-green); font-weight: bold; }
        
        .card { background: var(--bg-secondary); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; border: 1px solid var(--border-color); }
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin-top: 8px; }
        .btn-primary { background: var(--accent-green); color: #000; }
        .btn-secondary { background: var(--bg-tertiary); color: #fff; border: 1px solid var(--border-color); }
        
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid var(--border-color); }
        .nav-item { color: var(--text-secondary); text-decoration: none; font-size: 12px; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--accent-green); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        .hidden { display: none !important; }

        /* Mines Styles */
        .mines-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 20px 0; }
        .mine-cell { aspect-ratio: 1; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; border: 2px solid transparent; }
        .mine-cell.revealed { background: #2d3446; }
        .mine-cell.safe { background: var(--accent-green); color: #000; }
        .mine-cell.boom { background: var(--accent-red); color: #fff; }
        
        /* Match Details Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-secondary); width: 90%; max-width: 500px; padding: 20px; border-radius: 16px; max-height: 80vh; overflow-y: auto; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid var(--bg-tertiary); padding-bottom: 8px; }
        .detail-odds { color: var(--accent-green); font-weight: bold; }

        .match-card { position: relative; }
        .match-teams { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .match-odds { display: flex; gap: 8px; }
        .odds-btn { flex: 1; background: var(--bg-tertiary); padding: 8px; border-radius: 6px; text-align: center; font-size: 14px; }
        
        .notif { position: fixed; top: 20px; right: 20px; background: var(--bg-tertiary); padding: 12px; border-radius: 8px; border-left: 4px solid var(--accent-green); z-index: 2000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div id="notifContainer"></div>

<div class="container">
    <div class="header">
        <div style="font-weight: bold; font-size: 20px;">Royal Bet</div>
        <div class="balance-display" id="userBalance">0.00 ‚ÇΩ</div>
    </div>

    <!-- Sports Tab -->
    <div id="sportsSection" class="tab-content">
        <h2>–°–ø–æ—Ä—Ç Live & Pre-match</h2>
        <div id="matchesContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- Games Tab -->
    <div id="gamesSection" class="tab-content hidden">
        <h2>Mines</h2>
        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>–°—Ç–∞–≤–∫–∞: <input type="number" id="minesAmount" value="100" style="width: 60px;"> ‚ÇΩ</span>
                <span>–ú–∏–Ω—ã: <select id="minesCount"><option value="3">3</option><option value="5">5</option><option value="10">10</option></select></span>
            </div>
            <div style="text-align: center; margin-bottom: 10px; font-size: 18px;">
                –ú–Ω–æ–∂–∏—Ç–µ–ª—å: <span id="minesMult" style="color: var(--accent-green)">1.00x</span>
            </div>
            <div class="mines-grid" id="minesGrid"></div>
            <button class="btn btn-primary" id="minesActionBtn">–ò–≥—Ä–∞—Ç—å</button>
        </div>
        
        <h2>–î—Ä—É–≥–∏–µ –∏–≥—Ä—ã</h2>
        <div class="card" onclick="alert('Dice –∏ Crash –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ø–æ–ª–Ω–æ–º –º–µ–Ω—é')">
            Dice & Crash (–ù–∞–∂–º–∏)
        </div>
    </div>

    <!-- Profile Tab -->
    <div id="profileSection" class="tab-content hidden">
        <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
        <p>ID: <span id="userId">...</span></p>
        <p>–ò–º—è: <span id="userName">...</span></p>
        <h3>–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫</h3>
        <div id="historyContainer"></div>
    </div>
</div>

<nav class="nav">
    <a href="#" class="nav-item active" onclick="switchTab('sports', this)"><i class="fas fa-futbol"></i>–°–ø–æ—Ä—Ç</a>
    <a href="#" class="nav-item" onclick="switchTab('games', this)"><i class="fas fa-gamepad"></i>–ò–≥—Ä—ã</a>
    <a href="#" class="nav-item" onclick="switchTab('profile', this)"><i class="fas fa-user"></i>–ü—Ä–æ—Ñ–∏–ª—å</a>
</nav>

<!-- Modal for Match Details -->
<div id="detailModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <h3 id="modalTitle">–ú–∞—Ç—á</h3>
            <span onclick="closeModal()" style="font-size: 24px; cursor: pointer;">&times;</span>
        </div>
        <div id="modalBody"></div>
        <button class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
    // Config
    const API_URL = 'https://backend-4jag.onrender.com'; // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL
    let currentUser = null;
    let currentMinesGameId = null;
    let minesActive = false;
    let revealedCells = 0;

    // 1. Init
    window.onload = async function() {
        if(window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }
        await auth();
    };

    async function auth() {
        // –û–ß–ï–ù–¨ –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º initData —Å—Ç—Ä–æ–∫—É —Ü–µ–ª–∏–∫–æ–º
        const initData = window.Telegram?.WebApp?.initData || 'mock';
        
        try {
            const res = await fetch(`${API_URL}/api/init`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ initData: initData })
            });
            const data = await res.json();
            if(data.success) {
                currentUser = data.user;
                updateUI();
                loadMatches();
            }
        } catch(e) { console.error(e); }
    }

    function updateUI() {
        if(!currentUser) return;
        document.getElementById('userBalance').textContent = currentUser.balance.toFixed(2) + ' ‚ÇΩ';
        document.getElementById('userId').textContent = currentUser.id;
        document.getElementById('userName').textContent = currentUser.username;
    }

    // 2. Matches
    async function loadMatches() {
        const res = await fetch(`${API_URL}/api/matches`);
        const data = await res.json();
        const container = document.getElementById('matchesContainer');
        container.innerHTML = '';
        
        data.matches.forEach(m => {
            const el = document.createElement('div');
            el.className = 'card match-card';
            el.innerHTML = `
                <div style="font-size: 12px; color: #888; margin-bottom: 4px;">${m.sport.toUpperCase()} ‚Ä¢ ${m.status === 'live' ? 'üî¥ LIVE ' + m.period : m.start_time.slice(0,10)}</div>
                <div class="match-teams">
                    <span>${m.team_home}</span>
                    <span style="color: var(--accent-green); font-weight: bold;">${m.score_home} : ${m.score_away}</span>
                    <span>${m.team_away}</span>
                </div>
                <div class="match-odds">
                    <div class="odds-btn" onclick="placeBet(${m.id}, 'home', ${m.odds_home})">–ü1<br><b>${m.odds_home}</b></div>
                    <div class="odds-btn" onclick="placeBet(${m.id}, 'draw', ${m.odds_draw})">X<br><b>${m.odds_draw || '-'}</b></div>
                    <div class="odds-btn" onclick="placeBet(${m.id}, 'away', ${m.odds_away})">–ü2<br><b>${m.odds_away}</b></div>
                </div>
                <button class="btn btn-secondary" onclick='openDetails(${JSON.stringify(m)})' style="margin-top: 8px; font-size: 12px; padding: 8px;">
                    <i class="fas fa-chart-bar"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ / –î–æ–ø. —Å—Ç–∞–≤–∫–∏
                </button>
            `;
            container.appendChild(el);
        });
    }

    // 3. Match Details Modal
    function openDetails(match) {
        document.getElementById('modalTitle').textContent = `${match.team_home} vs ${match.team_away}`;
        const body = document.getElementById('modalBody');
        
        const d = match.details || {};
        
        let html = `
            <div style="text-align: center; margin-bottom: 16px; font-size: 18px; font-weight: bold;">
                ${match.score_home} : ${match.score_away}
            </div>
            <div class="detail-row"><span>–¢–æ—Ç–∞–ª –ë–æ–ª—å—à–µ (${d.total_val})</span> <span class="detail-odds">${d.total_over}</span></div>
            <div class="detail-row"><span>–¢–æ—Ç–∞–ª –ú–µ–Ω—å—à–µ (${d.total_val})</span> <span class="detail-odds">${d.total_under}</span></div>
            <div class="detail-row"><span>–§–æ—Ä–∞ 1 (${d.handicap_val})</span> <span class="detail-odds">${d.handicap1}</span></div>
            <div class="detail-row"><span>–§–æ—Ä–∞ 2 (${Math.abs(d.handicap_val)})</span> <span class="detail-odds">${d.handicap2}</span></div>
            <div class="detail-row"><span>–û–±–µ –∑–∞–±—å—é—Ç (–î–∞)</span> <span class="detail-odds">${d.both_score_yes}</span></div>
            <div class="detail-row"><span>–û–±–µ –∑–∞–±—å—é—Ç (–ù–µ—Ç)</span> <span class="detail-odds">${d.both_score_no}</span></div>
            <p style="text-align: center; color: #666; font-size: 12px; margin-top: 20px;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–µ–Ω—é, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –±—ã—Å—Ç—Ä—É—é —Å—Ç–∞–≤–∫—É.</p>
        `;
        
        body.innerHTML = html;
        document.getElementById('detailModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('detailModal').classList.add('hidden');
    }

    async function placeBet(matchId, outcome, odds) {
        if(!confirm(`–ü–æ—Å—Ç–∞–≤–∏—Ç—å 100‚ÇΩ –Ω–∞ –∫–æ—ç—Ñ ${odds}?`)) return;
        
        const res = await fetch(`${API_URL}/api/bet`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                user_id: currentUser.id,
                match_id: matchId,
                game_type: 'sport',
                amount: 100,
                odds: odds,
                outcome: outcome
            })
        });
        const d = await res.json();
        if(d.success) {
            showNotif('–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!');
            currentUser.balance = d.new_balance;
            updateUI();
        } else {
            showNotif(d.message, true);
        }
    }

    // 4. Mines Logic (Fixed)
    const minesGrid = document.getElementById('minesGrid');
    const minesBtn = document.getElementById('minesActionBtn');

    // Init Grid UI
    function renderMinesGrid() {
        minesGrid.innerHTML = '';
        for(let i=0; i<25; i++) {
            const cell = document.createElement('div');
            cell.className = 'mine-cell';
            cell.dataset.idx = i;
            cell.onclick = () => onCellClick(i);
            minesGrid.appendChild(cell);
        }
    }
    renderMinesGrid();

    minesBtn.onclick = async () => {
        if(!minesActive) {
            // Start Game
            const amount = parseFloat(document.getElementById('minesAmount').value);
            const mines = parseInt(document.getElementById('minesCount').value);
            
            const res = await fetch(`${API_URL}/api/mines/start`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: currentUser.id,
                    amount: amount,
                    mines_count: mines
                })
            });
            const d = await res.json();
            
            if(d.success) {
                currentMinesGameId = d.game_id;
                minesActive = true;
                revealedCells = 0;
                currentUser.balance = d.new_balance;
                updateUI();
                renderMinesGrid(); // Reset grid
                minesBtn.textContent = "–ó–∞–±—Ä–∞—Ç—å (80%)"; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—Ç
                minesBtn.classList.remove('btn-primary');
                minesBtn.classList.add('btn-secondary');
                document.getElementById('minesMult').textContent = "1.00x";
            } else {
                showNotif(d.message, true);
            }
        } else {
            // Cashout
            const res = await fetch(`${API_URL}/api/mines/cashout`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: currentUser.id,
                    game_id: currentMinesGameId
                })
            });
            const d = await res.json();
            if(d.success) {
                minesActive = false;
                currentUser.balance = d.new_balance;
                updateUI();
                minesBtn.textContent = "–ò–≥—Ä–∞—Ç—å";
                minesBtn.classList.add('btn-primary');
                minesBtn.classList.remove('btn-secondary');
                
                if(revealedCells === 0) showNotif(`–í–æ–∑–≤—Ä–∞—Ç: ${d.win_amount}‚ÇΩ`);
                else showNotif(`–í—ã–∏–≥—Ä—ã—à: ${d.win_amount}‚ÇΩ`);
                
                // Show full grid (optional, need backend support or just reset)
                setTimeout(renderMinesGrid, 2000);
            }
        }
    };

    async function onCellClick(idx) {
        if(!minesActive) return;
        
        // Optimistic UI check (prevent double click)
        const cell = minesGrid.children[idx];
        if(cell.classList.contains('revealed')) return;

        const res = await fetch(`${API_URL}/api/mines/reveal`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                game_id: currentMinesGameId,
                cell_index: idx
            })
        });
        const d = await res.json();
        
        if(d.success) {
            cell.classList.add('revealed');
            
            if(d.status === 'boom') {
                // Lose
                cell.classList.add('boom');
                cell.innerHTML = 'üí£';
                minesActive = false;
                minesBtn.textContent = "–ò–≥—Ä–∞—Ç—å";
                minesBtn.classList.add('btn-primary');
                showNotif('–í–∑—Ä—ã–≤! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏', true);
                
                // Show other mines
                d.field.forEach((isMine, i) => {
                    if(isMine) {
                        minesGrid.children[i].classList.add('revealed', 'boom');
                        minesGrid.children[i].innerHTML = 'üí£';
                    }
                });
            } else {
                // Safe
                cell.classList.add('safe');
                cell.innerHTML = 'üíé';
                revealedCells++;
                document.getElementById('minesMult').textContent = d.multiplier + "x";
                minesBtn.textContent = `–ó–∞–±—Ä–∞—Ç—å ${d.potential_win.toFixed(0)}‚ÇΩ`;
                minesBtn.classList.add('btn-primary'); // Make green
            }
        }
    }

    // Tabs
    function switchTab(tab, el) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.add('hidden'));
        document.getElementById(tab + 'Section').classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        
        if(tab === 'profile') loadHistory();
    }

    async function loadHistory() {
        const res = await fetch(`${API_URL}/api/history?user_id=${currentUser.id}`);
        const d = await res.json();
        const c = document.getElementById('historyContainer');
        c.innerHTML = d.history.map(h => `
            <div style="background:var(--bg-tertiary); padding:10px; margin-bottom:8px; border-radius:8px; border-left:4px solid ${h.status==='won'?'#0f0':'#f00'}">
                <div>${h.game_type.toUpperCase()} | ${h.amount}‚ÇΩ</div>
                <div style="font-size:12px; color:#888">${h.status} (${h.odds}x)</div>
            </div>
        `).join('');
    }

    function showNotif(msg, isErr=false) {
        const d = document.createElement('div');
        d.className = 'notif';
        if(isErr) d.style.borderLeftColor = 'red';
        d.textContent = msg;
        document.getElementById('notifContainer').appendChild(d);
        setTimeout(() => d.remove(), 3000);
    }
</script>
</body>
</html>
