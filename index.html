<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Betting Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-body: #090c10;
            --bg-card: #161b22;
            --bg-nav: #0d1117;
            --accent: #238636;
            --accent-gradient: linear-gradient(135deg, #2ea043, #238636);
            --danger: #da3633;
            --text-main: #f0f6fc;
            --text-muted: #8b949e;
            --border: #30363d;
            
            --g-mines: linear-gradient(135deg, #f85149, #da3633);
            --g-dice: linear-gradient(135deg, #a371f7, #8957e5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-body);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- LAYOUT & HEADER --- */
        header {
            padding: 10px 15px;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            z-index: 100;
        }
        .bal-wrap { display: flex; flex-direction: column; }
        .bal-label { font-size: 10px; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; }
        .bal-val { font-size: 18px; font-weight: 800; color: #fff; text-shadow: 0 0 15px rgba(46, 160, 67, 0.3); }
        .btn-add { 
            background: #1f6feb; color: white; border: none; 
            padding: 8px 14px; border-radius: 10px; font-size: 12px; font-weight: bold;
        }

        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GAMES MENU --- */
        .games-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .g-card {
            height: 120px; border-radius: 16px; position: relative; overflow: hidden; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.05); background: var(--bg-card); padding: 15px;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        .g-card:active { transform: scale(0.98); opacity: 0.8; }
        .g-card.wide { grid-column: span 2; height: 100px; background: linear-gradient(135deg, #1f6feb, #0d4a9e); }
        .g-card.mines { background: var(--g-mines); }
        .g-card.dice { background: var(--g-dice); }
        .g-icon { position: absolute; top: 10px; right: 10px; font-size: 50px; opacity: 0.2; transform: rotate(-10deg); color: #fff; }
        .g-title { font-size: 16px; font-weight: 800; color: #fff; z-index: 2; margin: 0; }
        .g-sub { font-size: 11px; color: rgba(255,255,255,0.8); z-index: 2; }

        /* --- SPORT LIST --- */
        .sport-cats { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 5px; scrollbar-width: none; }
        .cat-btn { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-muted); padding: 8px 14px; border-radius: 20px; font-size: 12px; white-space: nowrap; transition: 0.2s; }
        .cat-btn.active { background: #fff; color: #000; border-color: #fff; font-weight: 700; }
        
        .match-card {
            background: var(--bg-card); border-radius: 14px; padding: 12px; margin-bottom: 10px;
            border: 1px solid var(--border); cursor: pointer; transition: 0.2s;
        }
        .match-card:active { background: #1c2128; }
        .match-header { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }
        .live-badge { color: #f85149; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .live-dot { width: 6px; height: 6px; background: #f85149; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        .teams-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .team-name { font-size: 14px; font-weight: 600; width: 40%; line-height: 1.2; }
        .match-score { font-size: 18px; font-weight: 800; color: #fff; letter-spacing: 1px; width: 20%; text-align: center;}

        .cf-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .cf-btn { 
            background: #21262d; border-radius: 8px; padding: 8px 4px; text-align: center; font-size: 11px; color: var(--text-muted); 
            border: 1px solid transparent; z-index: 2; /* Ensure clickable above card link */
        }
        .cf-btn:active { background: rgba(255,255,255,0.05); }
        .cf-btn b { display: block; color: var(--accent); font-size: 13px; margin-top: 2px; }

        /* --- MATCH DETAIL VIEW --- */
        #p-match-detail { padding: 0; height: 100%; display: none; }
        #p-match-detail.active { display: flex; flex-direction: column; }
        
        .match-hero {
            background: linear-gradient(to bottom, #1f6feb, #090c10);
            padding: 20px; text-align: center;
            border-bottom: 1px solid var(--border);
        }
        .hero-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { background: rgba(0,0,0,0.3); border: none; color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; cursor: pointer; }
        
        .scoreboard { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sb-team { width: 35%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .team-logo { 
            width: 60px; height: 60px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .sb-score { font-size: 36px; font-weight: 900; color: white; text-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .sb-meta { color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 5px; }

        /* Tennis Specific Table */
        .tennis-sets {
            width: 100%; border-collapse: separate; border-spacing: 2px; margin-top: 15px;
        }
        .tennis-sets th { font-size: 10px; color: rgba(255,255,255,0.6); padding: 5px; text-align: center; }
        .tennis-sets td { background: rgba(255,255,255,0.05); padding: 10px; text-align: center; color: white; font-weight: bold; border-radius: 4px; }
        .tennis-sets .team-label { text-align: left; padding-left: 10px; display: flex; align-items: center; gap: 8px; width: 40%; font-size: 12px; }
        .tennis-sets .current-set { background: rgba(31, 111, 235, 0.2); border: 1px solid #1f6feb; }
        .tennis-logo-mini { width: 20px; height: 20px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 5px; }

        .bet-sheet { padding: 20px; background: var(--bg-body); flex: 1; }

        /* --- UI CONTROLS --- */
        .control-panel { background: var(--bg-card); padding: 15px; border-radius: 16px; border: 1px solid var(--border); }
        input[type="number"], input[type="range"] { width: 100%; background: #090c10; border: 1px solid var(--border); padding: 12px; border-radius: 10px; color: white; font-size: 16px; margin-bottom: 10px; }
        .btn-main { width: 100%; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 700; border: none; background: var(--accent-gradient); color: white; }

        /* --- NAV --- */
        nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: var(--bg-nav); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; padding-bottom: 10px; z-index: 99; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); font-size: 10px; width: 20%; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active i { color: #2ea043; transform: translateY(-3px); }

        /* --- GAMES STYLES --- */
        .dice-stage { height: 200px; display: flex; align-items: center; justify-content: center; perspective: 800px; }
        .cube { width: 80px; height: 80px; position: relative; transform-style: preserve-3d; transition: transform 1.5s; }
        .face { position: absolute; width: 80px; height: 80px; border: 2px solid #a371f7; background: radial-gradient(circle, rgba(163,113,247,0.2), #161b22); display: flex; align-items: center; justify-content: center; font-size: 30px; color: #fff; }
        .f1 { transform: rotateY(0deg) translateZ(40px); } .f6 { transform: rotateY(180deg) translateZ(40px); }
        .f2 { transform: rotateY(90deg) translateZ(40px); } .f5 { transform: rotateY(-90deg) translateZ(40px); }
        .f4 { transform: rotateX(90deg) translateZ(40px); } .f3 { transform: rotateX(-90deg) translateZ(40px); }
        .mines-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .cell { aspect-ratio: 1; background: #21262d; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .cell.gem { background: rgba(46,160,67,0.2); border-color: #2ea043; color: #2ea043; }
        .cell.bomb { background: rgba(218,54,51,0.2); border-color: var(--danger); color: var(--danger); }
        
        /* Referral Card */
        .ref-card { background: linear-gradient(135deg, #1c2128, #161b22); border: 1px solid var(--border); border-radius: 16px; padding: 20px; text-align: center; margin-top: 15px; }
        .ref-stat { display: flex; justify-content: space-around; margin: 15px 0; }
        .rs-box { font-size: 12px; color: var(--text-muted); }
        .rs-box b { display: block; font-size: 16px; color: #fff; margin-top: 4px; }
    </style>
</head>
<body>

    <header id="main-header">
        <div class="bal-wrap">
            <span class="bal-label">–ë–ê–õ–ê–ù–°</span>
            <span class="bal-val" id="ui-balance">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
        <button class="btn-add" onclick="App.deposit()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
    </header>

    <main>
        <!-- MATCH DETAIL OVERLAY -->
        <section id="p-match-detail">
            <div class="match-hero">
                <div class="hero-top">
                    <button class="back-btn" onclick="App.nav('sport')"><i class="fas fa-chevron-left"></i> –ù–∞–∑–∞–¥</button>
                    <span id="md-league" style="font-size: 12px; color: rgba(255,255,255,0.7); text-transform: uppercase;">LEAGUE</span>
                    <div style="width: 60px;"></div>
                </div>
                <div class="scoreboard">
                    <div class="sb-team">
                        <div class="team-logo" id="md-logo1" style="background:#ff9800;">H</div>
                        <span id="md-name1" style="font-weight:bold; font-size:14px; margin-top:5px;">Home</span>
                    </div>
                    <div>
                        <div class="sb-score" id="md-score">0 : 0</div>
                        <div class="sb-meta" id="md-time">LIVE</div>
                    </div>
                    <div class="sb-team">
                        <div class="team-logo" id="md-logo2" style="background:#2196f3;">A</div>
                        <span id="md-name2" style="font-weight:bold; font-size:14px; margin-top:5px;">Away</span>
                    </div>
                </div>
                <div id="md-tennis-stats" style="display:none;"></div>
            </div>
            <div class="bet-sheet">
                <h3 style="margin-top:0;">–û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å—Ö–æ–¥—ã</h3>
                <div class="cf-grid" id="md-coeffs"></div>
            </div>
        </section>

        <!-- MENU -->
        <section id="p-menu" class="page active">
            <h2 style="margin-top:0">–ì–ª–∞–≤–Ω–∞—è</h2>
            <div class="games-grid">
                <div class="g-card wide" onclick="App.nav('sport')">
                    <i class="fas fa-trophy g-icon"></i><h3 class="g-title">–°–ø–æ—Ä—Ç</h3><span class="g-sub">Live & Line</span>
                </div>
                <div class="g-card mines" onclick="App.nav('mines')">
                    <i class="fas fa-bomb g-icon"></i><h3 class="g-title">Mines</h3><span class="g-sub">–°–∞–ø–µ—Ä</span>
                </div>
                <div class="g-card dice" onclick="App.nav('dice')">
                    <i class="fas fa-dice-d20 g-icon"></i><h3 class="g-title">Dice</h3><span class="g-sub">–ö—É–±–∏–∫</span>
                </div>
            </div>
        </section>

        <!-- SPORT FEED -->
        <section id="p-sport" class="page">
            <h2 style="margin-top:0">–°–ø–æ—Ä—Ç</h2>
            <div class="sport-cats">
                <button class="cat-btn active" onclick="Sport.filter('football', this)">‚öΩ –§—É—Ç–±–æ–ª</button>
                <button class="cat-btn" onclick="Sport.filter('hockey', this)">üèí –•–æ–∫–∫–µ–π</button>
                <button class="cat-btn" onclick="Sport.filter('tennis', this)">üèì –ù–∞—Å—Ç–æ–ª—å–Ω—ã–π</button>
                <button class="cat-btn" onclick="Sport.filter('basketball', this)">üèÄ –ë–∞—Å–∫–µ—Ç</button>
            </div>
            <div id="sport-feed"></div>
        </section>

        <!-- MINES -->
        <section id="p-mines" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <i class="fas fa-chevron-left" onclick="App.nav('menu')" style="padding:10px;"></i><h2>Mines</h2>
            </div>
            <div class="control-panel">
                <input type="number" id="m-bet" value="50" placeholder="–°—Ç–∞–≤–∫–∞">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:13px;">
                    <span>–ú–∏–Ω—ã: <b id="m-cnt-val">3</b></span><span>–ö—ç—Ñ: <b id="m-coef" style="color:var(--accent)">x1.00</b></span>
                </div>
                <input type="range" id="m-cnt" min="3" max="24" value="3" oninput="Mines.updInput()">
                <button id="m-btn" class="btn-main" onclick="Mines.start()">–ò–≥—Ä–∞—Ç—å</button>
                <button id="m-cash" class="btn-main" style="background:#d29922; display:none;" onclick="Mines.cashout()">–ó–∞–±—Ä–∞—Ç—å</button>
            </div>
            <br><div class="mines-grid" id="m-grid"></div>
        </section>

        <!-- DICE -->
        <section id="p-dice" class="page">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <i class="fas fa-chevron-left" onclick="App.nav('menu')" style="padding:10px;"></i><h2>Dice</h2>
            </div>
            <div class="dice-stage"><div class="cube" id="d-cube">
                <div class="face f1">1</div><div class="face f2">2</div><div class="face f3">3</div><div class="face f4">4</div><div class="face f5">5</div><div class="face f6">6</div>
            </div></div>
            <div class="control-panel">
                <input type="number" id="d-bet" value="50" placeholder="–°—Ç–∞–≤–∫–∞">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <button class="cf-btn" id="d-even" onclick="Dice.type('even')" style="background:var(--bg-body); border:1px solid var(--border); padding:15px;">–ß–ï–¢ <b>x1.90</b></button>
                    <button class="cf-btn" id="d-odd" onclick="Dice.type('odd')" style="background:var(--bg-body); border:1px solid var(--border); padding:15px;">–ù–ï–ß–ï–¢ <b>x1.90</b></button>
                </div>
                <button class="btn-main" onclick="Dice.roll()">–ë—Ä–æ—Å–æ–∫</button>
            </div>
        </section>

        <!-- PROFILE -->
        <section id="p-profile" class="page">
            <h2 style="margin-top:0">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="control-panel" style="text-align:center;">
                <div style="width:70px; height:70px; background:#21262d; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:24px;">üë§</div>
                <h3>ID: <span id="prof-id">...</span></h3>
            </div>

            <!-- Referral Card -->
            <div class="ref-card">
                <h3>ü§ù –ü–∞—Ä—Ç–Ω–µ—Ä–∫–∞</h3>
                <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π <b>50‚ÇΩ</b></p>
                <div class="ref-stat">
                    <div class="rs-box">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ<b>0</b></div>
                    <div class="rs-box">–î–æ—Ö–æ–¥<b>0 ‚ÇΩ</b></div>
                </div>
                <button class="btn-main" style="font-size:14px; padding:10px;" onclick="App.shareRef()">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
            </div>

            <h4 style="margin-bottom:10px; margin-top:20px;">–ò—Å—Ç–æ—Ä–∏—è</h4>
            <div id="history-list" style="font-size:12px;"></div>
        </section>
    </main>

    <nav id="main-nav">
        <div class="nav-item active" onclick="App.nav('menu')"><i class="fas fa-home"></i>–ú–µ–Ω—é</div>
        <div class="nav-item" onclick="App.nav('sport')"><i class="fas fa-futbol"></i>–°–ø–æ—Ä—Ç</div>
        <div class="nav-item" onclick="App.nav('profile')"><i class="fas fa-user"></i>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;

        // --- MAIN APP (BACKEND CONNECTED) ---
        const App = {
            userId: 0,
            bal: 0,
            
            init: async function() {
                tg.ready(); tg.expand();
                const u = tg.initDataUnsafe?.user;
                this.userId = u ? u.id : 12345; // Fallback ID for browser test
                document.getElementById('prof-id').innerText = this.userId;

                await this.fetchData();
                Mines.init();
                Sport.init();
            },

            // 1. GET USER DATA FROM SERVER
            fetchData: async function() {
                try {
                    let res = await fetch(`/api/user/${this.userId}`);
                    let data = await res.json();
                    this.bal = data.balance;
                    this.updateUI(data.history);
                } catch(e) { console.error('API Error:', e); }
            },

            // 2. SEND BET TO SERVER
            sendBet: async function(game, bet, win, coeff) {
                try {
                    // Optimistic UI update
                    this.bal = this.bal - bet + win; 
                    this.updateUI();

                    let res = await fetch('/api/bet', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            user_id: this.userId,
                            game: game,
                            bet: bet,
                            win: win,
                            coeff: coeff
                        })
                    });
                    let data = await res.json();
                    if(data.status === 'ok') {
                        this.bal = data.new_balance; // Sync with server truth
                        this.fetchData(); // Refresh history
                    }
                } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º"); }
            },

            updateUI: function(history) {
                document.getElementById('ui-balance').innerText = this.bal.toFixed(2) + ' ‚ÇΩ';
                if(history) {
                    const hl = document.getElementById('history-list');
                    hl.innerHTML = history.slice(0,10).map(h => `
                        <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
                            <span>${h.game} (x${h.coeff})</span>
                            <span style="color:${h.w>0?'#2ea043':'#da3633'}">${h.w>0?'+'+h.w:h.w}</span>
                        </div>`).join('');
                }
            },

            nav: function(p) {
                document.getElementById('p-match-detail').classList.remove('active');
                document.getElementById('main-header').style.display = 'flex';
                document.getElementById('main-nav').style.display = 'flex';

                document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
                document.getElementById('p-'+p).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                if(p==='menu'||p.startsWith('mines')||p.startsWith('dice')) document.querySelectorAll('.nav-item')[0].classList.add('active');
                if(p==='sport') document.querySelectorAll('.nav-item')[1].classList.add('active');
                if(p==='profile') document.querySelectorAll('.nav-item')[2].classList.add('active');
            },

            deposit: function() { tg.showPopup({title:'–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ', message:'–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ—Ç–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è'}); },
            shareRef: function() { tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/YOUR_BOT?start=${this.userId}&text=–ë–æ–Ω—É—Å+50‚ÇΩ`); }
        };

        // --- SPORT ENGINE (SMART SORT & DETAIL VIEW) ---
        const Sport = {
            matches: [],
            curCat: 'football',
            detailId: null,

            teams: {
                football: ['Real Madrid', 'Barcelona', 'Man City', 'Liverpool', 'PSG', 'Bayern'],
                hockey: ['–ê–∫ –ë–∞—Ä—Å', '–ê–≤–∞–Ω–≥–∞—Ä–¥', '–¶–°–ö–ê', '–°–ö–ê', '–î–∏–Ω–∞–º–æ', '–ú–µ—Ç–∞–ª–ª—É—Ä–≥'],
                basketball: ['Lakers', 'Bulls', 'Celtics', 'Heat', 'Warriors', 'Nets'],
                tennis: ['–õ–∏—Å–∫–∞ –¢.', '–ö—Ä–∞–º–µ...', '–ò–≤–∞–Ω–æ–≤ –ê.', '–ü–µ—Ç—Ä–æ–≤ –ë.', '–°–∏–¥–æ—Ä–æ–≤ –í.', '–ö—É–∑–Ω–µ—Ü–æ–≤']
            },

            init: function() {
                this.genSchedule();
                setInterval(() => this.tick(), 1000);
                this.render();
            },

            genSchedule: function() {
                const now = Date.now();
                const categories = ['football', 'hockey', 'basketball', 'tennis'];
                
                categories.forEach(cat => {
                    const tms = [...this.teams[cat]].sort(() => Math.random() - 0.5);
                    // 1. Live Match
                    this.matches.push({
                        id: Math.random(), cat: cat, isLive: true,
                        t1: tms.pop(), t2: tms.pop(),
                        time: 0, s1: 0, s2: 0,
                        sets: cat === 'tennis' ? [[0,0]] : null, setScore: [0,0],
                        timestamp: now - 3600000 
                    });
                    // 2. Upcoming Sorted
                    for(let i=0; i<3; i++) {
                        const mins = (i+1) * 45 + Math.floor(Math.random()*30);
                        this.matches.push({
                            id: Math.random(), cat: cat, isLive: false,
                            t1: tms.length ? tms.pop() : 'Team A', t2: tms.length ? tms.pop() : 'Team B',
                            time: 0, s1: 0, s2: 0, sets: null,
                            timestamp: now + (mins * 60000)
                        });
                    }
                });
            },

            tick: function() {
                this.matches.forEach(m => {
                    if(m.isLive) {
                        m.time++;
                        if(Math.random() < 0.1) {
                            const who = Math.random() > 0.5 ? 0 : 1;
                            if(m.cat === 'tennis') {
                                let curSetIdx = m.sets.length - 1;
                                m.sets[curSetIdx][who]++;
                                if(m.sets[curSetIdx][who] >= 11 && (m.sets[curSetIdx][who] - m.sets[curSetIdx][1-who] >= 2)) {
                                    m.setScore[who]++; m.sets.push([0,0]);
                                }
                                m.s1 = m.setScore[0]; m.s2 = m.setScore[1];
                            } else if (m.cat === 'basketball') {
                                m[who===0?'s1':'s2'] += (Math.random()>0.7 ? 3 : 2);
                            } else {
                                m[who===0?'s1':'s2']++;
                            }
                        }
                    }
                });
                if(document.getElementById('p-sport').classList.contains('active')) this.render();
                if(document.getElementById('p-match-detail').classList.contains('active') && this.detailId) {
                    this.renderDetail(this.matches.find(x => x.id === this.detailId));
                }
            },

            filter: function(cat, btn) {
                this.curCat = cat;
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                this.render();
            },

            render: function() {
                const list = this.matches.filter(m => m.cat === this.curCat);
                list.sort((a, b) => {
                    if(a.isLive && !b.isLive) return -1;
                    if(!a.isLive && b.isLive) return 1;
                    return a.timestamp - b.timestamp;
                });

                const cont = document.getElementById('sport-feed');
                cont.innerHTML = list.map(m => {
                    const d = new Date(m.timestamp);
                    const timeStr = m.isLive 
                        ? `<span class="live-badge"><span class="live-dot"></span>LIVE</span> ${m.cat==='tennis'? '' : Math.floor(m.time/60)+"' –º–∏–Ω"}`
                        : `<i class="far fa-clock"></i> ${d.getDate() === new Date().getDate() ? '–°–µ–≥–æ–¥–Ω—è' : '–ó–∞–≤—Ç—Ä–∞'} ${d.getHours()}:${(d.getMinutes()<10?'0':'')+d.getMinutes()}`;
                    
                    return `
                    <div class="match-card" onclick="Sport.openDetail(${m.id})">
                        <div class="match-header"><span>${timeStr}</span></div>
                        <div class="teams-row">
                            <span class="team-name">${m.t1}</span>
                            <span class="match-score">${m.s1} : ${m.s2}</span>
                            <span class="team-name" style="text-align:right">${m.t2}</span>
                        </div>
                        <div class="cf-grid">
                            <button class="cf-btn" onclick="event.stopPropagation(); Sport.bet(50)">–ü1 <b>1.85</b></button>
                            <button class="cf-btn" onclick="event.stopPropagation(); Sport.bet(50)">X <b>3.40</b></button>
                            <button class="cf-btn" onclick="event.stopPropagation(); Sport.bet(50)">–ü2 <b>2.10</b></button>
                        </div>
                    </div>`;
                }).join('');
            },

            openDetail: function(id) {
                this.detailId = id;
                const m = this.matches.find(x => x.id === id);
                if(!m) return;
                document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
                document.getElementById('main-header').style.display = 'none';
                document.getElementById('main-nav').style.display = 'none';
                document.getElementById('p-match-detail').classList.add('active');
                this.renderDetail(m);
            },

            renderDetail: function(m) {
                document.getElementById('md-league').innerText = m.cat.toUpperCase();
                document.getElementById('md-name1').innerText = m.t1;
                document.getElementById('md-name2').innerText = m.t2;
                document.getElementById('md-logo1').innerText = m.t1[0];
                document.getElementById('md-logo2').innerText = m.t2[0];
                document.getElementById('md-score').innerText = `${m.s1} : ${m.s2}`;
                document.getElementById('md-time').innerText = m.isLive 
                    ? `LIVE ${m.cat==='tennis' ? '–°–µ—Ç ' + m.sets.length : Math.floor(m.time/60)+"'"}` 
                    : '–û–∂–∏–¥–∞–Ω–∏–µ';

                const tennisDiv = document.getElementById('md-tennis-stats');
                if(m.cat === 'tennis' && m.sets) {
                    tennisDiv.style.display = 'block';
                    let ths = '<th></th>'; for(let i=1; i<=5; i++) ths += `<th>${i} —Å–µ—Ç</th>`;
                    const buildRow = (teamIdx, color) => {
                        let tds = `<td><div class="team-label"><div class="tennis-logo-mini" style="background:${color}; color:white">${m[teamIdx===0?'t1':'t2'][0]}</div> ${m[teamIdx===0?'t1':'t2'].slice(0,6)}..</div></td>`;
                        for(let i=0; i<5; i++) {
                            const val = m.sets[i] ? m.sets[i][teamIdx] : '';
                            const isCurrent = (i === m.sets.length - 1);
                            tds += `<td class="${isCurrent && m.isLive ? 'current-set' : ''}">${val}</td>`;
                        }
                        return `<tr>${tds}</tr>`;
                    };
                    tennisDiv.innerHTML = `<table class="tennis-sets"><thead><tr>${ths}</tr></thead><tbody>${buildRow(0, '#ff9800')}${buildRow(1, '#212121')}</tbody></table>`;
                } else { tennisDiv.style.display = 'none'; }

                document.getElementById('md-coeffs').innerHTML = `
                    <button class="cf-btn" onclick="Sport.bet(50)">–ü1 <b>1.85</b></button>
                    <button class="cf-btn" onclick="Sport.bet(50)">X <b>3.40</b></button>
                    <button class="cf-btn" onclick="Sport.bet(50)">–ü2 <b>2.10</b></button>`;
            },

            bet: function(amt) {
                if(App.bal < amt) return tg.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                // Send sport bet to server immediately
                App.sendBet('Sport Bet', amt, 0, 0); // 0 win means loss for now (simulation)
                tg.showAlert('–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!');
            }
        };

        const Mines = {
            init: function() {
                const g = document.getElementById('m-grid'); g.innerHTML = '';
                for(let i=0; i<25; i++) {
                    let d = document.createElement('div'); d.className = 'cell'; d.onclick = () => this.click(i, d);
                    g.appendChild(d);
                }
            },
            updInput: function() { document.getElementById('m-cnt-val').innerText = document.getElementById('m-cnt').value; },
            start: function() {
                const bet = parseFloat(document.getElementById('m-bet').value);
                if(bet > App.bal) return tg.showAlert('–ú–∞–ª–æ –¥–µ–Ω–µ–≥');
                
                // Visual deduction
                document.getElementById('ui-balance').innerText = (App.bal - bet).toFixed(2) + ' ‚ÇΩ';
                
                this.active = true; this.bet = bet; this.mines = parseInt(document.getElementById('m-cnt').value);
                this.grid = Array(25).fill(0);
                let c=0; while(c<this.mines) { let r=Math.floor(Math.random()*25); if(this.grid[r]===0){this.grid[r]=1; c++;} }
                document.getElementById('m-btn').style.display='none'; document.getElementById('m-cash').style.display='block';
                document.querySelectorAll('.cell').forEach(c => { c.className='cell'; c.innerHTML=''; });
                this.step=0;
            },
            click: function(idx, el) {
                if(!this.active || el.classList.contains('active')) return;
                el.classList.add('active');
                if(this.grid[idx]===1) { 
                    el.classList.add('bomb'); el.innerHTML='üí£'; 
                    this.end(false); 
                } else { 
                    el.classList.add('gem'); el.innerHTML='üíé'; this.step++;
                    const m = (25-(this.step-1))/(25-this.mines-(this.step-1));
                    this.win = this.bet * Math.pow(m*0.98, this.step);
                    document.getElementById('m-cash').innerText = `–ó–∞–±—Ä–∞—Ç—å ${this.win.toFixed(0)} ‚ÇΩ`;
                }
            },
            cashout: function() { this.end(true); },
            end: function(w) { 
                this.active=false; document.getElementById('m-btn').style.display='block'; document.getElementById('m-cash').style.display='none';
                
                // Send result to server
                const winAmount = w ? this.win : 0;
                const coeff = w ? (this.win / this.bet) : 0;
                App.sendBet('Mines', this.bet, winAmount, coeff.toFixed(2));

                if(!w) {
                    document.querySelectorAll('.cell').forEach((c, i) => {
                        if(this.grid[i]===1) { c.innerHTML = 'üí£'; if(!c.classList.contains('bomb')) c.style.opacity = 0.5; }
                    });
                }
            }
        };

        const Dice = {
            roll: function() {
                const bet = parseFloat(document.getElementById('d-bet').value);
                if(bet > App.bal) return tg.showAlert('–ú–∞–ª–æ –¥–µ–Ω–µ–≥');
                
                // Visual deduction
                document.getElementById('ui-balance').innerText = (App.bal - bet).toFixed(2) + ' ‚ÇΩ';
                
                const res = Math.floor(Math.random()*6)+1;
                const m = {1:[0,0], 6:[0,180], 2:[0,-90], 5:[0,90], 3:[-90,0], 4:[90,0]};
                document.getElementById('d-cube').style.transform = `rotateX(${m[res][0]+720}deg) rotateY(${m[res][1]+720}deg)`;
                
                setTimeout(() => {
                    const win = (res%2===0 && this.type==='even') || (res%2!==0 && this.type==='odd');
                    const winAmount = win ? bet * 1.9 : 0;
                    
                    App.sendBet('Dice', bet, winAmount, 1.9);
                    tg.showAlert(win ? `–ü–æ–±–µ–¥–∞! ${res}` : `–õ—É–∑. ${res}`);
                }, 1600);
            },
            type: function(t) { this.type = t; }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
