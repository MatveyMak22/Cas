<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Betting Mini App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent: #238636;
            --accent-hover: #2ea043;
            --danger: #da3633;
            --border: #30363d;
            --nav-height: 65px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden; /* Prevent body scroll, handle in sections */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- UI COMPONENTS --- */
        button {
            cursor: pointer;
            border: none;
            outline: none;
            font-family: inherit;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
            transition: 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); background: var(--accent-hover); }
        .btn-danger { background-color: var(--danger); }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* --- HEADER --- */
        header {
            height: var(--header-height);
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }
        .balance-box {
            display: flex;
            flex-direction: column;
        }
        .balance-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .balance-amount { font-size: 18px; font-weight: 700; color: var(--accent-hover); }
        .top-up-btn {
            background: var(--card-bg);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        /* --- MAIN CONTENT --- */
        main {
            flex: 1;
            margin-top: var(--header-height);
            margin-bottom: var(--nav-height);
            overflow-y: auto;
            padding: 16px;
        }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- NAVIGATION --- */
        nav {
            height: var(--nav-height);
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            color: var(--text-secondary);
            text-align: center;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 20%;
        }
        .nav-item i { font-size: 18px; margin-bottom: 2px; }
        .nav-item.active { color: var(--accent-hover); }

        /* --- SPORT SECTION --- */
        .match-card {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .match-header { display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 12px; }
        .live-badge { background: var(--danger); color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .teams { display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 16px; margin: 5px 0; }
        .score { font-size: 20px; color: var(--accent); letter-spacing: 2px; }
        .coeffs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .coeff-btn {
            background: #21262d;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-primary);
            font-size: 13px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .coeff-btn span { color: var(--accent-hover); font-weight: bold; margin-top: 2px; }
        .coeff-btn.selected { border-color: var(--accent); background: rgba(35, 134, 54, 0.1); }

        /* --- MINES SECTION --- */
        .mines-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .mine-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-width: 350px;
            margin: 0 auto;
        }
        .mine-cell {
            aspect-ratio: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            transition: 0.1s;
        }
        .mine-cell.active { background: #30363d; }
        .mine-cell.safe { background: var(--accent); border-color: var(--accent); }
        .mine-cell.boom { background: var(--danger); border-color: var(--danger); }

        /* --- DICE SECTION --- */
        .dice-container {
            perspective: 1000px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }
        .cube {
            width: 80px;
            height: 80px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s ease-out;
        }
        .cube__face {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 2px solid var(--accent);
            background: rgba(35, 134, 54, 0.2);
            color: white;
            font-size: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(35, 134, 54, 0.5) inset;
        }
        .cube__face--1  { transform: rotateY(  0deg) translateZ(40px); }
        .cube__face--2  { transform: rotateY( 90deg) translateZ(40px); }
        .cube__face--3  { transform: rotateY(180deg) translateZ(40px); }
        .cube__face--4  { transform: rotateY(-90deg) translateZ(40px); }
        .cube__face--5  { transform: rotateX( 90deg) translateZ(40px); }
        .cube__face--6  { transform: rotateX(-90deg) translateZ(40px); }

        .dice-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .dice-btn { padding: 15px; background: var(--card-bg); border: 1px solid var(--border); color: white; border-radius: 8px; }
        .dice-btn.active { border-color: var(--accent); background: rgba(35, 134, 54, 0.1); }

        /* --- COUPON / BET SLIP --- */
        .coupon-float {
            position: fixed;
            bottom: calc(var(--nav-height) + 15px);
            left: 15px;
            right: 15px;
            background: var(--card-bg);
            border: 1px solid var(--accent);
            padding: 15px;
            border-radius: 12px;
            display: none;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            z-index: 90;
        }
        .coupon-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .coupon-info { font-size: 14px; color: var(--text-secondary); }
        .coupon-total { font-weight: bold; color: var(--accent-hover); font-size: 16px; }

        /* --- PROFILE --- */
        .history-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .h-tab { flex: 1; padding: 10px; text-align: center; color: var(--text-secondary); cursor: pointer; }
        .h-tab.active { color: var(--text-primary); border-bottom: 2px solid var(--accent); }
        .history-list { font-size: 13px; }
        .history-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .win { color: var(--accent-hover); }
        .loss { color: var(--danger); }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="balance-box">
            <span class="balance-label">Ваш баланс</span>
            <span class="balance-amount" id="user-balance">1000.00 ₽</span>
        </div>
        <button class="top-up-btn" onclick="app.deposit()">
            <i class="fas fa-wallet"></i> Пополнить
        </button>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Sport Page -->
        <div id="sport-section" class="page active">
            <h2 style="margin-top:0;">Live Ставки</h2>
            <div id="matches-container">
                <!-- Matches injected via JS -->
            </div>
        </div>

        <!-- Mines Page -->
        <div id="mines-section" class="page">
            <h2 style="margin-top:0;">Mines</h2>
            <div class="card">
                <input type="number" id="mines-bet" placeholder="Сумма ставки" value="100">
                <div class="mines-controls">
                    <select id="mines-count" style="padding: 10px; background: #0d1117; color: white; border: 1px solid #30363d; border-radius: 8px; flex: 1;">
                        <option value="3">3 Мины</option>
                        <option value="5">5 Мин</option>
                        <option value="10">10 Мин</option>
                        <option value="20">20 Мин</option>
                    </select>
                </div>
                <button class="btn-primary" id="mines-start-btn" onclick="gameMines.start()">Играть</button>
                <button class="btn-primary" id="mines-cashout-btn" style="display:none; margin-top:10px; background: #d29922;" onclick="gameMines.cashout()">Забрать (<span id="mines-current-win">0</span>)</button>
            </div>
            <div class="mine-grid" id="mine-grid">
                <!-- Generated via JS -->
            </div>
        </div>

        <!-- Dice Page -->
        <div id="dice-section" class="page">
            <h2 style="margin-top:0;">Dice 3D</h2>
            <div class="dice-container">
                <div class="cube" id="dice-cube">
                    <div class="cube__face cube__face--1">1</div>
                    <div class="cube__face cube__face--2">2</div>
                    <div class="cube__face cube__face--3">3</div>
                    <div class="cube__face cube__face--4">4</div>
                    <div class="cube__face cube__face--5">5</div>
                    <div class="cube__face cube__face--6">6</div>
                </div>
            </div>
            <div class="card">
                <input type="number" id="dice-bet" placeholder="Сумма ставки" value="100">
                <div class="dice-controls">
                    <button class="dice-btn" id="dice-even" onclick="gameDice.selectType('even')">Чет (x1.9)</button>
                    <button class="dice-btn" id="dice-odd" onclick="gameDice.selectType('odd')">Нечет (x1.9)</button>
                </div>
                <br>
                <button class="btn-primary" onclick="gameDice.roll()">Бросить кубик</button>
            </div>
        </div>

        <!-- Bets/Coupon Page -->
        <div id="bets-section" class="page">
            <h2 style="margin-top:0;">Мои Ставки</h2>
             <div class="history-tabs">
                <div class="h-tab active" onclick="app.switchHistory('active')">Активные</div>
                <div class="h-tab" onclick="app.switchHistory('settled')">Рассчитанные</div>
            </div>
            <div id="history-container" class="history-list">
                <!-- History Items -->
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-section" class="page">
            <h2 style="margin-top:0;">Профиль</h2>
            <div class="card" style="text-align: center;">
                <div style="width: 80px; height: 80px; background: #21262d; border-radius: 50%; margin: 0 auto 10px; display:flex; align-items:center; justify-content:center; font-size: 30px; color: var(--text-secondary);">
                    <i class="fas fa-user"></i>
                </div>
                <h3>Игрок Telegram</h3>
                <p style="color: var(--text-secondary);">ID: 123456789</p>
                <hr style="border: 0; border-top: 1px solid var(--border); margin: 15px 0;">
                <div style="text-align: left;">
                    <p>Общий баланс: <span style="color: var(--accent-hover); float: right;" id="profile-balance">0</span></p>
                    <p>Всего ставок: <span style="float: right;" id="profile-total-bets">0</span></p>
                </div>
                <button class="btn-danger" style="margin-top: 20px;" onclick="app.resetData()">Сброс данных (Debug)</button>
            </div>
        </div>
    </main>

    <!-- Floating Coupon -->
    <div class="coupon-float" id="coupon-modal">
        <div class="coupon-header">
            <span>Купон</span>
            <span style="cursor: pointer;" onclick="app.clearCoupon()"><i class="fas fa-trash"></i></span>
        </div>
        <div class="coupon-info">
            <div id="coupon-matches-list"></div>
            <hr style="border-color: var(--border);">
            <div style="display:flex; justify-content:space-between;">
                <span>Общий кэф:</span>
                <span id="coupon-total-coeff" style="color: white;">1.00</span>
            </div>
        </div>
        <input type="number" id="coupon-bet-amount" value="100" style="margin-top: 10px;">
        <button class="btn-primary" onclick="app.placeBet()">Поставить <span id="coupon-btn-sum"></span></button>
    </div>

    <!-- Navigation -->
    <nav>
        <div class="nav-item active" onclick="app.nav('sport')">
            <i class="fas fa-futbol"></i>
            <span>Спорт</span>
        </div>
        <div class="nav-item" onclick="app.nav('mines')">
            <i class="fas fa-bomb"></i>
            <span>Mines</span>
        </div>
        <div class="nav-item" onclick="app.nav('dice')">
            <i class="fas fa-dice"></i>
            <span>Dice</span>
        </div>
        <div class="nav-item" onclick="app.nav('bets')">
            <i class="fas fa-ticket-alt"></i>
            <span>Ставки</span>
        </div>
        <div class="nav-item" onclick="app.nav('profile')">
            <i class="fas fa-user"></i>
            <span>Профиль</span>
        </div>
    </nav>

    <script>
        // --- CORE SYSTEM & STATE ---
        const tg = window.Telegram?.WebApp;
        
        const app = {
            balance: 1000,
            activeTab: 'sport',
            coupon: [],
            history: [],
            
            init: function() {
                if(tg) {
                    tg.expand();
                    tg.ready();
                }
                
                this.loadData();
                this.updateUI();
                sportsSim.init();
                
                // Prevent accidental closing on swipe (iOS)
                document.body.addEventListener('touchmove', function(e) {
                   if(app.activeTab !== 'sport') return; // Allow scroll in list
                }, { passive: false });
            },

            loadData: function() {
                const savedBal = localStorage.getItem('casino_balance');
                const savedHist = localStorage.getItem('casino_history');
                if(savedBal) this.balance = parseFloat(savedBal);
                if(savedHist) this.history = JSON.parse(savedHist);
            },

            saveData: function() {
                localStorage.setItem('casino_balance', this.balance);
                localStorage.setItem('casino_history', JSON.stringify(this.history));
                this.updateUI();
            },

            resetData: function() {
                if(confirm('Сбросить баланс и историю?')) {
                    localStorage.clear();
                    location.reload();
                }
            },

            updateUI: function() {
                document.getElementById('user-balance').innerText = this.balance.toFixed(2) + ' ₽';
                document.getElementById('profile-balance').innerText = this.balance.toFixed(2) + ' ₽';
                document.getElementById('profile-total-bets').innerText = this.history.length;
            },

            nav: function(tabId) {
                this.activeTab = tabId;
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(tabId + '-section').classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                event.currentTarget.classList.add('active');

                if(tabId === 'bets') this.renderHistory();
            },

            deposit: function() {
                if(tg && tg.showPopup) {
                    tg.showPopup({
                        title: 'Пополнение',
                        message: 'Для пополнения баланса воспользуйтесь ботом.',
                        buttons: [{type: 'ok'}]
                    });
                } else {
                    alert('Пополнение через бота');
                }
            },

            // --- BETTING LOGIC ---
            addToCoupon: function(matchId, type, coeff, teamName) {
                // Check if match already in coupon, replace if so
                const idx = this.coupon.findIndex(c => c.matchId === matchId);
                if(idx >= 0) this.coupon.splice(idx, 1);

                this.coupon.push({matchId, type, coeff, teamName});
                this.renderCoupon();
            },

            renderCoupon: function() {
                const modal = document.getElementById('coupon-modal');
                const list = document.getElementById('coupon-matches-list');
                
                if(this.coupon.length === 0) {
                    modal.style.display = 'none';
                    return;
                }

                modal.style.display = 'block';
                let totalCoeff = 1;
                let html = '';

                this.coupon.forEach(c => {
                    totalCoeff *= c.coeff;
                    html += `<div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span>${c.teamName} (${c.type})</span>
                        <span style="color:var(--accent)">x${c.coeff}</span>
                    </div>`;
                });

                list.innerHTML = html;
                document.getElementById('coupon-total-coeff').innerText = totalCoeff.toFixed(2);
                document.getElementById('coupon-btn-sum').innerText = (totalCoeff * document.getElementById('coupon-bet-amount').value).toFixed(2);
                
                // Listener for input change to update potential win
                document.getElementById('coupon-bet-amount').oninput = function() {
                    const val = parseFloat(this.value) || 0;
                    document.getElementById('coupon-btn-sum').innerText = (val * totalCoeff).toFixed(2);
                };
            },

            clearCoupon: function() {
                this.coupon = [];
                this.renderCoupon();
                document.querySelectorAll('.coeff-btn').forEach(b => b.classList.remove('selected'));
            },

            placeBet: function() {
                const amount = parseFloat(document.getElementById('coupon-bet-amount').value);
                if(amount > this.balance) {
                    if(tg && tg.showAlert) tg.showAlert('Недостаточно средств'); else alert('Недостаточно средств');
                    return;
                }

                let totalCoeff = 1;
                this.coupon.forEach(c => totalCoeff *= c.coeff);

                this.balance -= amount;
                
                // Add to active history
                const betObj = {
                    id: Date.now(),
                    date: new Date().toLocaleString(),
                    type: this.coupon.length > 1 ? 'Экспресс' : 'Ординар',
                    selection: this.coupon.map(c => `${c.teamName} (${c.type})`).join(', '),
                    amount: amount,
                    coeff: totalCoeff.toFixed(2),
                    status: 'active', // active, win, loss
                    winAmount: 0
                };
                
                this.history.unshift(betObj);
                this.saveData();
                this.clearCoupon();
                
                if(tg && tg.showAlert) tg.showAlert('Ставка принята!'); else alert('Ставка принята!');

                // Simulate settlement for Sport (Demo logic)
                setTimeout(() => {
                    const win = Math.random() > 0.5; // Random win/loss for demo
                    betObj.status = win ? 'win' : 'loss';
                    betObj.winAmount = win ? amount * totalCoeff : 0;
                    if(win) this.balance += betObj.winAmount;
                    this.saveData();
                }, 10000); // Settle after 10 sec
            },

            // --- HISTORY LOGIC ---
            historyFilter: 'active',
            switchHistory: function(filter) {
                this.historyFilter = filter;
                document.querySelectorAll('.h-tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                this.renderHistory();
            },
            
            renderHistory: function() {
                const container = document.getElementById('history-container');
                const filtered = this.history.filter(h => 
                    this.historyFilter === 'active' ? h.status === 'active' : h.status !== 'active'
                );

                if(filtered.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary)">Пусто</div>';
                    return;
                }

                container.innerHTML = filtered.map(h => `
                    <div class="history-item">
                        <div>
                            <div style="font-weight:bold;">${h.type} <span style="font-size:10px;">${h.date}</span></div>
                            <div style="color:var(--text-secondary);">${h.selection}</div>
                            <div style="font-size:11px;">Кэф: ${h.coeff}</div>
                        </div>
                        <div style="text-align:right;">
                            <div>${h.amount} ₽</div>
                            <div class="${h.status === 'win' ? 'win' : (h.status === 'loss' ? 'loss' : '')}">
                                ${h.status === 'active' ? '...' : (h.status === 'win' ? '+' + h.winAmount.toFixed(2) : '0.00')}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        };

        // --- SPORTS SIMULATOR ---
        const sportsSim = {
            matches: [
                {id: 1, t1: 'Real Madrid', t2: 'Barcelona', s1: 1, s2: 1, time: 45, k: [2.10, 3.50, 2.80]},
                {id: 2, t1: 'Liverpool', t2: 'Man City', s1: 0, s2: 2, time: 60, k: [5.50, 4.00, 1.45]},
                {id: 3, t1: 'Djokovic N.', t2: 'Alcaraz C.', s1: 1, s2: 0, time: 'Set 2', k: [1.70, 0, 2.05]} // Tennis no draw usually, simplistic
            ],
            
            init: function() {
                this.render();
                setInterval(() => this.tick(), 2000);
            },

            tick: function() {
                this.matches.forEach(m => {
                    // Time
                    if(typeof m.time === 'number' && m.time < 90) m.time++;
                    
                    // Random Score Goal (Low chance)
                    if(Math.random() < 0.05 && typeof m.time === 'number') {
                        Math.random() > 0.5 ? m.s1++ : m.s2++;
                    }

                    // Dynamic Odds fluctuation
                    m.k = m.k.map(k => {
                        if(k === 0) return 0;
                        let change = (Math.random() * 0.1) - 0.05;
                        return parseFloat(Math.max(1.01, k + change).toFixed(2));
                    });
                });
                this.render();
            },

            render: function() {
                const container = document.getElementById('matches-container');
                // Preserve selection visually if re-rendering is basic
                // In production, use Virtual DOM or fine-grained updates. Here full redraw for simplicity.
                
                container.innerHTML = this.matches.map(m => `
                    <div class="card match-card">
                        <div class="match-header">
                            <span class="live-badge">LIVE</span>
                            <span>${typeof m.time === 'number' ? m.time + "'" : m.time}</span>
                        </div>
                        <div class="teams">
                            <span>${m.t1}</span>
                            <span class="score">${m.s1} : ${m.s2}</span>
                            <span>${m.t2}</span>
                        </div>
                        <div class="coeffs">
                            <button class="coeff-btn" onclick="sportsSim.select(this, ${m.id}, 'W1', ${m.k[0]}, '${m.t1}')">
                                <span>1</span><span>${m.k[0]}</span>
                            </button>
                            <button class="coeff-btn" onclick="sportsSim.select(this, ${m.id}, 'X', ${m.k[1]}, 'Ничья')" ${m.k[1] === 0 ? 'disabled' : ''}>
                                <span>X</span><span>${m.k[1] === 0 ? '-' : m.k[1]}</span>
                            </button>
                            <button class="coeff-btn" onclick="sportsSim.select(this, ${m.id}, 'W2', ${m.k[2]}, '${m.t2}')">
                                <span>2</span><span>${m.k[2]}</span>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Re-highlight active selections
                app.coupon.forEach(c => {
                    // This part is tricky in full redraw, simple implementation ignores re-highlighting 
                    // properly without complex DOM matching in vanilla JS short code.
                    // For demo, we rely on data logic.
                });
            },

            select: function(elem, id, type, k, name) {
                // Visual toggle
                const parent = elem.parentElement;
                parent.querySelectorAll('.coeff-btn').forEach(b => b.classList.remove('selected'));
                elem.classList.add('selected');
                
                app.addToCoupon(id, type, k, name);
            }
        };

        // --- MINES GAME ---
        const gameMines = {
            grid: [],
            isPlaying: false,
            bet: 0,
            minesCount: 3,
            currentMultiplier: 1,
            safeClicks: 0,

            start: function() {
                const amount = parseFloat(document.getElementById('mines-bet').value);
                if(amount > app.balance) return alert("Недостаточно средств");
                
                app.balance -= amount;
                app.saveData();
                this.bet = amount;
                this.minesCount = parseInt(document.getElementById('mines-count').value);
                this.isPlaying = true;
                this.currentMultiplier = 1;
                this.safeClicks = 0;
                
                // UI updates
                document.getElementById('mines-start-btn').style.display = 'none';
                document.getElementById('mines-cashout-btn').style.display = 'block';
                document.getElementById('mines-current-win').innerText = amount;
                
                this.generateGrid();
            },

            generateGrid: function() {
                const container = document.getElementById('mine-grid');
                container.innerHTML = '';
                this.grid = Array(25).fill(0); // 0 safe, 1 mine
                
                // Place mines
                let minesPlaced = 0;
                while(minesPlaced < this.minesCount) {
                    let idx = Math.floor(Math.random() * 25);
                    if(this.grid[idx] === 0) {
                        this.grid[idx] = 1;
                        minesPlaced++;
                    }
                }

                for(let i=0; i<25; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'mine-cell';
                    cell.dataset.index = i;
                    cell.onclick = () => this.clickCell(i, cell);
                    container.appendChild(cell);
                }
            },

            clickCell: function(index, el) {
                if(!this.isPlaying || el.classList.contains('active')) return;

                el.classList.add('active');

                if(this.grid[index] === 1) {
                    // BOOM
                    el.classList.add('boom');
                    el.innerHTML = '<i class="fas fa-bomb"></i>';
                    this.gameOver(false);
                } else {
                    // Safe
                    el.classList.add('safe');
                    el.innerHTML = '<i class="fas fa-gem"></i>';
                    this.safeClicks++;
                    this.calcMultiplier();
                }
            },

            calcMultiplier: function() {
                // Simple Multiplier Logic
                // Standard formula: Next = Current * (RemainingTotal / RemainingSafe)
                const remainingTotal = 25 - (this.safeClicks - 1);
                const remainingSafe = (25 - this.minesCount) - (this.safeClicks - 1);
                const stepMult = remainingTotal / remainingSafe;
                
                this.currentMultiplier *= stepMult;
                // Add house edge (95% RTP)
                this.currentMultiplier = this.currentMultiplier * 0.98;
                
                const win = (this.bet * this.currentMultiplier).toFixed(2);
                document.getElementById('mines-current-win').innerText = win;
            },

            cashout: function() {
                if(!this.isPlaying) return;
                const win = parseFloat(document.getElementById('mines-current-win').innerText);
                app.balance += win;
                
                // Add to history
                app.history.unshift({
                    id: Date.now(), date: new Date().toLocaleString(), type: 'Mines', 
                    selection: `${this.minesCount} мин`, amount: this.bet, coeff: this.currentMultiplier.toFixed(2), 
                    status: 'win', winAmount: win
                });
                app.saveData();
                this.gameOver(true);
            },

            gameOver: function(win) {
                this.isPlaying = false;
                // Reveal all
                const cells = document.querySelectorAll('.mine-cell');
                cells.forEach((c, i) => {
                    if(this.grid[i] === 1) {
                        c.classList.add('active', 'boom');
                        c.innerHTML = '<i class="fas fa-bomb"></i>';
                    } else {
                        c.classList.add('active');
                        if(c.innerHTML === '') c.innerHTML = '<span style="opacity:0.3">x</span>';
                    }
                });

                document.getElementById('mines-start-btn').style.display = 'block';
                document.getElementById('mines-cashout-btn').style.display = 'none';

                if(!win) {
                     app.history.unshift({
                        id: Date.now(), date: new Date().toLocaleString(), type: 'Mines', 
                        selection: `${this.minesCount} мин`, amount: this.bet, coeff: 0, 
                        status: 'loss', winAmount: 0
                    });
                    app.saveData();
                }
            }
        };

        // --- DICE GAME ---
        const gameDice = {
            selectedType: null, // 'even' or 'odd'
            
            selectType: function(type) {
                this.selectedType = type;
                document.getElementById('dice-even').classList.toggle('active', type === 'even');
                document.getElementById('dice-odd').classList.toggle('active', type === 'odd');
            },

            roll: function() {
                const amount = parseFloat(document.getElementById('dice-bet').value);
                if(amount > app.balance) return alert('Недостаточно средств');
                if(!this.selectedType) return alert('Выберите Чет или Нечет');

                app.balance -= amount;
                app.saveData();

                const cube = document.getElementById('dice-cube');
                const result = Math.floor(Math.random() * 6) + 1; // 1-6
                
                // Rotation Logic
                // Map result to rotation degrees
                // 1: 0,0 | 2: 0,-90 | 3: 0,180 | 4: 0,90 | 5: -90,0 | 6: 90,0
                const rotations = {
                    1: [0, 0], 2: [0, -90], 3: [0, 180], 
                    4: [0, 90], 5: [-90, 0], 6: [90, 0]
                };
                
                // Add extra spins (360 * n) for animation effect
                const xRand = (Math.floor(Math.random() * 3) + 4) * 360; 
                const yRand = (Math.floor(Math.random() * 3) + 4) * 360;

                const targetX = rotations[result][0] + xRand;
                const targetY = rotations[result][1] + yRand;

                cube.style.transform = `rotateX(${targetX}deg) rotateY(${targetY}deg)`;

                // Wait for animation
                setTimeout(() => {
                    this.settle(result, amount);
                }, 1000);
            },

            settle: function(result, amount) {
                const isEven = result % 2 === 0;
                const won = (this.selectedType === 'even' && isEven) || (this.selectedType === 'odd' && !isEven);
                
                let winAmount = 0;
                if(won) {
                    winAmount = amount * 1.9;
                    app.balance += winAmount;
                    if(tg && tg.showAlert) tg.showAlert(`Выпало ${result}! Победа!`);
                } else {
                    if(tg && tg.showAlert) tg.showAlert(`Выпало ${result}. Попробуй еще раз.`);
                }

                app.history.unshift({
                    id: Date.now(), date: new Date().toLocaleString(), type: 'Dice', 
                    selection: this.selectedType === 'even' ? 'Чет' : 'Нечет', 
                    amount: amount, coeff: 1.9, 
                    status: won ? 'win' : 'loss', winAmount: winAmount
                });
                app.saveData();
            }
        };

        // Initialize App
        window.onload = () => app.init();

    </script>
</body>
</html>
