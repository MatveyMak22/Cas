<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Bet</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg:#0e1015; --card:#1c1f26; --prim:#00ff88; --text:#fff; --muted:#848d9a; --danger:#ff3b3b; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { margin:0; background:var(--bg); color:var(--text); font-family:sans-serif; padding-bottom:90px; padding-top:60px; user-select:none; }
        
        header { position:fixed; top:0; width:100%; height:60px; background:rgba(14,16,21,0.95); border-bottom:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:space-between; padding:0 16px; z-index:100; }
        .bal { background:rgba(255,255,255,0.05); padding:5px 12px; border-radius:20px; font-weight:700; border:1px solid rgba(255,255,255,0.1); }
        
        .page { display:none; padding:16px; animation:fade .3s; }
        .page.active { display:block; }
        @keyframes fade { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
        
        .card { background:var(--card); border-radius:16px; padding:15px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.05); }
        .btn { background:linear-gradient(135deg, #00ff88, #00b359); color:#000; border:none; width:100%; padding:14px; border-radius:12px; font-weight:800; font-size:16px; margin-top:10px; }
        .btn:active { transform:scale(0.98); opacity:0.9; }
        input, select { width:100%; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); padding:12px; border-radius:10px; color:#fff; font-size:16px; margin-bottom:10px; outline:none; }
        
        /* BOTTOM NAV */
        .nav { position:fixed; bottom:0; width:100%; height:80px; background:#15181e; border-top:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-around; padding-bottom:15px; z-index:100; }
        .nav-item { display:flex; flex-direction:column; justify-content:center; align-items:center; color:var(--muted); font-size:10px; width:25%; }
        .nav-item.active { color:var(--prim); }
        .nav-item i { font-size:20px; margin-bottom:4px; }

        /* MINES */
        .mines-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:6px; margin:15px 0; }
        .cell { aspect-ratio:1; background:rgba(255,255,255,0.05); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:20px; cursor:pointer; transition:.1s; }
        .cell.gem { background:rgba(0,255,136,0.15); border:1px solid var(--prim); }
        .cell.boom { background:rgba(255,59,59,0.15); border:1px solid var(--danger); }
        
        /* GAMES HUB */
        .games-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .g-card { background:var(--card); padding:20px; border-radius:16px; text-align:center; border:1px solid rgba(255,255,255,0.05); }
        
        /* SPORT TABS */
        .tabs { display:flex; gap:10px; overflow-x:auto; padding-bottom:5px; scrollbar-width:none; margin-bottom:15px; }
        .tab { background:rgba(255,255,255,0.05); padding:8px 16px; border-radius:20px; font-size:13px; white-space:nowrap; }
        .tab.active { background:var(--prim); color:#000; font-weight:700; }
        
        /* BACK BTN */
        .back { margin-bottom:15px; color:var(--muted); display:flex; align-items:center; gap:8px; font-size:14px; }
    </style>
</head>
<body>

    <header>
        <div style="font-weight:800;font-style:italic;font-size:20px">ROYAL<span style="color:var(--prim)">BET</span></div>
        <div class="bal"><span style="color:var(--prim)">‚ÇΩ</span> <span id="bal">...</span></div>
    </header>

    <!-- SPORT -->
    <div id="p-sport" class="page active">
        <div class="tabs">
            <div class="tab active" onclick="Sport.filter('football',this)">–§—É—Ç–±–æ–ª</div>
            <div class="tab" onclick="Sport.filter('hockey',this)">–•–æ–∫–∫–µ–π</div>
            <div class="tab" onclick="Sport.filter('tennis',this)">–¢–µ–Ω–Ω–∏—Å</div>
        </div>
        <div id="feed">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- GAMES HUB -->
    <div id="p-hub" class="page">
        <h2>–ò–≥—Ä—ã</h2>
        <div class="games-grid">
            <div class="g-card" onclick="Nav.to('mines')"><i class="fas fa-bomb" style="font-size:30px;color:var(--prim)"></i><br><br><b>Mines</b></div>
            <div class="g-card" onclick="Nav.to('crash')"><i class="fas fa-plane" style="font-size:30px;color:var(--prim)"></i><br><br><b>Crash</b></div>
            <div class="g-card" onclick="Nav.to('dice')"><i class="fas fa-dice" style="font-size:30px;color:var(--prim)"></i><br><br><b>Dice</b></div>
        </div>
    </div>

    <!-- GAME: MINES -->
    <div id="p-mines" class="page">
        <div class="back" onclick="Nav.to('hub')"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</div>
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h3>Mines</h3>
                <span id="m-kef" style="font-size:18px;font-weight:800;color:var(--prim)">x1.00</span>
            </div>
            
            <div class="mines-grid" id="m-grid"></div>
            
            <label style="font-size:12px;color:var(--muted)">–ö–æ–ª-–≤–æ –º–∏–Ω: <span id="m-count-val" style="color:#fff">3</span></label>
            <input type="range" id="m-count" min="3" max="24" value="3" oninput="document.getElementById('m-count-val').innerText=this.value">
            
            <input type="number" id="m-bet" value="100" placeholder="–°—Ç–∞–≤–∫–∞ (–º–∏–Ω 10—Ä)">
            <button class="btn" id="m-start" onclick="Mines.start()">–ò–ì–†–ê–¢–¨</button>
            <button class="btn" id="m-cash" style="display:none;background:#ffc107" onclick="Mines.cashout()">–ó–ê–ë–†–ê–¢–¨</button>
        </div>
    </div>

    <!-- GAME: CRASH -->
    <div id="p-crash" class="page">
        <div class="back" onclick="Nav.to('hub')"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</div>
        <div class="card">
            <div style="height:150px;display:flex;align-items:center;justify-content:center;background:#111;border-radius:10px;margin-bottom:15px">
                <span id="c-val" style="font-size:40px;font-weight:900">1.00x</span>
            </div>
            <input type="number" id="c-bet" value="100" placeholder="–°—Ç–∞–≤–∫–∞ (–º–∏–Ω 10—Ä)">
            <button class="btn" id="c-start" onclick="Crash.play()">–°–¢–ê–†–¢</button>
            <button class="btn" id="c-cash" style="display:none;background:#ffc107" onclick="Crash.cashout()">–ó–ê–ë–†–ê–¢–¨</button>
        </div>
    </div>

    <!-- GAME: DICE -->
    <div id="p-dice" class="page">
        <div class="back" onclick="Nav.to('hub')"><i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥</div>
        <div class="card">
            <div style="text-align:center;font-size:50px;margin:20px" id="d-res">üé≤</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
                <button class="btn" onclick="Dice.roll('odd')" style="margin:0;background:#333">–ù–ï–ß–ï–¢ (x1.9)</button>
                <button class="btn" onclick="Dice.roll('even')" style="margin:0;background:#333">–ß–ï–¢ (x1.9)</button>
            </div>
            <input type="number" id="d-bet" value="100">
        </div>
    </div>

    <!-- BETS -->
    <div id="p-bets" class="page">
        <h3>–ú–æ–∏ —Å—Ç–∞–≤–∫–∏</h3>
        <div id="bets-list"></div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="Nav.go('sport',this)"><i class="fas fa-trophy"></i>–°–ø–æ—Ä—Ç</div>
        <div class="nav-item" onclick="Nav.go('hub',this)"><i class="fas fa-gamepad"></i>–ò–≥—Ä—ã</div>
        <div class="nav-item" onclick="Nav.go('bets',this)"><i class="fas fa-ticket-alt"></i>–°—Ç–∞–≤–∫–∏</div>
    </nav>

    <script>
        const API = "https://backend-4jag.onrender.com"; // –£–ö–ê–ñ–ò –°–í–û–ô URL
        const tg = window.Telegram.WebApp;
        let user = {id: tg.initDataUnsafe?.user?.id || 12345, username: "User"};
        let state = {bal:0, matches:[]};

        const App = {
            init: async () => {
                tg.expand();
                setInterval(App.poll, 5000);
                App.poll();
                Mines.initGrid();
            },
            poll: async () => {
                try {
                    let r = await fetch(`${API}/api/init?tg_id=${user.id}&username=${user.username}`);
                    let d = await r.json();
                    state.bal = d.balance;
                    document.getElementById('bal').innerText = Math.floor(d.balance).toLocaleString();
                    
                    let mr = await fetch(`${API}/api/matches`);
                    state.matches = await mr.json();
                    if(document.getElementById('p-sport').classList.contains('active')) Sport.render();
                } catch(e){}
            },
            req: async (path, data) => {
                let r = await fetch(`${API}/api/${path}`, {
                    method:'POST', headers:{'Content-Type':'application/json','X-Telegram-ID':user.id},
                    body:JSON.stringify(data)
                });
                if(!r.ok) { let e=await r.json(); tg.showAlert(e.detail); throw e; }
                return await r.json();
            }
        };

        const Nav = {
            go: (p, el) => {
                document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                document.getElementById('p-'+p).classList.add('active');
                if(el) el.classList.add('active');
                if(p==='bets') Bets.load();
            },
            to: (p) => {
                document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
                document.getElementById('p-'+p).classList.add('active');
            }
        };

        const Sport = {
            cat: 'football',
            filter: (c, el) => {
                Sport.cat = c;
                document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
                el.classList.add('active');
                Sport.render();
            },
            render: () => {
                let list = state.matches.filter(m => m.sport === Sport.cat);
                let html = '';
                list.forEach(m => {
                    let isLive = m.status==='live';
                    html += `<div class="card">
                        <div style="font-size:12px;color:#aaa;margin-bottom:5px">${isLive?'üî¥ LIVE':new Date(m.start_time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                            <b>${m.team_home}</b> <span style="color:var(--prim)">${isLive?m.score_home+':'+m.score_away:'vs'}</span> <b>${m.team_away}</b>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px">
                            <button class="btn" style="margin:0;font-size:12px;background:#333" onclick="Sport.bet(${m.id},'home',${m.odds_home})">P1 ${m.odds_home}</button>
                            <button class="btn" style="margin:0;font-size:12px;background:#333" onclick="Sport.bet(${m.id},'draw',${m.odds_draw})">X ${m.odds_draw}</button>
                            <button class="btn" style="margin:0;font-size:12px;background:#333" onclick="Sport.bet(${m.id},'away',${m.odds_away})">P2 ${m.odds_away}</button>
                        </div>
                    </div>`;
                });
                document.getElementById('feed').innerHTML = html || '<div style="text-align:center;padding:20px;color:#555">–ù–µ—Ç –º–∞—Ç—á–µ–π</div>';
            },
            bet: async (mid, sel, k) => {
                let a = prompt("–°—Ç–∞–≤–∫–∞ (–º–∏–Ω 50—Ä):", 100);
                if(a) await App.req('bet', {match_id:mid, selection:sel, amount:parseFloat(a), coefficient:k});
                tg.showAlert("–°—Ç–∞–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!");
            }
        };

        const Mines = {
            active: false, grid: [], mines: 3, bets: 0, mult: 1.0, opened: 0,
            initGrid: () => {
                let h=''; for(let i=0;i<25;i++) h+=`<div class="cell" onclick="Mines.clk(${i},this)"></div>`;
                document.getElementById('m-grid').innerHTML = h;
            },
            start: async () => {
                let b = document.getElementById('m-bet').value;
                let cnt = parseInt(document.getElementById('m-count').value);
                // Validations
                if(b < 10) return tg.showAlert("–ú–∏–Ω. —Å—Ç–∞–≤–∫–∞ 10—Ä");
                if(b > state.bal) return tg.showAlert("–ú–∞–ª–æ –¥–µ–Ω–µ–≥");

                // Server deduction
                let res = await App.req('game', {game:'Mines Start', amount:-parseFloat(b), bet_amount:parseFloat(b)});
                state.bal = res.new_balance; document.getElementById('bal').innerText=state.bal;

                // Local Logic
                Mines.active = true; Mines.mines = cnt; Mines.bet = parseFloat(b); Mines.mult = 1.0; Mines.opened = 0;
                Mines.grid = Array(25).fill(0);
                let c=0; while(c<cnt){ let r=Math.floor(Math.random()*25); if(!Mines.grid[r]){Mines.grid[r]=1; c++}}
                
                Mines.initGrid();
                document.getElementById('m-start').style.display='none';
                document.getElementById('m-cash').style.display='block';
                document.getElementById('m-count').disabled=true;
                document.getElementById('m-kef').innerText = "x1.00";
            },
            clk: (i, el) => {
                if(!Mines.active || el.classList.contains('gem')) return;
                
                if(Mines.grid[i]) {
                    el.classList.add('boom'); el.innerText='üí£';
                    Mines.end(0);
                } else {
                    el.classList.add('gem'); el.innerText='üíé';
                    Mines.opened++;
                    // Math: (Total - Opened + 1) / (Total - Mines - Opened + 1) * 0.99
                    let safe = 25 - Mines.mines;
                    let remain = 25 - (Mines.opened - 1);
                    let remainSafe = safe - (Mines.opened - 1);
                    
                    let stepMult = remain / remainSafe;
                    Mines.mult *= stepMult; 
                    
                    document.getElementById('m-kef').innerText = "x" + Mines.mult.toFixed(2);
                }
            },
            cashout: async () => {
                let win = Math.floor(Mines.bet * Mines.mult);
                // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–∞ (bet —É–∂–µ —Å–ø–∏—Å–∞–Ω, –Ω–∞—á–∏—Å–ª—è–µ–º –ø–æ–ª–Ω—É—é —Å—É–º–º—É win)
                await App.req('game', {game:'Mines Win', amount:win, bet_amount:0});
                tg.showAlert("–í—ã–∏–≥—Ä—ã—à: " + win);
                Mines.end(win);
            },
            end: (w) => {
                Mines.active = false;
                document.getElementById('m-start').style.display='block';
                document.getElementById('m-cash').style.display='none';
                document.getElementById('m-count').disabled=false;
                // Show all mines
                let cells = document.querySelectorAll('.cell');
                Mines.grid.forEach((v,k)=>{ if(v) { cells[k].innerText='üí£'; if(!w) cells[k].classList.add('boom'); } });
            }
        };

        const Crash = {
            active: false,
            play: async () => {
                let b = document.getElementById('c-bet').value;
                let r = await App.req('crash/start', {bet:parseFloat(b)});
                if(r.status==='started') {
                    Crash.active = true;
                    document.getElementById('c-start').style.display='none';
                    document.getElementById('c-cash').style.display='block';
                    Crash.tick(1.00);
                }
            },
            tick: (v) => {
                if(!Crash.active) return;
                v += 0.01;
                document.getElementById('c-val').innerText = v.toFixed(2)+'x';
                if(v < 30) requestAnimationFrame(()=>Crash.tick(v)); // Sim logic
            },
            cashout: async () => {
                Crash.active = false;
                let m = parseFloat(document.getElementById('c-val').innerText);
                let r = await App.req('crash/cashout', {multiplier:m});
                if(r.status==='won') tg.showAlert("–ü–æ–±–µ–¥–∞: "+r.win);
                else { tg.showAlert("–ö—Ä–∞—à –Ω–∞ "+r.crash_point); document.getElementById('c-val').style.color='red'; }
                
                setTimeout(()=>{
                    document.getElementById('c-val').style.color='#fff';
                    document.getElementById('c-val').innerText='1.00x';
                    document.getElementById('c-start').style.display='block';
                    document.getElementById('c-cash').style.display='none';
                }, 2000);
            }
        };

        const Dice = {
            roll: async (type) => {
                let b = document.getElementById('d-bet').value;
                let r = Math.floor(Math.random()*6)+1;
                document.getElementById('d-res').innerText = r;
                let win = (type==='odd' && r%2!==0) || (type==='even' && r%2===0);
                let amt = win ? Math.floor(b*0.9) : -b;
                await App.req('game', {game:'Dice', amount:parseFloat(amt), bet_amount:parseFloat(b)});
                tg.showAlert(win?"–ü–æ–±–µ–¥–∞":"–ü—Ä–æ–∏–≥—Ä—ã—à");
            }
        };

        const Bets = {
            load: async () => {
                let r = await fetch(`${API}/api/history`, {headers:{'X-Telegram-ID':user.id}});
                let d = await r.json();
                let h = d.active.map(b=>`<div>${b.game_type} - ${b.amount}—Ä (–í –∏–≥—Ä–µ)</div>`).join('') +
                        d.history.map(b=>`<div style="color:${b.status==='won'?'#0f8':'#f44'}">${b.game_type} ${b.status==='won'?'+'+b.potential_win:'-'+b.amount}</div>`).join('');
                document.getElementById('bets-list').innerHTML = h || '–ü—É—Å—Ç–æ';
            }
        };

        window.onload = App.init;
    </script>
</body>
</html>
